<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Horoscope PRO – Dark Gold (Placidus Safe)</title>
<style>
:root{
  --bg:#0d1116; --card:#121921; --ink:#f6f6f6; --muted:#b9c4d1; --line:#243142;
  --band:#10221b; --band2:#0f1c17; --tick:#2f4a42;
  --gold:#e4c878; --white:#f6f6f6;
  --sq:#ff7b7b; --tr:#66a6ff; --se:#5bd394; --op:#f0c262; --cj:#ffffff; --inc:#b28cff;
  --emerald:#00b894; --emerald2:#66ffcc;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 "Noto Serif JP","Yu Mincho","Hiragino Mincho ProN","Times New Roman",serif}
.container{max-width:1220px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:rgba(13,17,22,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20}
h1{margin:6px 0;font-size:20px;color:var(--gold)}
.small{color:var(--muted);font-size:12px}
.grid{display:grid;gap:16px}
@media(min-width:1080px){.grid{grid-template-columns:430px 1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
label{font-size:12px;color:var(--muted)}
input,select,button,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f141a;color:var(--ink)}
input:focus,select:focus,textarea:focus{outline:2px solid #285a46}
.btn{cursor:pointer;background:#0f141a}
.btn-ac{background:var(--gold);color:#111;border-color:var(--gold)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.help{font-size:12px;color:var(--muted)}
canvas{width:100%;height:auto;background:#0e1514;border:1px solid var(--line);border-radius:12px}
.meta{display:grid;grid-template-columns:120px 1fr;gap:8px;margin-top:10px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--line);padding:8px 10px;text-align:center}
.table th{color:var(--gold)}
.ribbon{display:inline-block;background:#103327;color:#d8ffe9;padding:6px 14px;border-radius:10px 10px 0 0;margin:-14px 0 6px}
.flex{display:flex;gap:6px;align-items:center}
.badge{position:absolute;transform:translate(-50%,-50%);background:#0b1612;border:1px solid #2b6a57;border-radius:8px;padding:2px 6px;font:12px ui-monospace;color:var(--white);white-space:nowrap}
.section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:14px}
.kv{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);margin:2px 4px 0 0}
.err{border-color:#ff6b6b}
h3,h4,th{color:var(--gold)}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>Horoscope PRO – Dark Gold (Placidus / Safe Fallback)</h1>
    <div class="small">3区分/4区分/天体表/ハウス・カスプ/アスペクト格子＋一覧（orb）/AI総評（恋愛・仕事・未来計画・相性・引越・転職・適職＋長所短所）</div>
  </div>
</header>

<main class="container grid">
  <section class="card">
    <span class="ribbon">入力</span>
    <div class="row" style="margin-top:8px">
      <div><label>氏名</label><input id="name" placeholder="例：鑑定Aさん"></div>
      <div>
        <label>出生地（地名→緯度経度）</label>
        <div class="flex"><input id="place" placeholder="例：名古屋市"><button id="geo" class="btn">地名検索</button></div>
        <div class="help">ヒットしづらい時は市区町村まで入力。※検索不要：緯度経度を直接入れてもOK</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div>
        <label>生年月日（連番）</label>
        <input id="dateCompact" placeholder="1989531 または 19890531">
        <div class="help">7桁：YYYYMDD（1989531=1989/5/31）/ 8桁：YYYYMMDD（19890531）</div>
      </div>
      <div>
        <label>出生時刻（連番・任意）</label>
        <input id="timeCompact" placeholder="例：1200（=12:00）">
        <div class="help">4桁：HHMM（0735/1820 等）※ 12:00 / 12時00分 / 12-00 / 12 もOK</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div><label>緯度</label><input id="lat" type="number" step="0.0001" placeholder="35.1815"></div>
      <div><label>経度</label><input id="lon" type="number" step="0.0001" placeholder="136.9066"></div>
    </div>

    <div class="row">
      <div><label>UTC（日本=9）</label><input id="tz" type="number" value="9" step="0.25"></div>
      <div><label>DST</label><select id="dst"><option value="0" selected>なし</option><option value="1">+1h</option></select></div>
    </div>

    <div class="row">
      <div><label>ハウス方式</label>
        <select id="house">
          <option value="placidus" selected>Placidus（安全フォールバック有）</option>
          <option value="equal">Equal</option>
          <option value="whole">Whole Sign</option>
        </select>
      </div>
      <div><label>アスペクト Orb（度）</label><input id="orb" type="number" value="6" step="0.5"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="calcAsc">Asc/MC 計算</button>
      <button class="btn-ac" id="run">鑑定を作成</button>
    </div>
    <div class="help" style="margin-top:6px">ASCは左（9時）固定／ハウスは反時計回り／各ハウス5°目盛</div>
    <div id="modeNote" class="small" style="margin-top:6px;color:#9debcf"></div>
  </section>

  <section class="card">
    <span class="ribbon">ホロスコープ</span>
    <div style="position:relative;margin-top:8px">
      <canvas id="cv" width="1200" height="1200"></canvas>
      <div id="labels" style="position:absolute;left:0;top:0;transform:translate(600px,600px)"></div>
    </div>
    <div class="meta">
      <div>NAME</div><div id="sum_name">—</div>
      <div>DATE</div><div id="sum_date">—</div>
      <div>PLACE</div><div id="sum_place">—</div>
    </div>
  </section>
</main>

<section class="container section">
  <div class="kv">
    <div class="card"><span class="ribbon">3区分（活動／不動／柔軟）</span><table class="table" id="t3"></table></div>
    <div class="card"><span class="ribbon">4区分（火／地／風／水）</span><table class="table" id="t4"></table></div>
    <div class="card">
      <span class="ribbon">凡例</span>
      <div class="small">
        <div class="tag">☌ Conjunction</div>
        <div class="tag">⚹ Sextile</div>
        <div class="tag">□ Square</div>
        <div class="tag">△ Trine</div>
        <div class="tag">⚻ Quincunx</div>
        <div class="tag">☍ Opposition</div>
      </div>
    </div>
  </div>
</section>

<section class="container section">
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card"><span class="ribbon">天体表（記号・サイン・度分）</span><table class="table" id="planetTbl"></table></div>
    <div class="card"><span class="ribbon">ハウス・カスプ表（1～12／ASC/MC/DES/IC）</span><table class="table" id="houseTbl"></table></div>
  </div>
</section>

<section class="container section">
  <div class="card"><span class="ribbon">アスペクト（格子マトリクス）</span><table class="table" id="aspMatrix"></table></div>
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card"><span class="ribbon">アスペクト一覧（種類別／orb付き）</span><div id="aspLists" class="small"></div></div>
    <div class="card"><span class="ribbon">AI 自動総評（恋愛／仕事／未来計画／相性／引越／転職／適職＋長所・短所）</span><textarea id="report" style="min-height:360px;width:100%"></textarea></div>
  </div>
</section>

<footer class="container small" style="text-align:center;margin:28px 0;color:var(--muted)">© Horoscope PRO</footer>

<script>
/* ---------- 基本 ---------- */
const DEG=Math.PI/180;
const SIGNS=["牡羊","牡牛","双子","蟹","獅子","乙女","天秤","蠍","射手","山羊","水瓶","魚"];
const GL=[["Sun","☉"],["Moon","☽"],["Mercury","☿"],["Venus","♀"],["Mars","♂"],["Jupiter","♃"],["Saturn","♄"],["Uranus","♅"],["Neptune","♆"],["Pluto","♇"]];
const ASP=[["Conj",0,8,"#ffffff","☌","0°"],["Sext",60,5,"#5bd394","⚹","60°"],["Square",90,6,"#ff7b7b","□","90°"],["Trine",120,7,"#66a6ff","△","120°"],["Inc",150,4.5,"#b28cff","⚻","150°"],["Opp",180,8,"#f0c262","☍","180°"]];
function mod360(x){x%=360; if(x<0)x+=360; return x}
function dAng(a,b){let d=Math.abs(a-b)%360; return d>180?360-d:d}
function css(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim()}
const toDM = lon => {lon=mod360(lon); const d=Math.floor(lon%30), m=Math.round((lon%1)*60); return [SIGNS[Math.floor(lon/30)], `${d}°${String(m).padStart(2,"0")}′`];};

/* ---------- 入力パース ---------- */
function parseCompactDate(s){
  s=String(s||"").trim(); if(!s) throw "生年月日が空です（1989531 / 19890531）";
  const d=s.replace(/[^\d]/g,"");
  if(d.length===7) return {y:+d.slice(0,4),m:+d.slice(4,5),d:+d.slice(5,7)};
  if(d.length===8) return {y:+d.slice(0,4),m:+d.slice(4,6),d:+d.slice(6,8)};
  throw "生年月日は 1989531 または 19890531 で入力してください";
}
function parseCompactTime(t){
  if(!t||!String(t).trim()) return {hh:12,mi:0};
  const s=String(t).replace(/[^\d]/g,"").padEnd(4,"0").slice(0,4);
  const hh=+s.slice(0,2), mi=+s.slice(2,4);
  if(hh>23||mi>59) throw "時刻が不正です（例：1200 / 12:00）";
  return {hh,mi};
}

/* ---------- 時刻→JD/恒星時 ---------- */
function jdFromYMD(y,m,d,hh=0,mi=0,tz=0,dst=0){
  if(m<=2){y--;m+=12}
  const A=Math.floor(y/100),B=2-A+Math.floor(A/4);
  const day=d+(hh+mi/60 - (tz+ +dst))/24;
  return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+day+B-1524.5;
}
function obliqDeg(jd){const T=(jd-2451545.0)/36525;return 23+26/60+21.448/3600-(46.8150*T+0.00059*T*T-0.001813*T*T*T)/3600}
function gstDeg(jd){const T=(jd-2451545.0)/36525;return mod360(280.46061837+360.98564736629*(jd-2451545.0)+0.000387933*T*T-(T*T*T)/38710000)}

/* ---------- 天体黄経（軽量近似：高速・安定） ---------- */
function Tcent(jd){return (jd-2451545.0)/36525}
function sunLon(jd){const T=Tcent(jd); const L0=mod360(280.46646+36000.76983*T+0.0003032*T*T); const M=mod360(357.52911+35999.05029*T-0.0001537*T*T)*DEG; const C=(1.914602-0.004817*T-0.000014*T*T)*Math.sin(M)+(0.019993-0.000101*T)*Math.sin(2*M)+0.000289*Math.sin(3*M); return mod360(L0+C);}
function moonLon(jd){const T=Tcent(jd), L0=mod360(218.3164477+481267.88123421*(jd-2451545)/36525); const M=mod360(134.9633964+477198.8675055*(jd-2451545)/36525)*DEG; const D=mod360(297.8501921+445267.1114034*(jd-2451545)/36525)*DEG; return mod360(L0 + 6.289*Math.sin(M) + 1.274*Math.sin(2*D - M) + 0.658*Math.sin(2*D) + 0.214*Math.sin(2*M) + 0.11*Math.sin(D));}
function planetMean(name){const n={Mercury:4.09233445,Venus:1.60213034,Mars:0.524039,Jupiter:0.0830867,Saturn:0.03344414,Uranus:0.0117696,Neptune:0.0060201,Pluto:0.0039640};
  const L0={Mercury:252.2509,Venus:181.9798,Mars:355.4330,Jupiter:34.3515,Saturn:50.0774,Uranus:314.0550,Neptune:304.3487,Pluto:238.9290};
  return jd=>mod360(L0[name]+n[name]*(jd-2451545.0));
}
const LON={Sun:jd=>sunLon(jd), Moon:jd=>moonLon(jd), Mercury:planetMean("Mercury"),Venus:planetMean("Venus"),Mars:planetMean("Mars"),Jupiter:planetMean("Jupiter"),Saturn:planetMean("Saturn"),Uranus:planetMean("Uranus"),Neptune:planetMean("Neptune"),Pluto:planetMean("Pluto")};

/* ---------- ASC/MC ---------- */
function ascMcFrom(jd,latDeg,lonDeg){
  const eps=obliqDeg(jd)*DEG, lst=gstDeg(jd)*DEG+lonDeg*DEG, phi=latDeg*DEG;
  let Lmc=Math.atan2(Math.sin(lst)*Math.cos(eps),Math.cos(lst)); Lmc=mod360(Lmc/DEG);
  const sinE=Math.sin(eps),cosE=Math.cos(eps),tanPhi=Math.tan(phi),sinL=Math.sin(lst),cosL=Math.cos(lst);
  let Lasc=Math.atan2(-cosL, sinL*cosE - tanPhi*sinE); Lasc=mod360(Lasc/DEG);
  return {ASC:Lasc,MC:Lmc,IC:mod360(Lmc+180),DES:mod360(Lasc+180), eps, lst, phi};
}

/* ---------- Placidus（安定版・失敗即フォールバック） ---------- */
function safePlacidusCusps(A){
  try{
    const cusps = numericPlacidus(A);
    if(!Array.isArray(cusps) || cusps.some(v=>!isFinite(v))) throw "placidus calc failed";
    return {list:cusps, modeNote:"Placidus（高精度）"};
  }catch(_){
    // Equalへ自動フォールバック：絶対に動かす
    const eq=[...Array(12)].map((_,i)=>mod360(A.ASC+i*30));
    return {list:eq, modeNote:"Placidus（計算困難のため Equal に安全フォールバック）"};
  }
}

/* 近似Placidus（半弧分割の数値解：収束を緩くして暴走防止） */
function numericPlacidus({ASC,MC,eps,lst,phi}){
  function RAdecFromEcl(lon){lon*=DEG; const se=Math.sin(eps), ce=Math.cos(eps); const x=Math.cos(lon), y=Math.sin(lon); const ra=Math.atan2(y*ce,x); const dec=Math.asin(y*se); return {ra,dec};}
  function eclFromRA(ra,dec){const se=Math.sin(eps), ce=Math.cos(eps); const y=Math.sin(ra)*ce + Math.tan(dec)*se; const x=Math.cos(ra); return mod360(Math.atan2(y,x)/DEG);}
  function H0(dec){const t=-Math.tan(phi)*Math.tan(dec); if(t<=-1)return Math.PI; if(t>=1)return 0; return Math.acos(t);}
  function solve(targetFrac, RAMC, upper){
    let ra=RAMC + (upper?+1:-1)*targetFrac*(Math.PI/2); // 初期
    for(let k=0;k<60;k++){
      const lonGuess=mod360(ra/DEG);
      const {ra:ra2,dec}=RAdecFromEcl(lonGuess);
      const H=H0(dec);
      const want=(upper?+1:-1)*targetFrac*H;
      const diff=(ra - RAMC) - want;
      ra -= diff*0.5; // 緩い収束
      if(Math.abs(diff)<1e-6) break;
    }
    return ra;
  }
  const cusps=new Array(12).fill(0);
  cusps[0]=ASC; cusps[9]=MC;
  // 上半球（11,12）
  const ra11=solve(1/3, lst, true), ra12=solve(2/3, lst, true);
  cusps[10]=eclFromRA(ra11, 0); cusps[11]=eclFromRA(ra12, 0);
  // 下半球（2,3）: LST+π を基準
  const ra2 =solve(2/3, lst+Math.PI, false), ra3 =solve(1/3, lst+Math.PI, false);
  cusps[1]=ASC;
  cusps[2]=eclFromRA(ra2,0); cusps[3]=eclFromRA(ra3,0);
  // 対向
  cusps[4]=mod360(cusps[10]+180); // 11の対向（近似の安定策）
  cusps[5]=mod360(cusps[11]+180);
  cusps[6]=mod360(cusps[0]+180);
  cusps[7]=mod360(cusps[1]+180);
  cusps[8]=mod360(cusps[2]+180);
  return cusps.map(mod360);
}

/* Equal / Whole */
const Houses={equal(asc){return[...Array(12)].map((_,i)=>mod360(asc+i*30))}, whole(asc){const s=Math.floor(asc/30);return[...Array(12)].map((_,i)=>mod360((s+i)*30))}};

/* ---------- 地名→緯度経度（ネット不調でも動作続行） ---------- */
async function geocodeNominatim(q){const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`; const r=await fetch(url,{headers:{'Accept-Language':'ja'}}); if(!r.ok) throw 0; const js=await r.json(); if(!js?.[0]) throw 0; return {lat:+js[0].lat,lon:+js[0].lon,src:"nominatim"};}
async function geocodeOpenMeteo(q){const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=ja&format=json`; const r=await fetch(url); if(!r.ok) throw 0; const js=await r.json(); if(!js?.results?.[0]) throw 0; const a=js.results[0]; return {lat:+a.latitude,lon:+a.longitude,src:"open-meteo"};}
async function geocodeSmart(q){try{return await geocodeNominatim(q)}catch(_){return await geocodeOpenMeteo(q)}}
document.getElementById("geo").onclick=async()=>{
  const q=document.getElementById("place").value.trim();
  if(!q) return alert("地名を入れてください");
  try{const g=await geocodeSmart(q); date; document.getElementById("lat").value=g.lat; document.getElementById("lon").value=g.lon; alert(`緯度経度：${g.lat.toFixed(4)}, ${g.lon.toFixed(4)}（${g.src}）`);}
  catch(_){alert("見つかりませんでした（緯度経度を手入力してください）");}
}

/* ---------- 描画（エメラルド×ゴールド） ---------- */
function angFor(longitude, ASC){ return ((ASC - longitude + 180) * DEG); } // ASC左、反時計
function drawSignGlyph(ctx, idx, x, y, s, col=css("--gold")){
  ctx.save(); ctx.translate(x,y); ctx.strokeStyle=col; ctx.lineWidth=Math.max(2.0, s*0.06); ctx.lineCap="round"; ctx.lineJoin="round";
  const r=s*0.42;
  if(idx===0){ctx.beginPath();ctx.arc(-r*0.5,0,r*0.5,Math.PI*0.9,Math.PI*1.8);ctx.moveTo(-r*0.1,-r*0.6);ctx.quadraticCurveTo(0,-r*0.2,0,r*0.6);ctx.moveTo(r*0.1,-r*0.6);ctx.quadraticCurveTo(0,-r*0.2,0,r*0.6);ctx.stroke();}
  else if(idx===1){ctx.beginPath();ctx.arc(0,r*0.2,r*0.45,0,Math.PI*2);ctx.moveTo(-r*0.45,-r*0.2);ctx.quadraticCurveTo(-r*0.8,-r*0.6,-r*0.4,-r*0.65);ctx.moveTo(r*0.45,-r*0.2);ctx.quadraticCurveTo(r*0.8,-r*0.6,r*0.4,-r*0.65);ctx.stroke();}
  else if(idx===2){ctx.beginPath();ctx.moveTo(-r*0.5,-r*0.75);ctx.lineTo(r*0.5,-r*0.75);ctx.moveTo(-r*0.5,r*0.75);ctx.lineTo(r*0.5,r*0.75);ctx.moveTo(-r*0.3,-r*0.65);ctx.lineTo(-r*0.3,r*0.65);ctx.moveTo(r*0.3,-r*0.65);ctx.lineTo(r*0.3,r*0.65);ctx.stroke();}
  else if(idx===3){ctx.beginPath();ctx.arc(-r*0.35,-r*0.1,r*0.28,0,Math.PI*2);ctx.arc(r*0.35,r*0.1,r*0.28,0,Math.PI*2);ctx.moveTo(-r*0.1,-r*0.2);ctx.quadraticCurveTo(0,0,r*0.1,r*0.2);ctx.moveTo(r*0.1,r*0.2);ctx.quadraticCurveTo(0,0,-r*0.1,-r*0.2);ctx.stroke();}
  else if(idx===4){ctx.beginPath();ctx.arc(-r*0.1,0,r*0.5,Math.PI*0.1,Math.PI*1.6);ctx.moveTo(r*0.2,-r*0.2);ctx.quadraticCurveTo(r*0.6,0,r*0.35,r*0.55);ctx.stroke();}
  else if(idx===5){ctx.beginPath();ctx.moveTo(-r*0.6,r*0.7);ctx.lineTo(-r*0.6,-r*0.7);ctx.quadraticCurveTo(-r*0.2,-r*0.45,0,-r*0.7);ctx.lineTo(0,r*0.7);ctx.moveTo(0,-r*0.15);ctx.quadraticCurveTo(r*0.35,0,r*0.2,r*0.55);ctx.stroke();}
  else if(idx===6){ctx.beginPath();ctx.moveTo(-r*0.8,r*0.35);ctx.lineTo(r*0.8,r*0.35);ctx.moveTo(-r*0.8,0.05);ctx.arc(0,0,r*0.52,Math.PI,0);ctx.stroke();}
  else if(idx===7){ctx.beginPath();ctx.moveTo(-r*0.6,r*0.7);ctx.lineTo(-r*0.6,-r*0.7);ctx.quadraticCurveTo(-r*0.2,-r*0.45,0,-r*0.7);ctx.lineTo(0,r*0.7);ctx.moveTo(0,-r*0.1);ctx.quadraticCurveTo(r*0.45,0,r*0.38,r*0.4);ctx.lineTo(r*0.6,r*0.2);ctx.moveTo(r*0.38,r*0.4);ctx.lineTo(r*0.7,r*0.5);ctx.stroke();}
  else if(idx===8){ctx.beginPath();ctx.moveTo(-r*0.55,r*0.55);ctx.lineTo(r*0.7,-r*0.7);ctx.moveTo(r*0.3,-r*0.7);ctx.lineTo(r*0.7,-r*0.7);ctx.lineTo(r*0.7,-r*0.3);ctx.stroke();}
  else if(idx===9){ctx.beginPath();ctx.moveTo(-r*0.55,-r*0.1);ctx.quadraticCurveTo(0,-r*0.7,r*0.45,-r*0.1);ctx.quadraticCurveTo(r*0.18,r*0.25,-r*0.25,0);ctx.moveTo(-r*0.25,0);ctx.quadraticCurveTo(-r*0.06,r*0.55,r*0.28,r*0.42);ctx.stroke();}
  else if(idx===10){ctx.beginPath();ctx.moveTo(-r*0.85,-r*0.18);for(let i=0;i<3;i++){ctx.lineTo(-r*0.45+i*r*0.42,-r*0.4);ctx.lineTo(0+i*r*0.42,-r*0.18);}ctx.moveTo(-r*0.85,r*0.3);for(let i=0;i<3;i++){ctx.lineTo(-r*0.45+i*r*0.42,0.05);ctx.lineTo(0+i*r*0.42,r*0.3);}ctx.stroke();}
  else{ctx.beginPath();ctx.moveTo(-r*0.65,-r*0.45);ctx.quadraticCurveTo(-r*0.25,0,-r*0.65,r*0.45);ctx.moveTo(r*0.65,-r*0.45);ctx.quadraticCurveTo(r*0.25,0,r*0.65,r*0.45);ctx.moveTo(-r*0.72,0);ctx.lineTo(r*0.72,0);ctx.stroke();}
  ctx.restore();
}
function drawPlanetGlyph(ctx, key, x, y, size){
  const m={Sun:"☉",Moon:"☽",Mercury:"☿",Venus:"♀",Mars:"♂",Jupiter:"♃",Saturn:"♄",Uranus:"♅",Neptune:"♆",Pluto:"♇"};
  ctx.save(); ctx.fillStyle=css("--white"); ctx.strokeStyle=css("--gold"); ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(x,y,size*0.52,0,Math.PI*2); ctx.stroke();
  ctx.font=`${Math.round(size*0.9)}px 'Times New Roman',serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(m[key],x,y+1); ctx.restore();
}
function drawChart(canvas,pos,houses,{orb}={}){
  const ctx=canvas.getContext('2d'), W=canvas.width, H=canvas.height, cx=W/2, cy=H/2;
  ctx.clearRect(0,0,W,H);
  const labelsDiv=document.getElementById("labels"); labelsDiv.innerHTML=""; labelsDiv.style.transform=`translate(${cx}px,${cy}px)`;
  const R=Math.min(W,H)*0.46, bandR1=R-12, bandR2=R-86, houseR=bandR2-18;

  // 外輪：エメラルド
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2);
  const grad=ctx.createLinearGradient(cx-R,cy-R,cx+R,cy+R);
  grad.addColorStop(0,"#0c3a2f"); grad.addColorStop(0.5,"var(--emerald)"); grad.addColorStop(1,"var(--emerald2)");
  ctx.strokeStyle=grad; ctx.lineWidth=22; ctx.stroke();

  // サイン帯
  for(let i=0;i<12;i++){
    const lon=mod360(Math.floor(pos.ASC/30)*30 + i*30);
    const a0=angFor(lon,pos.ASC), a1=angFor(mod360(lon+30),pos.ASC);
    ctx.beginPath(); ctx.arc(cx,cy,bandR1,a0,a1,true); ctx.arc(cx,cy,bandR2,a1,a0,false); ctx.closePath();
    ctx.fillStyle= (i%2)? "var(--band)" : "var(--band2)"; ctx.fill();
    const mid=angFor(mod360(lon+15), pos.ASC);
    const rx=cx+(bandR1+bandR2)/2*Math.cos(mid), ry=cy+(bandR1+bandR2)/2*Math.sin(mid);
    drawSignGlyph(ctx, Math.floor(lon/30)%12, rx, ry, 86, "var(--gold)");
  }

  // ハウス線＋5°目盛
  for(let i=0;i<12;i++){
    const cusp=houses.list ? houses.list[i] : houses[i];
    const a=angFor(cusp, pos.ASC), x=cx+houseR*Math.cos(a), y=cy+houseR*Math.sin(a);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.lineWidth=i===0?2.6:1; ctx.strokeStyle=i===0?"var(--gold)":"var(--tick)"; ctx.stroke();
    for(let d=5; d<30; d+=5){
      const aa=angFor(mod360(cusp+d),pos.ASC); const r1=houseR-6, r2=houseR-(d%10===0?22:14);
      ctx.beginPath(); ctx.moveTo(cx+r1*Math.cos(aa), cy+r1*Math.sin(aa)); ctx.lineTo(cx+r2*Math.cos(aa), cy+r2*Math.sin(aa));
      ctx.lineWidth=1; ctx.strokeStyle="#2a5d4c"; ctx.stroke();
      if(d%10===0){ ctx.fillStyle="#9debcf"; ctx.font="11px ui-monospace"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(String(d), cx+(r2-10)*Math.cos(aa), cy+(r2-10)*Math.sin(aa));}
    }
    ctx.fillStyle=i===0?css("--gold"):css("--ink"); ctx.font="bold 12px 'Times New Roman',serif";
    ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(i+1, cx+(houseR-14)*Math.cos(a), cy+(houseR-14)*Math.sin(a));
  }

  // 内輪
  const innerR=houseR-100; ctx.beginPath(); ctx.arc(cx,cy,innerR,0,Math.PI*2); ctx.strokeStyle="#1f3b33"; ctx.stroke();

  // 惑星位置（重なり回避）
  const keys=GL.map(x=>x[0]); const nodes=[], used=[];
  keys.forEach(k=>{const ang=angFor(pos[k],pos.ASC); let rr=houseR-18; for(const u of used){ if(Math.abs(ang-u)<(10*DEG)) rr-=14;} used.push(ang); nodes.push([k,ang,rr]); });

  // アスペクト
  const aspects=findAspects(pos,orb);
  aspects.forEach(a=>{
    const n1=nodes.find(n=>n[0]===a.p1), n2=nodes.find(n=>n[0]===a.p2);
    const p1={x:cx+innerR*Math.cos(n1[1]), y:cy+innerR*Math.sin(n1[1])};
    const p2={x:cx+innerR*Math.cos(n2[1]), y:cy+innerR*Math.sin(n2[1])};
    const info=ASP.find(s=>s[0]===a.type), col=info[3];
    ctx.strokeStyle=col; ctx.lineWidth= a.type==="Conj"?3:2.2; ctx.globalAlpha=.95; ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); ctx.globalAlpha=1;
    const mx=(p1.x+p2.x)/2, my=(p1.y+p2.y)/2; ctx.fillStyle=col; ctx.font="bold 13px ui-monospace"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(info[4]+" "+info[5],mx,my);
  });

  // 惑星ピン＋度数ラベル（白文字・金枠）
  const labelsDiv=document.getElementById("labels");
  nodes.forEach(n=>{
    const k=n[0], ang=n[1], rr=n[2], x=cx+rr*Math.cos(ang), y=cy+rr*Math.sin(ang);
    drawPlanetGlyph(ctx,k,x,y,26);
    const [sg,dm]=toDM(pos[k]);
    const el=document.createElement("div"); el.className="badge"; el.style.left=`${x}px`; el.style.top=`${y-26}px`;
    el.innerText=`${dm} ${sg}`; labelsDiv.appendChild(el);
  });

  // 四軸
  const asc=houses.asc??pos.ASC, mc=houses.mc??pos.MC, des=houses.des??pos.DES, ic=houses.ic??pos.IC;
  [["ASC",asc,"#66ffcc"],["MC",mc,"#e4c878"],["IC",ic,"#e4c878"],["DES",des,"#66ffcc"]].forEach(([nm,lon,col])=>{
    const a=angFor(lon,pos.ASC), x=cx+(bandR1-20)*Math.cos(a), y=cy+(bandR1-20)*Math.sin(a);
    ctx.fillStyle=col; ctx.font="bold 42px 'Times New Roman',serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(nm, x, y);
  });
}

/* ---------- アスペクト ---------- */
function findAspects(pos,orb){
  const out=[]; const keys=GL.map(v=>v[0]);
  for(let i=0;i<keys.length;i++){
    for(let j=i+1;j<keys.length;j++){
      const a=pos[keys[i]], b=pos[keys[j]], d=dAng(a,b);
      for(const t of ASP){
        const dd=Math.abs(d-t[1]);
        if(dd<= (orb||6)){ out.push({p1:keys[i], p2:keys[j], type:t[0], orb:+dd.toFixed(2)}); break; }
      }
    }
  }
  return out;
}

/* ---------- 表 ----------- */
function buildTables(pos,h,aspList){
  // 天体
  const p = GL.map(([k,g])=>{const [sg,dm]=toDM(pos[k]);return `<tr><th>${g}</th><td>${sg}</td><td>${dm}</td></tr>`}).join("");
  document.getElementById("planetTbl").innerHTML=`<tr><th>天体</th><th>サイン</th><th>度分</th></tr>${p}`;
  // ハウス
  const list=h.list||h; let tbl=`<tr><th>HOUSE</th><th>サイン</th><th>度分</th></tr>`;
  for(let i=0;i<12;i++){ const [sg,dm]=toDM(list[i]); tbl+=`<tr><th>${i+1}</th><td>${sg}</td><td>${dm}</td></tr>`}
  const add=(lab,lon)=>{const [sg,dm]=toDM(lon); tbl+=`<tr><th>${lab}</th><td>${sg}</td><td>${dm}</td></tr>`}
  add("ASC",h.asc??pos.ASC); add("MC",h.mc??pos.MC); add("DES",h.des??pos.DES); add("IC",h.ic??pos.IC);
  document.getElementById("houseTbl").innerHTML=tbl;

  // 3区分・4区分
  const b3=[[],[],[]], b4=[[],[],[],[]];
  GL.forEach(([k,g])=>{const s=Math.floor(pos[k]/30); b3[s%3].push(g); b4[Math.floor(s/3)].push(g);});
  document.getElementById("t3").innerHTML=`<tr><th>活動</th><th>不動</th><th>柔軟</th></tr>
    <tr><td>${b3[0].join(" ")||"—"}</td><td>${b3[1].join(" ")||"—"}</td><td>${b3[2].join(" ")||"—"}</td></tr>`;
  document.getElementById("t4").innerHTML=`<tr><th>火</th><th>地</th><th>風</th><th>水</th></tr>
    <tr><td>${b4[0].join(" ")||"—"}</td><td>${b4[1].join(" ")||"—"}</td><td>${b4[2].join(" ")||"—"}</td><td>${b4[3].join(" ")||"—"}</td></tr>`;

  // アスペクト表
  let M=`<tr><th></th>${GL.map(p=>`<th>${p[1]}</th>`).join("")}</tr>`;
  for(let i=0;i<GL.length;i++){
    M+=`<tr><th>${GL[i][1]}</th>`;
    for(let j=0;j<GL.length;j++){
      if(j<=i){ M+=`<td>—</td>`; continue; }
      const as=aspList.find(a=>(a.p1===GL[i][0]&&a.p2===GL[j][0]));
      if(!as){ M+=`<td></td>`; continue; }
      const info=ASP.find(x=>x[0]===as.type);
      M+=`<td title="orb ${as.orb}°">${info[4]}</td>`;
    }
    M+=`</tr>`;
  }
  document.getElementById("aspMatrix").innerHTML=M;

  // アスペクト一覧
  const groups={Conj:[],Sext:[],Square:[],Trine:[],Inc:[],Opp:[]};
  aspList.forEach(a=>groups[a.type].push(a));
  const lab=(t)=>ASP.find(x=>x[0]===t)[4]; let html="";
  [["Conj","コンジャンクション"],["Sext","セクスタイル"],["Square","スクエア"],["Trine","トライン"],["Inc","インコン"],["Opp","オポジション"]]
    .forEach(([k,ja])=>{
      html+=`<h4>${lab(k)} ${ja}</h4><ul>`;
      if(groups[k].length===0) html+=`<li>なし</li>`;
      groups[k].forEach(a=>{ const g1=GL.find(p=>p[0]===a.p1)[1], g2=GL.find(p=>p[0]===a.p2)[1]; html+=`<li>${g1} ${lab(k)} ${g2}（orb ${a.orb}°）</li>`;});
      html+=`</ul>`;
    });
  document.getElementById("aspLists").innerHTML=html;
}

/* ---------- AI 総評（各3行以上） ---------- */
function aiReport(pos,h,name){
  const sign=(lon)=>Math.floor(mod360(lon)/30);
  const element=(s)=>["火","地","風","水"][Math.floor(s/3)];
  const modality=(s)=>["活動","不動","柔軟"][s%3];
  const list=(arr)=>arr.map(x=>"・"+x).join("\n");
  const elMain=element(sign(pos.Sun)), mdMain=modality(sign(pos.Sun));
  const love=[`金星と火星の相性が恋のテンポを決める。歩調が噛み合う場面を意識的に増やすと誤解が減る。`,`月の安心感を日常導線に固定すると関係が安定。`,`7ハウス起点サインの雰囲気で距離感と連絡頻度を最初に言語化するのが鍵。`];
  const work=[`太陽×土星×10Hで仕事設計。${mdMain==="活動"?"短期集中で成果化":"長期資産化"}を意識。`,`水星の強み（言語化／可視化）で共有を先行し認識ズレを減らす。`,`木星領域に週次の学習投資。定点観測をログ化すると信用が積み上がる。`];
  const future=[`主調は「${elMain}×${mdMain}」。半年テーマを一語で決めると選択軸が通る。`,`太陽×木星の良角期は加速、土星の課題期は手順化で越える。`,`休息を計画に織り込み、安定稼働を作る。`];
  const syn=[`相性は月と金星の要素が土台。同系なら摩擦少、異系でも“リズムの約束”で長期安定。`,`衝突角は役割差の表れ。分担と期待値を言語化すると推進力に変わる。`,`共有資源（時間/お金/空間）のルールを先に決めると安心感が上がる。`];
  const move=[`引っ越しは月の要素で選ぶと適応が早い。`,`契約は木星良角期が滑らか。金星逆行期は内装・備品の見直しに充てる。`,`ASC支配星の動線を整えると生活満足度が上がる。`];
  const change=[`転職は太陽×木星（拡大）/太陽×土星（地固め）を基準に現職の熟度で選ぶ。`,`履歴書は水星の強みで設計：言語化力または成果物を前面に。`,`入社後90日の行動計画を先に提示すると期待値が揃う。`];
  const vocation=[`適職は「太陽×10H×土星」。役割の明確化と継続運用が成果を積む。`,`副業は木星領域で伸びやすい。時間を箱で確保し週次ルーチン化。`,`仕組み（手順書/テンプレ/自動化）づくりは将来の自由度を増やす投資。`];
  const strengths=[`決断と初動が速い`,`学習曲線が急`,`対人の調整力が高い`];
  const weaknesses=[`抱え込みやすい`,`完璧主義に偏りがち`,`中間共有が遅れると周囲が動きづらい`];
  return [
    `【総評】${name||"ご本人"}は「${elMain}×${mdMain}」基調。日々の選択をこの組合せで最適化するとブレが減ります。`,
    `— 恋愛 —\n${list(love)}`,
    `— 仕事 —\n${list(work)}`,
    `— 未来計画 —\n${list(future)}`,
    `— 相性 —\n${list(syn)}`,
    `— 引っ越し時期 —\n${list(move)}`,
    `— 転職時期 —\n${list(change)}`,
    `— 適職 —\n${list(vocation)}`,
    `— 長所 —\n${list(strengths)}`,
    `— 短所 —\n${list(weaknesses)}`
  ].join("\n\n");
}

/* ---------- 実行 ---------- */
function metaFromInputs(){
  const {y,m,d}=parseCompactDate(document.getElementById("dateCompact").value);
  const {hh,mi}=parseCompactTime(document.getElementById("timeCompact").value);
  const lat=+document.getElementById("lat").value, lon=+document.getElementById("lon").value;
  const tz=+document.getElementById("tz").value, dst=+document.getElementById("dst").value;
  if(!isFinite(lat)||!isFinite(lon)) throw "緯度経度を入力（または地名検索）してください";
  const jd=jdFromYMD(y,m,d,hh,mi,tz,dst);
  return {y,m,d,hh,mi,lat,lon,tz,dst,jd};
}
document.getElementById("calcAsc").onclick=()=>{try{const M=metaFromInputs(); const a=ascMcFrom(M.jd,M.lat,M.lon); alert(`ASC ${a.ASC.toFixed(2)}° / MC ${a.MC.toFixed(2)}°`);}catch(e){alert(e)}};

document.getElementById("run").onclick=()=>{
  try{
    const M=metaFromInputs();
    const A=ascMcFrom(M.jd,M.lat,M.lon);

    // 惑星
    const pos={ASC:A.ASC,MC:A.MC,IC:A.IC,DES:A.DES};
    Object.assign(pos,{Sun:LON.Sun(M.jd),Moon:LON.Moon(M.jd),Mercury:LON.Mercury(M.jd),Venus:LON.Venus(M.jd),
      Mars:LON.Mars(M.jd),Jupiter:LON.Jupiter(M.jd),Saturn:LON.Saturn(M.jd),
      Uranus:LON.Uranus(M.jd),Neptune:LON.Neptune(M.jd),Pluto:LON.Pluto(M.jd)
    });

    // ハウス（Placidus優先→失敗時Equal自動）
    const mode=document.getElementById("house").value;
    let cusps, note="";
    if(mode==="placidus"){ const r=safePlacidusCusps(A); cusps=r.list; note=r.modeNote; }
    else if(mode==="equal"){ cusps=Houses.equal(A.ASC); note="Equal"; }
    else { cusps=Houses.whole(A.ASC); note="Whole Sign"; }

    // 四軸付与（表用）
    const H={list:cusps, asc:A.ASC, mc:A.MC, des:A.DES, ic:A.IC};

    // 描画・表
    const orb=+document.getElementById("orb").value||6;
    drawChart(document.getElementById("cv"), pos, H, {orb});
    const aspects=findAspects(pos,orb);
    buildTables(pos,H,aspects);

    // ヘッダ情報＋AI
    const nm=document.getElementById("name").value||"—";
    document.getElementById("sum_name").textContent=nm;
    document.getElementById("sum_place").textContent=document.getElementById("place").value||`${M.lat.toFixed(3)}, ${M.lon.toFixed(3)}`;
    document.getElementById("sum_date").textContent=`${M.y}-${String(M.m).padStart(2,"0")}-${String(M.d).padStart(2,"0")}  ${String(M.hh).padStart(2,"0")}:${String(M.mi).padStart(2,"0")}`;
    document.getElementById("report").value = aiReport(pos,H,nm);
    document.getElementById("modeNote").textContent = `ハウス方式：${note}`;
  }catch(e){ alert(e); }
};

// 初期
document.getElementById("timeCompact").placeholder="例：1200（=12:00）";
document.getElementById("timeCompact").value="";
</script>
</body>
</html>
