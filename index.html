<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Horoscope Pro v3 — Light</title>
<style>
:root{
  --bg:#f6f2eb; --card:#ffffff; --ink:#2b2b2b; --muted:#6a6a6a; --ring:#e5e0d8; --accent:#2a4f9b;
  --zodiac:#0e2347; --ztext:#ffffff; --dial:#efe8da; --house:#cfc7b9; --grid:#d9d3ca;
  --good:#0a9b5a; --warn:#e57e00; --bad:#d84c4c;
  --asc:#2a4f9b; --mc:#9b2a70;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Yu Gothic",Arial}
header{position:sticky;top:0;background:rgba(246,242,235,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--ring)}
.wrap{max-width:1200px;margin:0 auto;padding:14px}
h1{margin:0 0 2px;font-size:20px}
.sub{color:var(--muted);font-size:12px}
.grid{display:grid;gap:12px}
@media(min-width:1100px){ .grid{grid-template-columns:420px 1fr} }
.card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:14px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
label{font-size:12px;color:var(--muted)}
input,select,textarea,button{
  width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--ring);
  background:#fff;color:var(--ink);
}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;border:1px solid var(--ring);background:#faf7f2;border-radius:6px;padding:2px 6px}
.pill{display:inline-block;padding:4px 8px;border:1px solid var(--ring);border-radius:999px;font-size:11px;color:var(--muted)}
.btn{cursor:pointer;background:#f3efe8}
.btn:hover{background:#ebe6de}
.btn-ac{background:#1f3f87;color:#fff;border-color:#1f3f87}
.small{font-size:12px;color:var(--muted)}
.table{width:100%;border-collapse:collapse;font-size:12px}
.table th,.table td{border-bottom:1px solid var(--ring);padding:6px 4px;text-align:left}
hr.sep{border:0;border-top:1px solid var(--ring);margin:12px 0}
canvas{width:100%;height:auto;background:var(--dial);border-radius:12px;border:1px solid var(--ring)}
.legend{display:flex;gap:8px;flex-wrap:wrap}
.legend span{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);padding:3px 8px;border-radius:999px;font-size:12px}
.color{width:10px;height:10px;border-radius:50%}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Horoscope Pro <span class="pill">v3</span></h1>
    <div class="sub">淡色テーマ / アスペクト線 / サビアン / ASC/MC自動 / AI鑑定（恋愛・仕事・未来・相性・引越し/転職/適職）</div>
  </div>
</header>

<main class="wrap grid">
  <!-- LEFT -->
  <section class="card">
    <h3 style="margin-top:0">個人チャート</h3>
    <div class="row">
      <div><label>氏名</label><input id="name" placeholder="例：Client-A"></div>
      <div><label>相談メモ</label><input id="memo" placeholder="例：恋愛/仕事/引越しなど"></div>
    </div>
    <div class="row">
      <div><label>生年月日</label><input id="date" type="date"></div>
      <div><label>出生時刻</label><input id="time" type="time" step="60"></div>
    </div>
    <div class="row">
      <div>
        <label>出生地（地名検索）</label>
        <div class="row" style="grid-template-columns:1fr auto">
          <input id="place" placeholder="例：愛知県名古屋市"><button class="btn" id="geobtn">検索</button>
        </div>
      </div>
      <div class="small">オンライン時は地名→緯度経度に自動変換。オフライン時は下に直接入力。</div>
    </div>
    <div class="row">
      <div><label>緯度</label><input id="lat" type="number" step="0.0001"></div>
      <div><label>経度</label><input id="lon" type="number" step="0.0001"></div>
    </div>
    <div class="row">
      <div><label>UTCオフセット（日本=9）</label><input id="tz" type="number" step="0.25" value="9"></div>
      <div><label>DST</label><select id="dst"><option value="0">なし</option><option value="1">+1h</option></select></div>
    </div>
    <hr class="sep">
    <div class="row">
      <div><label>ハウス</label><select id="house"><option value="whole">Whole Sign</option><option value="equal">Equal</option></select></div>
      <div><label>アスペクトOrb（度）</label><input id="orb" type="number" step="0.5" value="6"></div>
    </div>
    <div class="row">
      <div><label>外周ラベル</label><select id="outer"><option value="sign">サイン記号</option><option value="deg">度数目盛</option></select></div>
      <div><label>拡大（%）</label><input id="scale" type="number" value="100"></div>
    </div>

    <hr class="sep">
    <h4>天体位置（自動取得 or 手入力）</h4>
    <div class="small">※まずは <b>Asc/MC計算</b> → 自動取得（APIキー設定時）/ 手入力 → 描画 の順。</div>
    <table class="table" id="ptable"></table>

    <div class="legend" style="margin-top:10px">
      <span><i class="color" style="background:#d84c4c"></i>Square(90)</span>
      <span><i class="color" style="background:#2a4f9b"></i>Trine(120)</span>
      <span><i class="color" style="background:#0a9b5a"></i>Sextile(60)</span>
      <span><i class="color" style="background:#333"></i>Conj(0)</span>
      <span><i class="color" style="background:#8a5a0a"></i>Opp(180)</span>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="calc">Asc/MC 計算</button>
      <button class="btn" id="draw">描画</button>
      <button class="btn btn-ac" id="reportBtn">AI鑑定 生成</button>
    </div>

    <hr class="sep">
    <details>
      <summary>エフェメリス自動取得（任意・上級）</summary>
      <div class="small">
        <b>EphemerisAdapter</b> に外部APIを差し込めます（Swiss Ephemeris等）。<br>
        例：`window.EPHEM_ENDPOINT` と `window.EPHEM_TOKEN` を設定 → 「自動取得」ボタンを追加実行でOK。<br>
        セキュリティ上、公開サイトで秘匿したい場合はサーバー側のプロキシを推奨。
      </div>
    </details>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <div class="row" style="grid-template-columns:1fr auto">
      <h3 style="margin:0">チャート</h3>
      <div><span class="pill">アスペクト線</span><span class="pill">サビアン</span><span class="pill">PNG</span></div>
    </div>
    <canvas id="cv" width="1100" height="1100"></canvas>

    <h3 style="margin-top:12px">サマリー / アスペクト</h3>
    <div id="aspBox" class="small"></div>

    <h3 style="margin-top:12px">サビアン（☉☽ASC/MC）</h3>
    <div id="sabBox" class="small"></div>

    <h3 style="margin-top:12px">AI鑑定レポート（編集→コピペOK）</h3>
    <textarea id="report" rows="16" placeholder="ここに自動生成の鑑定が入ります"></textarea>
  </section>
</main>

<script>
/* ==== 基本データ ==== */
const DEG=Math.PI/180; const SIGNS=["牡羊","牡牛","双子","蟹","獅子","乙女","天秤","蠍","射手","山羊","水瓶","魚"];
const ZGLYPH=["\u2648","\u2649","\u264A","\u264B","\u264C","\u264D","\u264E","\u264F","\u2650","\u2651","\u2652","\u2653"];
const PLANETS=[["Sun","太陽","\u2609"],["Moon","月","\u263D"],["Mercury","水星","\u263F"],["Venus","金星","\u2640"],["Mars","火星","\u2642"],["Jupiter","木星","\u2643"],["Saturn","土星","\u2644"],["Uranus","天王星","\u2645"],["Neptune","海王星","\u2646"],["Pluto","冥王星","\u2647"],["ASC","ASC","ASC"],["MC","MC","MC"]];
const KEYS=PLANETS.map(p=>p[0]);
const ASP=[["Conj",0,8,"#333"],["Sext",60,5,"#0a9b5a"],["Square",90,6,"#d84c4c"],["Trine",120,7,"#2a4f9b"],["Opp",180,8,"#8a5a0a"]];

function mod360(x){x%=360;if(x<0)x+=360;return x}
function dAng(a,b){let d=Math.abs(a-b)%360; if(d>180)d=360-d; return d}

/* ==== 入出力 ==== */
function dmsToDeg(s){
  if(!s)return null; s=s.trim();
  if(/^[-+]?\d+(\.\d+)?$/.test(s)) return mod360(parseFloat(s));
  const m=s.match(/^([0-9]+(\.[0-9]+)?)\s*([^\d\s]+)$/);
  const sym={"♈":0,"♉":1,"♊":2,"♋":3,"♌":4,"♍":5,"♎":6,"♏":7,"♐":8,"♑":9,"♒":10,"♓":11,"♈︎":0,"♉︎":1,"♊︎":2,"♋︎":3,"♌︎":4,"♍︎":5,"♎︎":6,"♏︎":7,"♐︎":8,"♑︎":9,"♒︎":10,"♓︎":11};
  const kan={"牡羊":0,"牡牛":1,"双子":2,"蟹":3,"獅子":4,"乙女":5,"天秤":6,"蠍":7,"射手":8,"山羊":9,"水瓶":10,"魚":11};
  if(m){ const deg=parseFloat(m[1]); let idx=sym[m[3]]; if(idx==null&&kan[m[3]]!=null) idx=kan[m[3]]; if(idx==null) return null; return mod360(idx*30+deg) }
  return null;
}
function degToSignText(d){d=mod360(d); const s=Math.floor(d/30),a=d-s*30; return `${SIGNS[s]} ${a.toFixed(2)}°`;}

/* ==== 時刻/ASC/MC ==== */
function jdFromYMD(y,m,dd,hh=0,mi=0){if(m<=2){y-=1;m+=12}const A=Math.floor(y/100),B=2-A+Math.floor(A/4),day=dd+(hh+mi/60)/24;return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+day+B-1524.5;}
function gstDeg(jd){const T=(jd-2451545.0)/36525;return mod360(280.46061837+360.98564736629*(jd-2451545.0)+0.000387933*T*T-(T*T*T)/38710000)}
function obliqDeg(jd){const T=(jd-2451545.0)/36525;return 23+26/60+21.448/3600-(46.8150*T+0.00059*T*T-0.001813*T*T*T)/3600}
function ascMcFrom(jd,latDeg,lonDeg){
  const eps=obliqDeg(jd)*DEG,g=gstDeg(jd)*DEG,lst=g+lonDeg*DEG,phi=latDeg*DEG;
  let Lmc=Math.atan2(Math.sin(lst)*Math.cos(eps),Math.cos(lst)); Lmc=mod360(Lmc/DEG);
  const sinE=Math.sin(eps),cosE=Math.cos(eps),tanPhi=Math.tan(phi),sinL=Math.sin(lst),cosL=Math.cos(lst);
  let Lasc=Math.atan2(-cosL, sinL*cosE - tanPhi*sinE); Lasc=mod360(Lasc/DEG);
  return {ASC:Lasc,MC:Lmc};
}

/* ==== ハウス ==== */
const HouseSystems={whole(asc){const s=Math.floor(asc/30);return[...Array(12)].map((_,i)=>mod360((s+i)*30))}, equal(asc){return[...Array(12)].map((_,i)=>mod360(asc+i*30))}};
function housesFrom(asc,sys){if(asc==null)return null; return sys==='equal'?HouseSystems.equal(asc):HouseSystems.whole(asc)}

/* ==== アスペクト ==== */
function findAspects(pos,orb){
  const keys=Object.keys(pos).filter(k=>!["ASC","MC"].includes(k));
  const res=[]; for(let i=0;i<keys.length;i++){for(let j=i+1;j<keys.length;j++){
    const A=pos[keys[i]],B=pos[keys[j]];
    ASP.forEach(S=>{ if(Math.abs(dAng(A,B)-S[1])<= (orb??S[2])) res.push({p1:keys[i],p2:keys[j],type:S[0],delta:(dAng(A,B)-S[1]).toFixed(2),color:S[3]}) })
  }} return res;
}

/* ==== サビアン（短句） ==== */
let SABIAN=(()=>{const base={}; const put=(s,d,t)=>{base[s]??={};base[s][d]=t}; const words=[
["始動","資質の覚醒","初学の対話","原点","生の手触り","衝動の舵","自己点火","先導","粗削りの勇","直球","自己宣言","先駆者","火入れ","突破口","荒削りの魅力","居場所探し","無鉄砲","純度の維持","短期決戦","単独行","点火保持","見切り発車","速度超過","勝負勘","奮起","再起","単純化","単発集中","突破の代償","独立採算"],
["感覚へ降りる","所有の安心","五感の練磨","継続","手触り","価値の固定","土台づくり","素朴さ","粘り","堅実投資","蓄え","職人気質","美意識","習慣の力","現実味","食と体","コスパ","安定志向","マイペース","所有の試練","守りの強化","生活の芸術","素材主義","満ちる","味わう","保守と更新","地に足","信用構築","自給","完成度"],
["情報収集","交換","言葉遊び","二面性","橋渡し","好奇心","多芸","機動力","模倣と編集","即応","散漫と集中","ハブ化","短距離","ニュース性","伝書","即時判断","閃き","話術","マルチ","風の友","機転","器用貧乏","交差点","共有","比較","試行錯誤","軽装","速報","切替","通信路"],
["守る","居場所","家族性","共感","情の記憶","防衛線","保護本能","庇護と教育","巣作り","受容","ホーム","母性","仲間秩序","潮汐","回想","面倒見","支え合い","境界線","安心と甘え","世話焼き","ナイーブ","殻と芯","情の熟成","面影","内政","横のつながり","情の決壊","巣立ち","—","—"],
["自己表現","舞台へ","誇り","演出","中心","讃えられる喜び","太陽の心","創作","スポット","祝祭","称号","王道","ドラマ","リーダー性","勇姿","自己肯定","遊び心","拍手","晴れ舞台","過信","遊芸","情熱管理","見せる技術","気前","名乗り","主役交代","余裕","王道Ⅱ","歓喜","黄金期"],
["整える","微調整","実務力","分解能","衛生観","改善","段取り","点検","現場主義","最適化","習慣化","校正","秩序","素朴な善","誠実","品質","仕分け","省コスト","批評","調整役","気配り","健康管理","できることから","倫理","点をつなぐ","奉仕","仕様書","更正","日々の鍛錬","仕上げ"],
["対等","バランス","礼節","契約","装い","引き立て役","社交術","合意形成","デザイン","公正","相談役","ペアリング","距離感","鏡像","評判","紹介","化粧","パートナー契約","試練","公平の難しさ","社交の疲労","表面張力","場の空気","魅せ方","分配","均衡回復","交渉","橋渡しⅡ","場作り","洗練"],
["深掘り","秘密の共有","結束","代償の覚悟","濃密化","一心同体","影の力","心理戦","変容","極限耐性","混ざる","再生","裏取引","絆の契約","所有と明け渡し","独占","執着","背水","手放し試験","蘇生","禁断の扉","一点集中","深読み","継承","潜航","逆転","黒幕","最奥","再誕","核融合"],
["遠くを見る","自由へ","高い目標","旅立ち","哲学","学術","越境","拡大","狩りと収穫","高揚","冒険","信念","異文化","楽観","理想","直観の弓","宣言","ラッキー","誇張","暴走注意","教える","海外運","志の共有","倫理","スポーツ精神","コーチ","寛大","伸び代","巡幸","大団円"],
["社会の壁","責務","目標管理","階段を上る","時間の味方","常識","統治","実績","役割意識","地位","権威","規範","長期戦","冷静","持久","構造化","背骨","節制","損益計算","社会の父","硬派","冬の厳しさ","策と忍耐","信用積立","守破離","報酬","頂上手前","成果主義","越年","継承"],
["アップデート","既存打破","自由主義","友愛","ネットワーク","実験","未来志向","越境連帯","水平展開","共創","改革","独自規格","非同調","離脱と再接続","匿名性","テック","飛躍","発明","マイナー連合","俯瞰","アルゴリズム","変人力","集合知","シェア文化","反権威","ハック","中立","風通し","刷新","電撃"],
["境界の融解","共感の海","夢の回路","奉仕と祈り","芸術療法","慈悲","混沌の受容","無条件の愛","浄化","スピリット","予感","沈潜","献身","余白","憐憫","浄解","漂流","共鳴","内なる海","終幕","優しさの試練","手放し","許し","癒し","眠りと目覚め","見えない縁","合一","巡礼","涙の洗礼","輪廻"]
]; for(let s=0;s<12;s++){for(let d=1;d<=30;d++){put(s,d,words[s][d-1]||"")}} return base;})();
function sabianText(deg){deg=mod360(deg); const s=Math.floor(deg/30), d=Math.floor(deg-s*30)+1; return `${SIGNS[s]} ${d}度：${SABIAN?.[s]?.[d]||"（サビアン未設定）"}`}

/* ==== ジオコーディング ==== */
async function geocode(q){ try{ const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`; const r=await fetch(url,{headers:{'Accept-Language':'ja'}}); const js=await r.json(); if(js?.length){return {lat:parseFloat(js[0].lat),lon:parseFloat(js[0].lon)}} return null }catch(e){return null}}

/* ==== エフェメリス（差し込み口） ==== */
const EphemerisAdapter={
  // meta:{date,time,tz,dst,lat,lon}
  async compute(meta){
    // ★ここにSwiss Ephemeris等の呼び出しを入れると“生年月日＋出生地だけ”で自動化できます。
    // 例）return await fetch(EPHEM_ENDPOINT,{headers:{Authorization:EPHEM_TOKEN},body:JSON.stringify(meta)})
    return null; // ←今は未接続（手入力運用）
  }
}

/* ==== UI ==== */
function buildTable(){
  const el=document.getElementById('ptable');
  el.innerHTML=`<tr><th>天体</th><th>位置（度 or「度 サイン」）</th><th>備考</th></tr>`+
    KEYS.map(k=>{
      const p=PLANETS.find(x=>x[0]===k);
      return `<tr><td><span style="font-size:16px">${p[2]}</span> ${p[1]}</td>
      <td><input data-pl="${k}" placeholder="例：23.5 天秤 / 210"></td>
      <td class="small">${(k==="ASC"||k==="MC")?"Asc/MCはボタンで自動":"—"}</td></tr>`;
    }).join("");
}
buildTable();
function readPos(){const pos={}; document.querySelectorAll('[data-pl]').forEach(i=>{const k=i.getAttribute('data-pl'); const v=dmsToDeg(i.value); if(v!=null) pos[k]=v;}); return pos;}
function fillPos(map){document.querySelectorAll('[data-pl]').forEach(i=>{const k=i.getAttribute('data-pl'); if(map[k]!=null) i.value=degToSignText(map[k])})}
function collectMeta(){return {name:val('#name'), memo:val('#memo'), date:val('#date'), time:val('#time'),
  tz:parseFloat(val('#tz')||0), dst:parseFloat(val('#dst')||0), lat:parseFloat(val('#lat')||0), lon:parseFloat(val('#lon')||0),
  house:val('#house')||'whole', orb:parseFloat(val('#orb')||6), outer:val('#outer')||'sign', scale:parseFloat(val('#scale')||100)}}
function val(s){const e=document.querySelector(s); return e?e.value:""}
function setVal(s,v){const e=document.querySelector(s); if(e) e.value=v}

/* ==== チャート描画（アスペクト線込み） ==== */
function drawChart(canvas,pos,houses,opt={}){
  const ctx=canvas.getContext('2d'), W=canvas.width, H=canvas.height, cx=W/2, cy=H/2;
  ctx.clearRect(0,0,W,H);
  const s=(opt.scale??100)/100; const R=Math.min(W,H)*0.45*s;

  // 外環
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--dial'); ctx.fill();
  ctx.strokeStyle="#d6cec1"; ctx.lineWidth=2; ctx.stroke();

  // サイン帯
  const bandR1=R, bandR2=R-70;
  for(let i=0;i<12;i++){
    const a0=(i*30)*DEG - Math.PI/2, a1=a0+30*DEG;
    // セクター
    ctx.beginPath(); ctx.moveTo(cx+bandR2*Math.cos(a0),cy+bandR2*Math.sin(a0));
    ctx.arc(cx,cy,bandR1,a0,a1); ctx.lineTo(cx+bandR2*Math.cos(a1),cy+bandR2*Math.sin(a1));
    ctx.arc(cx,cy,bandR2,a1,a0,true); ctx.closePath();
    ctx.fillStyle = i%2? "#0d1e3d" : "#0f2347";
    ctx.fill();
    // サイン記号
    const mid=a0+15*DEG, rx=cx+(bandR2+bandR1)/2*Math.cos(mid), ry=cy+(bandR2+bandR1)/2*Math.sin(mid);
    ctx.fillStyle="#fff"; ctx.font="bold 20px system-ui"; ctx.textAlign='center'; ctx.textBaseline='middle';
    const label=opt.outer==='deg'? `${i*30}°` : ZGLYPH[i]; ctx.fillText(label,rx,ry);
  }

  // ハウス線
  if(houses){ for(let i=0;i<12;i++){ const ang=houses[i]*DEG - Math.PI/2;
      const x1=cx+(bandR2-10)*Math.cos(ang), y1=cy+(bandR2-10)*Math.sin(ang);
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x1,y1); ctx.strokeStyle=i===0?'#2a4f9b':'#cfc7b9'; ctx.lineWidth=i===0?3:1; ctx.stroke();
      const tx=cx+(bandR2-30)*Math.cos(ang), ty=cy+(bandR2-30)*Math.sin(ang);
      ctx.fillStyle=i===0?'#2a4f9b':'#666'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText((i+1),tx,ty);
  } }

  // 惑星位置の座標を先に計算
  const nodes={}; const rPl=bandR2-30;
  Object.keys(pos).forEach(k=>{
    const ang=pos[k]*DEG - Math.PI/2; const x=cx+rPl*Math.cos(ang), y=cy+rPl*Math.sin(ang);
    nodes[k]={x,y,ang};
  });

  // アスペクト線（内側サークル）
  const innerR=bandR2-120;
  const aspects=findAspects(pos, opt.orb);
  aspects.forEach(a=>{
    const p1=nodes[a.p1], p2=nodes[a.p2]; if(!p1||!p2) return;
    // 端が見やすいように内円へ少し寄せる
    const x1=cx+innerR*Math.cos(p1.ang), y1=cy+innerR*Math.sin(p1.ang);
    const x2=cx+innerR*Math.cos(p2.ang), y2=cy+innerR*Math.sin(p2.ang);
    const grd=ctx.createLinearGradient(x1,y1,x2,y2); grd.addColorStop(0,a.color); grd.addColorStop(1,a.color);
    ctx.strokeStyle=grd; ctx.lineWidth= a.type==="Conj"? 2.5 : 2;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  });

  // 内円
  ctx.beginPath(); ctx.arc(cx,cy,innerR,0,Math.PI*2); ctx.strokeStyle="#d9d3ca"; ctx.lineWidth=1; ctx.stroke();

  // 惑星ピン
  Object.keys(pos).forEach(k=>{
    const p=nodes[k], r=12;
    ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fillStyle="#ffffff"; ctx.fill(); ctx.strokeStyle="#1e2b49"; ctx.lineWidth=2; ctx.stroke();
    const pl=PLANETS.find(x=>x[0]===k);
    ctx.fillStyle="#0e2347"; ctx.font="16px system-ui"; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(pl?pl[2]:k,p.x,p.y);
  });
}

/* ==== サマリー・レポート ==== */
function elementOf(deg){const s=Math.floor(mod360(deg)/30); return [0,4,8].includes(s)?"火":[1,5,9].includes(s)?"地":[2,6,10].includes(s)?"風":"水"}
function modalityOf(deg){const s=Math.floor(mod360(deg)/30); return [0,3,6,9].includes(s)?"活動":[1,4,7,10].includes(s)?"固定":"柔軟"}
function personalYear(y,m,d,year){const sum=n=>n.toString().split("").reduce((a,b)=>a+parseInt(b||0),0); const red=n=>{while(n>9)n=sum(n); return n}; return red(sum(m)+sum(d)+sum(year))}
function personalMonth(py,month){let n=py+month; while(n>9){n=[...(""+n)].map(Number).reduce((a,b)=>a+b,0)} return n}

function aiReading(meta,pos){
  // エレメント/モード傾向
  const elems={火:0,地:0,風:0,水:0}, mods={活動:0,固定:0,柔軟:0};
  ["Sun","Moon","Mercury","Venus","Mars","Jupiter","Saturn"].forEach(k=>{ if(pos[k]!=null){ elems[elementOf(pos[k])]++; mods[modalityOf(pos[k])]++; }});
  const eTop=Object.entries(elems).sort((a,b)=>b[1]-a[1])[0][0];
  const mTop=Object.entries(mods).sort((a,b)=>b[1]-a[1])[0][0];

  const love=(()=>{
    if(pos.Venus!=null&&pos.Mars!=null){
      const ev=elementOf(pos.Venus), em=elementOf(pos.Mars);
      const line = ev===em ? "好み（金星）と行動（火星）が噛み合いやすい" : "好みと行動のテンポに差が出やすい。最初に“合図”を決めると噛み合う";
      return `【恋愛】金星は${degToSignText(pos.Venus)}（${ev}）／火星は${degToSignText(pos.Mars)}（${em}）。${line}。7H/ASCの天体は最優先で観察。`;
    }
    return "【恋愛】主要天体（♀♂）の入力で精度が上がります。";
  })();

  const work=(()=>{
    let s=`【仕事】全体のエネルギーは「${eTop}×${mTop}」。`;
    if(pos.MC!=null) s+=`MCは ${degToSignText(pos.MC)}。`;
    if(pos.Saturn!=null) s+=`土星は「${elementOf(pos.Saturn)}」に課題基準、`;
    if(pos.Jupiter!=null) s+=`木星は「${elementOf(pos.Jupiter)}」に拡大余地。`;
    return s+"日々の実務は6H、社会の顔は10Hで最終調整。";
  })();

  const aptMap={
    "火活動":"起業・営業・企画","火固定":"制作・パフォーマンス","火柔軟":"教育・広報・イベント",
    "地活動":"マネジメント・不動産・施工","地固定":"会計・品質・職人","地柔軟":"医療/介護・業務改善",
    "風活動":"IT・メディア・企画","風固定":"設計・研究・分析","風柔軟":"接客・通訳・編集",
    "水活動":"セラピー・福祉リーダー","水固定":"心理・芸術・研究","水柔軟":"看護・カウンセリング・奉仕"
  };
  const apt=`【適職】${aptMap[eTop+mTop]||"汎用職"}`;

  // 時期（数秘）
  const now=new Date(); const [y,mo,da]=meta.date?meta.date.split('-').map(Number):[now.getFullYear(), now.getMonth()+1, now.getDate()];
  const py=personalYear(y,mo,da, now.getFullYear());
  const months=[...Array(12)].map((_,i)=>({m:i+1, pm:personalMonth(py,i+1)}));
  const goodMove=months.filter(x=>[1,5].includes(x.pm)).map(x=>`${x.m}月`).join("・")||"—";
  const tidy=months.filter(x=>x.pm===9).map(x=>`${x.m}月`).join("・")||"—";
  const when=`【引越し/転職】動きやすい月：${goodMove}／整理に良い月：${tidy}`;

  const future=`【未来】今年(PY${py})のテーマ：${py===1?"始動/新章":py===2?"協調/土台":py===3?"発信/学び":py===4?"基礎固め":py===5?"変化/移動":py===6?"責任/家庭":py===7?"内省/研究":py===8?"成果/収穫":"手放し/完了"}。`;

  return {love,work,apt,when,future};
}

/* ==== 使いやすい説明（あなたの文体に寄せた短文） ==== */
function addHowToBlocks(lines){
  lines.push("— 理屈でやさしく説明するコア —");
  lines.push("属性＝火地風水（エネルギーの種類）／モード＝活動固定柔軟（動かし方）。");
  lines.push("火＝行動、地＝安定、風＝考え、水＝感情。活動＝始める、固定＝続ける、柔軟＝合わせる。");
}

/* ==== レポート作成 ==== */
function buildReport(meta,pos){
  const asp=findAspects(pos, meta.orb);
  const sab=[]; if(pos.Sun!=null) sab.push(["太陽",sabianText(pos.Sun)]);
  if(pos.Moon!=null) sab.push(["月",sabianText(pos.Moon)]);
  if(pos.ASC!=null) sab.push(["ASC",sabianText(pos.ASC)]);
  if(pos.MC!=null) sab.push(["MC",sabianText(pos.MC)]);

  const r=aiReading(meta,pos);
  const L=[];
  L.push(`▶ クライアント：${meta.name||""}（${meta.date||""} ${meta.time||""} / TZ${meta.tz||0} / 緯度${meta.lat||""} 経度${meta.lon||""}）`);
  L.push(`▶ ハウス：${meta.house.toUpperCase()}　Orb±${meta.orb}°`);
  L.push("— 天体位置 —"); Object.keys(pos).forEach(k=>L.push(`${k.padEnd(7)}：${degToSignText(pos[k])}`));
  L.push("— サビアン（☉☽ASC/MC）—"); sab.forEach(x=>L.push(`${x[0]}：${x[1]}`));
  L.push(""); addHowToBlocks(L);
  L.push(""); L.push(r.love); L.push(r.work); L.push(r.apt); L.push(r.when); L.push(r.future);
  L.push(""); L.push("※ 自動生成の“たたき台”。必要に応じて語尾・強調を整えてお使いください。");
  document.getElementById('report').value=L.join("\n");
}

/* ==== 画面部品 ==== */
function $(s){return document.querySelector(s)}
$("#geobtn").onclick=async()=>{const q=val('#place'); if(!q)return; const g=await geocode(q); if(!g){alert('見つかりませんでした'); return} setVal('#lat',g.lat); setVal('#lon',g.lon); alert('緯度経度を反映しました')}
$("#calc").onclick=()=>{const m=collectMeta(); if(!m.date){alert('生年月日を入れてください'); return}
  const [y,mo,d]=m.date.split('-').map(Number); const [hh,mi]=(m.time||"00:00").split(':').map(Number);
  const jd=jdFromYMD(y,mo,d, hh - m.tz - m.dst, mi);
  const {ASC,MC}=ascMcFrom(jd,m.lat,m.lon); fillPos({ASC,MC}); alert('Asc/MCを反映しました');
};
$("#draw").onclick=()=>{const m=collectMeta(); const p=readPos(); const houses=housesFrom(p.ASC,m.house); drawChart($('#cv'),p,houses,{outer:m.outer,scale:m.scale,orb:m.orb}); const asp=findAspects(p,m.orb);
  $('#aspBox').innerHTML= asp.length? asp.map(a=>`・<b>${a.p1}</b>×<b>${a.p2}</b> ${a.type} <span class="small">(Δ${a.delta}°)</span>`).join("<br>") : "（該当なし）";
  const S=[]; if(p.Sun!=null) S.push(`太陽：${sabianText(p.Sun)}`); if(p.Moon!=null) S.push(`月：${sabianText(p.Moon)}`); if(p.ASC!=null) S.push(`ASC：${sabianText(p.ASC)}`); if(p.MC!=null) S.push(`MC：${sabianText(p.MC)}`);
  $('#sabBox').innerHTML= S.length? S.join("<br>"):"（主要ポイント未入力）";
};
$("#reportBtn").onclick=()=>{const m=collectMeta(); const p=readPos(); $("#draw").click(); buildReport(m,p)};

/* ダブルクリックで再描画 */
document.getElementById('cv').addEventListener('click', ()=>$("#draw").click());

/* 起動時 */
buildTable();
</script>
</body>
</html>
