<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Horoscope PRO – Dark Gold</title>
<style>
:root{
  --bg:#0d1116; --card:#131922; --ink:#f6f6f6; --muted:#b9c4d1; --line:#243142;
  --band:#17202b; --band2:#1a2432; --tick:#324354;
  --gold:#e4c878; --white:#f6f6f6;
  --sq:#ff7676; --tr:#77a5ff; --se:#5bd394; --op:#f0c262; --cj:#ffffff; --inc:#b28cff;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 "Noto Serif JP","Hiragino Mincho ProN","Yu Mincho","Times New Roman",serif}
.container{max-width:1220px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:rgba(13,17,22,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20}
h1{margin:6px 0;font-size:20px;color:var(--gold)}
.small{color:var(--muted);font-size:12px}
.grid{display:grid;gap:16px}
@media(min-width:1080px){.grid{grid-template-columns:430px 1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
label{font-size:12px;color:var(--muted)}
input,select,button,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f141a;color:var(--ink)}
input:focus,select:focus,textarea:focus{outline:2px solid #34465a}
.btn{cursor:pointer;background:#0f141a}
.btn-ac{background:var(--gold);color:#111;border-color:var(--gold)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.help{font-size:12px;color:var(--muted)}
canvas{width:100%;height:auto;background:#0e141b;border:1px solid var(--line);border-radius:12px}
.meta{display:grid;grid-template-columns:120px 1fr;gap:8px;margin-top:10px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--line);padding:8px 10px;text-align:center}
.table th{color:var(--gold)}
.ribbon{display:inline-block;background:#1a2740;color:#d8e6ff;padding:6px 14px;border-radius:10px 10px 0 0;margin:-14px 0 6px}
.flex{display:flex;gap:6px;align-items:center}
.badge{position:absolute;transform:translate(-50%,-50%);background:#0b1016;border:1px solid #2d3d50;border-radius:8px;padding:2px 6px;font:12px ui-monospace;color:var(--white);white-space:nowrap}
.section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:14px}
.kv{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);margin:2px 4px 0 0}
.err{border-color:#ff6b6b}
h3,h4,th{color:var(--gold)}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>Horoscope PRO – Dark Gold</h1>
    <div class="small">3区分/4区分/天体表/ハウス・カスプ/アスペクト格子＋一覧（orb）/AI総評（恋愛・仕事・未来計画・相性・引越・転職・適職＋長所短所）/連番入力/地名→緯度経度</div>
  </div>
</header>

<main class="container grid">
  <!-- 入力 -->
  <section class="card">
    <span class="ribbon">入力</span>
    <div class="row" style="margin-top:8px">
      <div><label>氏名</label><input id="name" placeholder="例：鑑定Aさん"></div>
      <div>
        <label>出生地（地名→緯度経度）</label>
        <div class="flex"><input id="place" placeholder="例：名古屋市"><button id="geo" class="btn">地名検索</button></div>
        <div class="help">ヒットしづらい時は市区町村まで入力</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div>
        <label>生年月日（連番）</label>
        <input id="dateCompact" placeholder="1989531 または 19890531">
        <div class="help">7桁：YYYYMDD（1989531=1989/5/31）/ 8桁：YYYYMMDD（19890531）</div>
      </div>
      <div>
        <label>出生時刻（連番・任意）</label>
        <input id="timeCompact" placeholder="例：1200（=12:00）">
        <div class="help">4桁：HHMM（0735/1820 等）※ 12:00 / 12時00分 / 12-00 / 12 もOK</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div><label>緯度</label><input id="lat" type="number" step="0.0001" placeholder="35.1815"></div>
      <div><label>経度</label><input id="lon" type="number" step="0.0001" placeholder="136.9066"></div>
    </div>

    <div class="row">
      <div><label>UTC（日本=9）</label><input id="tz" type="number" value="9" step="0.25"></div>
      <div><label>DST</label><select id="dst"><option value="0">なし</option><option value="1">+1h</option></select></div>
    </div>

    <div class="row">
      <div><label>ハウス方式</label><select id="house"><option value="whole">Whole Sign</option><option value="equal">Equal</option></select></div>
      <div><label>アスペクト Orb（度）</label><input id="orb" type="number" value="6" step="0.5"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="calcAsc">Asc/MC 計算</button>
      <button class="btn-ac" id="run">鑑定を作成</button>
    </div>
    <div class="help" style="margin-top:6px">ASCは左（9時）固定／ハウスは反時計回り／各ハウス5°目盛</div>
  </section>

  <!-- 円盤 -->
  <section class="card">
    <span class="ribbon">ホロスコープ</span>
    <div style="position:relative;margin-top:8px">
      <canvas id="cv" width="1200" height="1200"></canvas>
      <div id="labels" style="position:absolute;left:0;top:0;transform:translate(600px,600px)"></div>
    </div>

    <div class="meta">
      <div>NAME</div><div id="sum_name">—</div>
      <div>DATE</div><div id="sum_date">—</div>
      <div>PLACE</div><div id="sum_place">—</div>
    </div>
  </section>
</main>

<!-- 表 -->
<section class="container section">
  <div class="kv">
    <div class="card">
      <span class="ribbon">3区分（活動／不動／柔軟）</span>
      <table class="table" id="t3"></table>
    </div>
    <div class="card">
      <span class="ribbon">4区分（火／地／風／水）</span>
      <table class="table" id="t4"></table>
    </div>
    <div class="card">
      <span class="ribbon">凡例</span>
      <div class="small">
        <div class="tag">☌ Conjunction</div>
        <div class="tag">⚹ Sextile</div>
        <div class="tag">□ Square</div>
        <div class="tag">△ Trine</div>
        <div class="tag">⚻ Quincunx</div>
        <div class="tag">☍ Opposition</div>
      </div>
    </div>
  </div>
</section>

<section class="container section">
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card">
      <span class="ribbon">天体表（記号・サイン・度分）</span>
      <table class="table" id="planetTbl"></table>
    </div>
    <div class="card">
      <span class="ribbon">ハウス・カスプ表（1～12／ASC/MC/DES/IC）</span>
      <table class="table" id="houseTbl"></table>
    </div>
  </div>
</section>

<section class="container section">
  <div class="card">
    <span class="ribbon">アスペクト（格子マトリクス）</span>
    <table class="table" id="aspMatrix"></table>
  </div>
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card">
      <span class="ribbon">アスペクト一覧（種類別／orb付き）</span>
      <div id="aspLists" class="small"></div>
    </div>
    <div class="card">
      <span class="ribbon">AI 自動総評（恋愛／仕事／未来計画／相性／引越／転職／適職＋長所・短所）</span>
      <textarea id="report" style="min-height:360px;width:100%"></textarea>
    </div>
  </div>
</section>

<footer class="container small" style="text-align:center;margin:28px 0;color:var(--muted)">© Horoscope PRO</footer>

<script>
/* ================= 基本定数 ================= */
const DEG=Math.PI/180, SIGNS=["牡羊","牡牛","双子","蟹","獅子","乙女","天秤","蠍","射手","山羊","水瓶","魚"];
const GL=[["Sun","☉"],["Moon","☽"],["Mercury","☿"],["Venus","♀"],["Mars","♂"],["Jupiter","♃"],["Saturn","♄"],["Uranus","♅"],["Neptune","♆"],["Pluto","♇"]];
const ASP=[["Conj",0,8,"var(--cj)","☌","0°"],["Sext",60,5,"var(--se)","⚹","60°"],["Square",90,6,"var(--sq)","□","90°"],["Trine",120,7,"var(--tr)","△","120°"],["Inc",150,4.5,"var(--inc)","⚻","150°"],["Opp",180,8,"var(--op)","☍","180°"]];
function mod360(x){x%=360; if(x<0)x+=360; return x}
function dAng(a,b){let d=Math.abs(a-b)%360; return d>180?360-d:d}
function css(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim()}

/* ========= 時刻・日付パース ========= */
function parseCompactDate(s){
  s=String(s||"").trim();
  if(!s) throw "生年月日が空です（1989531 / 19890531）";
  const digits=s.replace(/[^\d]/g,"");
  if(digits.length===7){ // YYYYMDD
    const y=+digits.slice(0,4), m=+digits.slice(4,5), d=+digits.slice(5,7);
    if(m<1||m>12||d<1||d>31) throw "生年月日が不正です";
    return {y,m,d};
  }else if(digits.length===8){ // YYYYMMDD
    const y=+digits.slice(0,4), m=+digits.slice(4,6), d=+digits.slice(6,8);
    if(m<1||m>12||d<1||d>31) throw "生年月日が不正です";
    return {y,m,d};
  }
  throw "生年月日は 1989531 または 19890531 で入力してください";
}
function parseCompactTime(str){
  if(!str || !String(str).trim()){return {hh:12, mi:0};}
  const s=String(str).trim().replace(/[^\d]/g,"").padEnd(4,"0").slice(0,4);
  const hh=+s.slice(0,2), mi=+s.slice(2,4);
  if(hh>23||mi>59) throw "時刻が不正です（例：1200 / 12:00）";
  return {hh,mi};
}

/* ========= 天文（簡易近似） ========= */
function jdFromYMD(y,m,d,hh=0,mi=0,tz=0,dst=0){ if(m<=2){y--;m+=12} const A=Math.floor(y/100),B=2-A+Math.floor(A/4),day=d+(hh+mi/60 - (tz+ +dst))/24; return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+day+B-1524.5;}
function obliqDeg(jd){const T=(jd-2451545.0)/36525;return 23+26/60+21.448/3600-(46.8150*T+0.00059*T*T-0.001813*T*T*T)/3600}
function gstDeg(jd){const T=(jd-2451545.0)/36525;return mod360(280.46061837+360.98564736629*(jd-2451545.0)+0.000387933*T*T-(T*T*T)/38710000)}
function ascMcFrom(jd,latDeg,lonDeg){
  const eps=obliqDeg(jd)*DEG, lst=gstDeg(jd)*DEG+lonDeg*DEG, phi=latDeg*DEG;
  let Lmc=Math.atan2(Math.sin(lst)*Math.cos(eps),Math.cos(lst)); Lmc=mod360(Lmc/DEG);
  const sinE=Math.sin(eps),cosE=Math.cos(eps),tanPhi=Math.tan(phi),sinL=Math.sin(lst),cosL=Math.cos(lst);
  let Lasc=Math.atan2(-cosL, sinL*cosE - tanPhi*sinE); Lasc=mod360(Lasc/DEG);
  return {ASC:Lasc,MC:Lmc,IC:mod360(Lmc+180),DES:mod360(Lasc+180)};
}
function Tcent(jd){return (jd-2451545.0)/36525}
function sunLon(jd){const T=Tcent(jd); const L0=mod360(280.46646+36000.76983*T+0.0003032*T*T); const M=mod360(357.52911+35999.05029*T-0.0001537*T*T)*DEG; const C=(1.914602-0.004817*T-0.000014*T*T)*Math.sin(M)+(0.019993-0.000101*T)*Math.sin(2*M)+0.000289*Math.sin(3*M); return mod360(L0+C);}
function moonLon(jd){const T=Tcent(jd), L0=mod360(218.3164477+481267.88123421*(jd-2451545)/36525); const M=mod360(134.9633964+477198.8675055*(jd-2451545)/36525)*DEG; const D=mod360(297.8501921+445267.1114034*(jd-2451545)/36525)*DEG; return mod360(L0 + 6.289*Math.sin(M) + 1.274*Math.sin(2*D - M) + 0.658*Math.sin(2*D) + 0.214*Math.sin(2*M) + 0.11*Math.sin(D));}
function planetMean(name){const n={Mercury:4.09233445,Venus:1.60213034,Mars:0.524039,Jupiter:0.0830867,Saturn:0.03344414,Uranus:0.0117696,Neptune:0.0060201,Pluto:0.0039640};
  const L0={Mercury:252.2509,Venus:181.9798,Mars:355.4330,Jupiter:34.3515,Saturn:50.0774,Uranus:314.0550,Neptune:304.3487,Pluto:238.9290};
  return jd=>mod360(L0[name]+n[name]*(jd-2451545.0));
}
const LON={Sun:jd=>sunLon(jd), Moon:jd=>moonLon(jd), Mercury:planetMean("Mercury"),Venus:planetMean("Venus"),Mars:planetMean("Mars"),Jupiter:planetMean("Jupiter"),Saturn:planetMean("Saturn"),Uranus:planetMean("Uranus"),Neptune:planetMean("Neptune"),Pluto:planetMean("Pluto")};

/* ====== ハウス ====== */
const Houses={ whole(asc){const s=Math.floor(asc/30);return[...Array(12)].map((_,i)=>mod360((s+i)*30))}, equal(asc){return[...Array(12)].map((_,i)=>mod360(asc+i*30))} };

/* ====== 地名→緯度経度（2段フェールオーバー） ====== */
async function geocodeNominatim(q){
  const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
  const r=await fetch(url,{headers:{'Accept-Language':'ja'}});
  if(!r.ok) throw new Error("nominatim fail");
  const js=await r.json();
  if(!js?.[0]) throw new Error("not found");
  return {lat:+js[0].lat, lon:+js[0].lon, provider:"nominatim"};
}
async function geocodeOpenMeteo(q){
  const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=ja&format=json`;
  const r=await fetch(url);
  if(!r.ok) throw new Error("open-meteo fail");
  const js=await r.json();
  if(!js?.results?.[0]) throw new Error("not found");
  const a=js.results[0]; return {lat:+a.latitude, lon:+a.longitude, provider:"open-meteo"};
}
async function geocodeSmart(q){
  if(!q) throw new Error("地名が空です");
  try{ return await geocodeNominatim(q); }catch(_){ return await geocodeOpenMeteo(q); }
}
document.getElementById("geo").onclick=async()=>{
  const q=document.getElementById("place").value.trim();
  if(!q) return alert("地名を入れてください");
  try{
    const g=await geocodeSmart(q);
    document.getElementById("lat").value=g.lat;
    document.getElementById("lon").value=g.lon;
    alert(`緯度経度：${g.lat.toFixed(4)}, ${g.lon.toFixed(4)}（${g.provider}）`);
  }catch(e){ alert("見つかりませんでした"); }
}

/* ====== 描画補助 ====== */
function angFor(longitude, ASC){ return ((ASC - longitude + 180) * DEG); } // ASC左=9時、反時計

function drawSignGlyph(ctx, idx, x, y, s, col=css("--gold")){
  ctx.save(); ctx.translate(x,y); ctx.strokeStyle=col; ctx.lineWidth=Math.max(2.0, s*0.06); ctx.lineCap="round"; ctx.lineJoin="round";
  const r=s*0.42;
  if(idx===0){ctx.beginPath();ctx.arc(-r*0.5,0,r*0.5,Math.PI*0.9,Math.PI*1.8);ctx.moveTo(-r*0.1,-r*0.6);ctx.quadraticCurveTo(0,-r*0.2,0,r*0.6);ctx.moveTo(r*0.1,-r*0.6);ctx.quadraticCurveTo(0,-r*0.2,0,r*0.6);ctx.stroke();}
  else if(idx===1){ctx.beginPath();ctx.arc(0,r*0.2,r*0.45,0,Math.PI*2);ctx.moveTo(-r*0.45,-r*0.2);ctx.quadraticCurveTo(-r*0.8,-r*0.6,-r*0.4,-r*0.65);ctx.moveTo(r*0.45,-r*0.2);ctx.quadraticCurveTo(r*0.8,-r*0.6,r*0.4,-r*0.65);ctx.stroke();}
  else if(idx===2){ctx.beginPath();ctx.moveTo(-r*0.5,-r*0.75);ctx.lineTo(r*0.5,-r*0.75);ctx.moveTo(-r*0.5,r*0.75);ctx.lineTo(r*0.5,r*0.75);ctx.moveTo(-r*0.3,-r*0.65);ctx.lineTo(-r*0.3,r*0.65);ctx.moveTo(r*0.3,-r*0.65);ctx.lineTo(r*0.3,r*0.65);ctx.stroke();}
  else if(idx===3){ctx.beginPath();ctx.arc(-r*0.35,-r*0.1,r*0.28,0,Math.PI*2);ctx.arc(r*0.35,r*0.1,r*0.28,0,Math.PI*2);ctx.moveTo(-r*0.1,-r*0.2);ctx.quadraticCurveTo(0,0,r*0.1,r*0.2);ctx.moveTo(r*0.1,r*0.2);ctx.quadraticCurveTo(0,0,-r*0.1,-r*0.2);ctx.stroke();}
  else if(idx===4){ctx.beginPath();ctx.arc(-r*0.1,0,r*0.5,Math.PI*0.1,Math.PI*1.6);ctx.moveTo(r*0.2,-r*0.2);ctx.quadraticCurveTo(r*0.6,0,r*0.35,r*0.55);ctx.stroke();}
  else if(idx===5){ctx.beginPath();ctx.moveTo(-r*0.6,r*0.7);ctx.lineTo(-r*0.6,-r*0.7);ctx.quadraticCurveTo(-r*0.2,-r*0.45,0,-r*0.7);ctx.lineTo(0,r*0.7);ctx.moveTo(0,-r*0.15);ctx.quadraticCurveTo(r*0.35,0,r*0.2,r*0.55);ctx.stroke();}
  else if(idx===6){ctx.beginPath();ctx.moveTo(-r*0.8,r*0.35);ctx.lineTo(r*0.8,r*0.35);ctx.moveTo(-r*0.8,0.05);ctx.arc(0,0,r*0.52,Math.PI,0);ctx.stroke();}
  else if(idx===7){ctx.beginPath();ctx.moveTo(-r*0.6,r*0.7);ctx.lineTo(-r*0.6,-r*0.7);ctx.quadraticCurveTo(-r*0.2,-r*0.45,0,-r*0.7);ctx.lineTo(0,r*0.7);ctx.moveTo(0,-r*0.1);ctx.quadraticCurveTo(r*0.45,0,r*0.38,r*0.4);ctx.lineTo(r*0.6,r*0.2);ctx.moveTo(r*0.38,r*0.4);ctx.lineTo(r*0.7,r*0.5);ctx.stroke();}
  else if(idx===8){ctx.beginPath();ctx.moveTo(-r*0.55,r*0.55);ctx.lineTo(r*0.7,-r*0.7);ctx.moveTo(r*0.3,-r*0.7);ctx.lineTo(r*0.7,-r*0.7);ctx.lineTo(r*0.7,-r*0.3);ctx.stroke();}
  else if(idx===9){ctx.beginPath();ctx.moveTo(-r*0.55,-r*0.1);ctx.quadraticCurveTo(0,-r*0.7,r*0.45,-r*0.1);ctx.quadraticCurveTo(r*0.18,r*0.25,-r*0.25,0);ctx.moveTo(-r*0.25,0);ctx.quadraticCurveTo(-r*0.06,r*0.55,r*0.28,r*0.42);ctx.stroke();}
  else if(idx===10){ctx.beginPath();ctx.moveTo(-r*0.85,-r*0.18);for(let i=0;i<3;i++){ctx.lineTo(-r*0.45+i*r*0.42,-r*0.4);ctx.lineTo(0+i*r*0.42,-r*0.18);}ctx.moveTo(-r*0.85,r*0.3);for(let i=0;i<3;i++){ctx.lineTo(-r*0.45+i*r*0.42,0.05);ctx.lineTo(0+i*r*0.42,r*0.3);}ctx.stroke();}
  else{ctx.beginPath();ctx.moveTo(-r*0.65,-r*0.45);ctx.quadraticCurveTo(-r*0.25,0,-r*0.65,r*0.45);ctx.moveTo(r*0.65,-r*0.45);ctx.quadraticCurveTo(r*0.25,0,r*0.65,r*0.45);ctx.moveTo(-r*0.72,0);ctx.lineTo(r*0.72,0);ctx.stroke();}
  ctx.restore();
}

function drawPlanetGlyph(ctx, key, x, y, size){
  const m={Sun:"☉",Moon:"☽",Mercury:"☿",Venus:"♀",Mars:"♂",Jupiter:"♃",Saturn:"♄",Uranus:"♅",Neptune:"♆",Pluto:"♇"};
  ctx.save(); ctx.fillStyle=css("--white"); ctx.strokeStyle=css("--gold"); ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(x,y,size*0.52,0,Math.PI*2); ctx.stroke();
  ctx.font=`${Math.round(size*0.9)}px 'Times New Roman',serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(m[key],x,y+1); ctx.restore();
}

function findAspects(pos,orb){
  const out=[]; const keys=GL.map(v=>v[0]);
  for(let i=0;i<keys.length;i++){
    for(let j=i+1;j<keys.length;j++){
      const a=pos[keys[i]], b=pos[keys[j]], d=dAng(a,b);
      for(const t of ASP){
        const dd=Math.abs(d-t[1]);
        if(dd<= (orb||6)){ out.push({p1:keys[i], p2:keys[j], type:t[0], orb:+dd.toFixed(2)}); break; }
      }
    }
  }
  return out;
}

function drawChart(canvas,pos,houses,{orb}={}){
  const ctx=canvas.getContext('2d'), W=canvas.width, H=canvas.height, cx=W/2, cy=H/2;
  ctx.clearRect(0,0,W,H);
  const labelsDiv=document.getElementById("labels"); labelsDiv.innerHTML=""; labelsDiv.style.transform=`translate(${cx}px,${cy}px)`;
  const R=Math.min(W,H)*0.46, bandR1=R-12, bandR2=R-86, houseR=bandR2-18;

  // 外輪
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.strokeStyle="#2b3644"; ctx.lineWidth=22; ctx.stroke();

  // サイン帯
  for(let i=0;i<12;i++){
    const lon=mod360(Math.floor(pos.ASC/30)*30 + i*30);
    const a0=angFor(lon,pos.ASC), a1=angFor(mod360(lon+30),pos.ASC);
    ctx.beginPath(); ctx.arc(cx,cy,bandR1,a0,a1,true); ctx.arc(cx,cy,bandR2,a1,a0,false); ctx.closePath();
    ctx.fillStyle= (i%2)? "var(--band)" : "var(--band2)"; ctx.fill();
    const mid=angFor(mod360(lon+15), pos.ASC);
    const rx=cx+(bandR1+bandR2)/2*Math.cos(mid), ry=cy+(bandR1+bandR2)/2*Math.sin(mid);
    drawSignGlyph(ctx, Math.floor(lon/30)%12, rx, ry, 86, "var(--gold)");
  }

  // ハウス線と5°目盛
  for(let i=0;i<12;i++){
    const cusp=houses[i], a=angFor(cusp, pos.ASC), x=cx+houseR*Math.cos(a), y=cy+houseR*Math.sin(a);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.lineWidth=i===0?2.6:1; ctx.strokeStyle=i===0?"var(--gold)":"var(--tick)"; ctx.stroke();
    for(let d=5; d<30; d+=5){
      const aa=angFor(mod360(cusp+d),pos.ASC); const r1=houseR-6, r2=houseR-(d%10===0?22:14);
      ctx.beginPath(); ctx.moveTo(cx+r1*Math.cos(aa), cy+r1*Math.sin(aa)); ctx.lineTo(cx+r2*Math.cos(aa), cy+r2*Math.sin(aa));
      ctx.lineWidth=1; ctx.strokeStyle="#3a4758"; ctx.stroke();
      if(d%10===0){ ctx.fillStyle=css("--gold"); ctx.font="11px ui-monospace"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(String(d), cx+(r2-10)*Math.cos(aa), cy+(r2-10)*Math.sin(aa));}
    }
    ctx.fillStyle=i===0?css("--gold"):css("--ink"); ctx.font="bold 12px 'Times New Roman',serif";
    ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(i+1, cx+(houseR-14)*Math.cos(a), cy+(houseR-14)*Math.sin(a));
  }

  // 内輪
  const innerR=houseR-100; ctx.beginPath(); ctx.arc(cx,cy,innerR,0,Math.PI*2); ctx.strokeStyle="#2b3747"; ctx.stroke();

  // 惑星位置（重なり回避・金枠＋白字）
  const order=GL.map(x=>x[0]); const nodes=[], used=[];
  order.forEach(k=>{const ang=angFor(pos[k],pos.ASC); let rr=houseR-18; for(const u of used){ if(Math.abs(ang-u)<(10*DEG)) rr-=14;} used.push(ang); nodes.push([k,ang,rr]); });

  // アスペクト
  const aspects=findAspects(pos,orb);
  aspects.forEach(a=>{
    const n1=nodes.find(n=>n[0]===a.p1), n2=nodes.find(n=>n[0]===a.p2);
    const p1={x:cx+innerR*Math.cos(n1[1]), y:cy+innerR*Math.sin(n1[1])};
    const p2={x:cx+innerR*Math.cos(n2[1]), y:cy+innerR*Math.sin(n2[1])};
    const col=css(ASP.find(s=>s[0]===a.type)[3]);
    ctx.strokeStyle=col; ctx.lineWidth= a.type==="Conj"?3:2.2; ctx.globalAlpha=.95; ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); ctx.globalAlpha=1;
    const mx=(p1.x+p2.x)/2, my=(p1.y+p2.y)/2; ctx.fillStyle=col; ctx.font="bold 13px ui-monospace"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(ASP.find(s=>s[0]===a.type)[4]+" "+ASP.find(s=>s[0]===a.type)[5],mx,my);
  });

  // 惑星ピン＋度数ラベル
  nodes.forEach(n=>{
    const k=n[0], ang=n[1], rr=n[2], x=cx+rr*Math.cos(ang), y=cy+rr*Math.sin(ang);
    drawPlanetGlyph(ctx,k,x,y,26);
    const lon=pos[k], sign=Math.floor(lon/30), deg=Math.floor(lon%30), min=Math.round((lon%1)*60);
    const el=document.createElement("div"); el.className="badge"; el.style.left=`${x}px`; el.style.top=`${y-26}px`;
    el.innerText = `${deg}°${String(min).padStart(2,"0")} ${SIGNS[sign]}`;
    document.getElementById("labels").appendChild(el);
  });

  // 角ポイント
  [["ASC",pos.ASC,"#9ad1ff"],["MC",pos.MC,"#ff93d9"],["IC",pos.IC,"#ff93d9"],["DES",pos.DES,"#9ad1ff"]].forEach(([nm,lon,col])=>{
    const a=angFor(lon,pos.ASC), x=cx+(bandR1-20)*Math.cos(a), y=cy+(bandR1-20)*Math.sin(a);
    ctx.fillStyle=col; ctx.font="bold 42px 'Times New Roman',serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(nm, x, y);
  });
}

/* ====== テーブル類 ====== */
function fm(lon){const s=Math.floor(lon/30), d=Math.floor(lon%30), m=Math.round((lon%1)*60); return [SIGNS[s], `${d}°${String(m).padStart(2,"0")}`];}
function buildTables(pos,houses,aspList){
  // 天体
  const p = GL.map(([k,g])=>{const [sg,dm]=fm(pos[k]);return `<tr><th>${g}</th><td>${sg}</td><td>${dm}</td></tr>`}).join("");
  document.getElementById("planetTbl").innerHTML=`<tr><th>天体</th><th>サイン</th><th>度分</th></tr>${p}`;
  // ハウス
  let h=`<tr><th>HOUSE</th><th>サイン</th><th>度分</th></tr>`;
  for(let i=0;i<12;i++){ const [sg,dm]=fm(houses[i]); h+=`<tr><th>${i+1}</th><td>${sg}</td><td>${dm}</td></tr>`}
  [["ASC",pos.ASC],["MC",pos.MC],["DES",pos.DES],["IC",pos.IC]].forEach(([k,v])=>{const [sg,dm]=fm(v); h+=`<tr><th>${k}</th><td>${sg}</td><td>${dm}</td></tr>`});
  document.getElementById("houseTbl").innerHTML=h;
  // 3区分・4区分
  const buckets3=[[],[],[]], buckets4=[[],[],[],[]];
  GL.forEach(([k,g])=>{
    const sign=Math.floor(pos[k]/30), mode=sign%3, elem=Math.floor(sign/3); buckets3[mode].push(g); buckets4[elem].push(g);
  });
  document.getElementById("t3").innerHTML=`<tr><th>活動</th><th>不動</th><th>柔軟</th></tr>
    <tr><td>${buckets3[0].join(" ")||"—"}</td><td>${buckets3[1].join(" ")||"—"}</td><td>${buckets3[2].join(" ")||"—"}</td></tr>`;
  document.getElementById("t4").innerHTML=`<tr><th>火</th><th>地</th><th>風</th><th>水</th></tr>
    <tr><td>${buckets4[0].join(" ")||"—"}</td><td>${buckets4[1].join(" ")||"—"}</td>
        <td>${buckets4[2].join(" ")||"—"}</td><td>${buckets4[3].join(" ")||"—"}</td></tr>`;
  // アスペクト マトリクス
  let M=`<tr><th></th>${GL.map(p=>`<th>${p[1]}</th>`).join("")}</tr>`;
  for(let i=0;i<GL.length;i++){
    M+=`<tr><th>${GL[i][1]}</th>`;
    for(let j=0;j<GL.length;j++){
      if(j<=i){ M+=`<td>—</td>`; continue; }
      const as=aspList.find(a=>(a.p1===GL[i][0]&&a.p2===GL[j][0]));
      if(!as){ M+=`<td></td>`; continue; }
      const info=ASP.find(x=>x[0]===as.type);
      M+=`<td title="${as.orb}°">${info[4]}</td>`;
    }
    M+=`</tr>`;
  }
  document.getElementById("aspMatrix").innerHTML=M;
  // アスペクト一覧
  const groups={Conj:[],Sext:[],Square:[],Trine:[],Inc:[],Opp:[]};
  aspList.forEach(a=>groups[a.type].push(a));
  const lab=(t)=>ASP.find(x=>x[0]===t)[4];
  let html="";
  [["Conj","コンジャンクション"],["Sext","セクスタイル"],["Square","スクエア"],["Trine","トライン"],["Inc","インコン"],["Opp","オポジション"]]
    .forEach(([k,ja])=>{
      html+=`<h4>${lab(k)} ${ja}</h4><ul>`;
      if(groups[k].length===0) html+=`<li>なし</li>`;
      groups[k].forEach(a=>{ const g1=GL.find(p=>p[0]===a.p1)[1], g2=GL.find(p=>p[0]===a.p2)[1]; html+=`<li>${g1} ${lab(k)} ${g2}（orb ${a.orb}°）</li>`;});
      html+=`</ul>`;
    });
  document.getElementById("aspLists").innerHTML=html;
}

/* ====== AI 総評（ルール駆動、各3行以上） ====== */
function aiReport(pos,houses,name){
  const signOf=(lon)=>Math.floor(lon/30);
  const elName=(s=>["火","地","風","水"][Math.floor(s/3)])(signOf(pos.Sun));
  const love = (()=>{ // 恋愛：金星・火星・7H
    const venS=signOf(pos.Venus), marS=signOf(pos.Mars), h7=houses[6];
    const lines=[];
    lines.push(`恋の基本姿勢は「${["率直で早い","安定重視","会話から始まる","守りたい","目立つ愛","細やかな気配り","調和とバランス","深く長く","自由で前向き","誠実で現実的","フラットで合理的","やさしい共感"][venS]}」。`);
    lines.push(`行動面は火星に現れ、あなたは「${["即断即行","粘り強さ","フットワーク","感情先行","ドラマティック","改善重視","関係構築","集中力","探求心","計画性","独自性","共感力"][marS]}」が強い。`);
    lines.push(`7ハウスの起点サイン（パートナー像）も加味すると、関係性は「${SIGNS[Math.floor(h7/30)]}的」な雰囲気を持つ。`)
    return lines.join("\n");
  })();
  const work = (()=>{ // 仕事：太陽・土星・10H
    const sunS=signOf(pos.Sun), satS=signOf(pos.Saturn); const h10=houses[9];
    const lines=[];
    lines.push(`太陽サインは「${SIGNS[sunS]}」で、目標設定の仕方は${["新規性と行動力","安定と着実さ","情報と流通","保護と育成","表現と主導","整備と改善","バランスと交渉","深耕と研究","探究と教育","構築と管理","仕組み化と刷新","ケアと奉仕"][sunS]}。`);
    lines.push(`土星は「${SIGNS[satS]}」で粘り強さの出やすい領域。困難を越える力はこのサインの資質を磨くほど強まる。`);
    lines.push(`社会的な見せ方は10ハウス起点の「${SIGNS[Math.floor(h10/30)]}」的。適切な肩書や役割の明確化が成功率を押し上げる。`);
    return lines.join("\n");
  })();
  const future = (()=>{ // 未来計画：木星・トランジット風
    const jS=signOf(pos.Jupiter);
    return [
      `拡大と発展の鍵は「${SIGNS[jS]}」領域の学びと経験値。ここを太くすると運の通り道が広がる。`,
      `短期は「ルーティンの最適化」と「信頼の積立」を並行。可視化できる成果物を月次で残すと良い。`,
      `中期は「役割の再定義」。自分が担う価値を一言で言語化し、発信軸を固定するとチャンスが集まる。`
    ].join("\n");
  })();
  const move = (()=>[
      `引っ越しは「太陽・月のエレメントが整う土地」を第一候補に。生活リズムが安定しやすい。`,
      `東西南北いずれか一方に30～60分移動するだけでも通勤・交友の導線が改善することが多い。`,
      `物件選びは「採光×静音×回線速度」の実測で判断。気分と生産性の双方を底上げできる。`
  ].join("\n"))();
  const career = (()=>[
      `転職は「今の強み×市場の需要」の交点に。肩書ではなくスキル指標（できる作業）で棚卸しを。`,
      `面接では太陽サインの強みを定量→事例化して提示。評価者の認知負荷を下げるのがコツ。`,
      `入社後90日の行動計画を先に出すと、期待値のズレが起きず序盤の信用形成が速い。`
  ].join("\n"))();
  const vocation = (()=>[
      `適職の軸は「太陽×10H×土星」。今の配置では、役割の明確化と継続運用が成果を作る。`,
      `副業・パラレルは木星サインのテーマで伸びやすい。時間を“箱”で確保し週次ルーチン化。`,
      `長期は「仕組みを残す」志向へ。手順書・テンプレ・自動化は将来の自由度を増す投資。`
  ].join("\n"))();
  const strengths = `長所：意思決定が早い／学習曲線が急／対人の調整力が高い。状況の要点を掴み行動に落とすのが速い。`;
  const weaknesses= `短所：やることを抱え込みがち／完璧主義に偏る傾向。中間成果の共有が遅れると周囲が追随しにくい。`;
  const rel = (()=>[
      `相性は「月と金星のエレメント相性」が基礎。感情（夜）と好み（昼）が同系統だと摩擦が少ない。`,
      `異なる要素でも、連絡頻度・休息の取り方・お金の使い方を先に明文化すれば長期安定。`,
      `衝突は「火星×土星の角度」で発生しやすい。事実→感情→要望の順に話せば解決が早い。`
  ].join("\n"))();

  return [
    `【総評】${name||"ご本人"}の基本傾向は「${elName}」寄り。日常の選択をこのエレメント基準で整えるとブレが減ります。`,
    `— 恋愛 —\n${love}`,
    `— 仕事 —\n${work}`,
    `— 未来計画 —\n${future}`,
    `— 相性 —\n${rel}`,
    `— 引っ越し時期 —\n${move}`,
    `— 転職時期 —\n${career}`,
    `— 適職 —\n${vocation}`,
    `— 長所 —\n${strengths}`,
    `— 短所 —\n${weaknesses}`
  ].join("\n\n");
}

/* ====== 実行 ====== */
function metaFromInputs(){
  const {y,m,d}=parseCompactDate(document.getElementById("dateCompact").value);
  const {hh,mi}=parseCompactTime(document.getElementById("timeCompact").value);
  const lat=+document.getElementById("lat").value, lon=+document.getElementById("lon").value;
  const tz=+document.getElementById("tz").value, dst=+document.getElementById("dst").value;
  if(isNaN(lat)||isNaN(lon)) throw "緯度経度を入力（または地名検索）してください";
  const jd=jdFromYMD(y,m,d,hh,mi,tz,dst);
  return {y,m,d,hh,mi,lat,lon,tz,dst,jd};
}

document.getElementById("calcAsc").onclick=()=>{
  try{
    const M=metaFromInputs(); const am=ascMcFrom(M.jd,M.lat,M.lon);
    alert(`ASC ${am.ASC.toFixed(2)}° / MC ${am.MC.toFixed(2)}°`);
  }catch(e){ alert(e); }
};

document.getElementById("run").onclick=()=>{
  try{
    const M=metaFromInputs();
    const am=ascMcFrom(M.jd,M.lat,M.lon);
    // 惑星位置
    const pos={ASC:am.ASC,MC:am.MC,IC:am.IC,DES:am.DES};
    Object.assign(pos,{
      Sun:LON.Sun(M.jd), Moon:LON.Moon(M.jd), Mercury:LON.Mercury(M.jd),Venus:LON.Venus(M.jd),
      Mars:LON.Mars(M.jd),Jupiter:LON.Jupiter(M.jd),Saturn:LON.Saturn(M.jd),Uranus:LON.Uranus(M.jd),
      Neptune:LON.Neptune(M.jd),Pluto:LON.Pluto(M.jd)
    });
    // ハウス
    const mode=document.getElementById("house").value;
    const houses = mode==="whole" ? Houses.whole(am.ASC) : Houses.equal(am.ASC);
    // 描画
    drawChart(document.getElementById("cv"), pos, houses, {orb:+document.getElementById("orb").value||6});
    // 表
    const aspects=findAspects(pos,+document.getElementById("orb").value||6);
    buildTables(pos,houses,aspects);
    // サマリ
    const nm=document.getElementById("name").value||"—";
    document.getElementById("sum_name").textContent=nm;
    document.getElementById("sum_place").textContent=document.getElementById("place").value||`${M.lat.toFixed(3)}, ${M.lon.toFixed(3)}`;
    document.getElementById("sum_date").textContent=`${M.y}-${String(M.m).padStart(2,"0")}-${String(M.d).padStart(2,"0")}  ${String(M.hh).padStart(2,"0")}:${String(M.mi).padStart(2,"0")}`;
    // AI
    document.getElementById("report").value = aiReport(pos, houses, nm);
  }catch(e){ alert(e); }
};

/* ==== パッチ：時間入力の許容拡大（12:00 / 12時00分 / 12-00 / 1200 / 12 など） ==== */
document.getElementById("timeCompact").placeholder = "例：1200（=12:00）";
document.getElementById("timeCompact").value = ""; // 初期値は空
</script>
</body>
</html>
