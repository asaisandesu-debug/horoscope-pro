<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Horoscope PRO – Dark Gold（離線安定版 / Placidus→Equal）</title>
<style>
:root{
  --bg:#0d1116; --card:#121921; --ink:#f6f6f6; --muted:#b9c4d1; --line:#243142;
  --band:#0f1c17; --band2:#10221b; --tick:#2f4a42;
  --gold:#e4c878; --white:#f6f6f6;
  --emerald:#00b894; --emerald2:#66ffcc;
  --sq:#ff7b7b; --tr:#66a6ff; --se:#5bd394; --op:#f0c262; --cj:#ffffff; --inc:#b28cff;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 "Noto Serif JP","Yu Mincho","Hiragino Mincho ProN","Times New Roman",serif}
header{position:sticky;top:0;background:rgba(13,17,22,.86);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20}
.container{max-width:1220px;margin:0 auto;padding:16px}
h1{margin:6px 0;font-size:20px;color:var(--gold)}
.small{color:var(--muted);font-size:12px}

.grid{display:grid;gap:16px}
@media(min-width:1080px){.grid{grid-template-columns:430px 1fr}}

.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
label{font-size:12px;color:var(--muted)}
input,select,button,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f141a;color:var(--ink)}
input:focus,select:focus,textarea:focus{outline:2px solid #2f6b58}
.btn{cursor:pointer;background:#0f141a}
.btn-ac{background:var(--gold);color:#111;border-color:var(--gold)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.help{font-size:12px;color:var(--muted)}

canvas{width:100%;height:auto;background:#0e1514;border:1px solid var(--line);border-radius:12px}
.meta{display:grid;grid-template-columns:120px 1fr;gap:8px;margin-top:10px}

.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--line);padding:8px 10px;text-align:center}
.table th{color:var(--gold)}
.ribbon{display:inline-block;background:#103327;color:#d8ffe9;padding:6px 14px;border-radius:10px 10px 0 0;margin:-14px 0 6px}
.section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:14px}
.kv{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);margin:2px 4px 0 0}
h3,h4,th{color:var(--gold)}
.badge{position:absolute;transform:translate(-50%,-50%);background:#0b1612;border:1px solid #2b6a57;border-radius:8px;padding:2px 6px;font:12px ui-monospace;color:#fff;white-space:nowrap}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>Horoscope PRO – Dark Gold（Placidus 安定版 / オフライン）</h1>
    <div class="small">3区分/4区分/天体表/ハウス・カスプ/アスペクト格子＋一覧（orb）/AI総評（恋愛・仕事・未来計画・相性・引越・転職・適職＋長所短所）</div>
  </div>
</header>

<main class="container grid">
  <!-- 入力 -->
  <section class="card">
    <span class="ribbon">入力</span>
    <div class="row" style="margin-top:8px">
      <div><label>氏名</label><input id="name" placeholder="例：鑑定Aさん"></div>
      <div>
        <label>出生地（任意メモ）</label>
        <div style="display:flex;gap:6px">
          <input id="place" placeholder="例：名古屋市">
          <button id="geo" class="btn">地名検索</button>
        </div>
        <div class="help">※この安定版では地名検索は無効化。緯度・経度を手入力してください。</div>
      </div>
    </div>
    <div class="row">
      <div><label>生年月日（連番）</label><input id="dateCompact" placeholder="1989531 または 19890531"><div class="help">7桁：YYYYMDD（1989531=1989/5/31）/ 8桁：YYYYMMDD</div></div>
      <div><label>出生時刻（連番）</label><input id="timeCompact" placeholder="例：1200（=12:00）"><div class="help">4桁：HHMM（0735/1820 等）※空欄OK（=12:00）</div></div>
    </div>
    <div class="row">
      <div><label>緯度</label><input id="lat" type="number" step="0.0001" placeholder="35.1815"></div>
      <div><label>経度</label><input id="lon" type="number" step="0.0001" placeholder="136.9066"></div>
    </div>
    <div class="row">
      <div><label>UTC（日本=9）</label><input id="tz" type="number" value="9" step="0.25"></div>
      <div><label>DST</label><select id="dst"><option value="0" selected>なし</option><option value="1">+1h</option></select></div>
    </div>
    <div class="row">
      <div><label>ハウス方式</label>
        <select id="house">
          <option value="placidus" selected>Placidus（失敗時はEqualに自動切替）</option>
          <option value="equal">Equal</option>
          <option value="whole">Whole Sign</option>
        </select>
      </div>
      <div><label>アスペクト Orb（度）</label><input id="orb" type="number" value="6" step="0.5"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="calcAsc">Asc/MC 計算</button>
      <button class="btn-ac" id="run">鑑定を作成</button>
    </div>
    <div class="help" style="margin-top:6px">ASCは左（9時）固定／ハウスは反時計回り／各ハウス5°目盛</div>
    <div id="modeNote" class="small" style="margin-top:6px;color:#9debcf"></div>
  </section>

  <!-- チャート -->
  <section class="card">
    <span class="ribbon">ホロスコープ</span>
    <div style="position:relative;margin-top:8px">
      <canvas id="cv" width="1200" height="1200"></canvas>
      <div id="labels" style="position:absolute;left:0;top:0;transform:translate(600px,600px)"></div>
    </div>
    <div class="meta">
      <div>NAME</div><div id="sum_name">—</div>
      <div>DATE</div><div id="sum_date">—</div>
      <div>PLACE</div><div id="sum_place">—</div>
    </div>
  </section>
</main>

<!-- 集計/表/AI -->
<section class="container section">
  <div class="kv">
    <div class="card"><span class="ribbon">3区分（活動／不動／柔軟）</span><table class="table" id="t3"></table></div>
    <div class="card"><span class="ribbon">4区分（火／地／風／水）</span><table class="table" id="t4"></table></div>
    <div class="card">
      <span class="ribbon">凡例</span>
      <div class="small">
        <div class="tag">☌ Conjunction</div><div class="tag">⚹ Sextile</div><div class="tag">□ Square</div>
        <div class="tag">△ Trine</div><div class="tag">⚻ Quincunx</div><div class="tag">☍ Opposition</div>
      </div>
    </div>
  </div>
</section>

<section class="container section">
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card"><span class="ribbon">天体表（記号・サイン・度分）</span><table class="table" id="planetTbl"></table></div>
    <div class="card"><span class="ribbon">ハウス・カスプ表（1～12／ASC/MC/DES/IC）</span><table class="table" id="houseTbl"></table></div>
  </div>
</section>

<section class="container section">
  <div class="card"><span class="ribbon">アスペクト（格子マトリクス）</span><table class="table" id="aspMatrix"></table></div>
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card"><span class="ribbon">アスペクト一覧（種類別／orb付き）</span><div id="aspLists" class="small"></div></div>
    <div class="card"><span class="ribbon">AI 自動総評（恋愛／仕事／未来計画／相性／引越／転職／適職＋長所・短所）</span><textarea id="report" style="min-height:360px;width:100%"></textarea></div>
  </div>
</section>

<footer class="container small" style="text-align:center;margin:28px 0;color:var(--muted)">© Horoscope PRO</footer>

<script>
/* ===== 基本ユーティリティ ===== */
const DEG=Math.PI/180;
const SIGNS=["牡羊","牡牛","双子","蟹","獅子","乙女","天秤","蠍","射手","山羊","水瓶","魚"];
const GL=[["Sun","☉"],["Moon","☽"],["Mercury","☿"],["Venus","♀"],["Mars","♂"],["Jupiter","♃"],["Saturn","♄"],["Uranus","♅"],["Neptune","♆"],["Pluto","♇"]];
const ASP=[["Conj",0,8,"#ffffff","☌","0°"],["Sext",60,5,"#5bd394","⚹","60°"],["Square",90,6,"#ff7b7b","□","90°"],["Trine",120,7,"#66a6ff","△","120°"],["Inc",150,4.5,"#b28cff","⚻","150°"],["Opp",180,8,"#f0c262","☍","180°"]];
function mod360(x){x%=360;if(x<0)x+=360;return x}
function dAng(a,b){let d=Math.abs(a-b)%360;return d>180?360-d:d}
function toDM(lon){lon=mod360(lon);const d=Math.floor(lon%30),m=Math.round((lon%1)*60);return [SIGNS[Math.floor(lon/30)],`${d}°${String(m).padStart(2,"0")}′`];}

/* ===== 入力パース ===== */
function parseCompactDate(s){
  s=(s||"").toString().trim(); if(!s) throw "生年月日が空です（1989531 / 19890531）";
  const d=s.replace(/[^\d]/g,"");
  if(d.length===7) return {y:+d.slice(0,4),m:+d.slice(4,5),d:+d.slice(5,7)};
  if(d.length===8) return {y:+d.slice(0,4),m:+d.slice(4,6),d:+d.slice(6,8)};
  throw "生年月日は 1989531 または 19890531 で入力してください";
}
function parseCompactTime(t){
  if(!t||!String(t).trim()) return {hh:12,mi:0};
  const s=String(t).replace(/[^\d]/g,"").padEnd(4,"0").slice(0,4);
  const hh=+s.slice(0,2),mi=+s.slice(2,4);
  if(hh>23||mi>59) throw "時刻が不正です（例：1200 / 12:00）";
  return {hh,mi};
}

/* ===== JD / 恒星時 / 黄道傾斜 ===== */
function jdFromYMD(y,m,d,hh=0,mi=0,tz=0,dst=0){
  if(m<=2){y--;m+=12}
  const A=Math.floor(y/100),B=2-A+Math.floor(A/4);
  const day=d+(hh+mi/60-(tz+ +dst))/24;
  return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+day+B-1524.5;
}
function obliqDeg(jd){const T=(jd-2451545.0)/36525;return 23+26/60+21.448/3600-(46.8150*T+0.00059*T*T-0.001813*T*T*T)/3600}
function gstDeg(jd){const T=(jd-2451545.0)/36525;return mod360(280.46061837+360.98564736629*(jd-2451545.0)+0.000387933*T*T-(T*T*T)/38710000)}

/* ===== 惑星黄経（軽量近似） ===== */
function Tcent(jd){return (jd-2451545.0)/36525}
function sunLon(jd){const T=Tcent(jd);const L0=mod360(280.46646+36000.76983*T+0.0003032*T*T);const M=mod360(357.52911+35999.05029*T-0.0001537*T*T)*DEG;const C=(1.914602-0.004817*T-0.000014*T*T)*Math.sin(M)+(0.019993-0.000101*T)*Math.sin(2*M)+0.000289*Math.sin(3*M);return mod360(L0+C);}
function moonLon(jd){const t=(jd-2451545)/36525;const L0=mod360(218.3164477+481267.88123421*t);const M=mod360(134.9633964+477198.8675055*t)*DEG;const D=mod360(297.8501921+445267.1114034*t)*DEG;return mod360(L0+6.289*Math.sin(M)+1.274*Math.sin(2*D-M)+0.658*Math.sin(2*D)+0.214*Math.sin(2*M)+0.11*Math.sin(D));}
function planetMean(name){const n={Mercury:4.09233445,Venus:1.60213034,Mars:0.524039,Jupiter:0.0830867,Saturn:0.03344414,Uranus:0.0117696,Neptune:0.0060201,Pluto:0.003964};
const L0={Mercury:252.2509,Venus:181.9798,Mars:355.4330,Jupiter:34.3515,Saturn:50.0774,Uranus:314.0550,Neptune:304.3487,Pluto:238.9290};
return jd=>mod360(L0[name]+n[name]*(jd-2451545.0));}
const LON={Sun:jd=>sunLon(jd),Moon:jd=>moonLon(jd),Mercury:planetMean("Mercury"),Venus:planetMean("Venus"),Mars:planetMean("Mars"),Jupiter:planetMean("Jupiter"),Saturn:planetMean("Saturn"),Uranus:planetMean("Uranus"),Neptune:planetMean("Neptune"),Pluto:planetMean("Pluto")};

/* ===== ASC/MC ===== */
function ascMcFrom(jd,latDeg,lonDeg){
  const eps=obliqDeg(jd)*DEG,lst=gstDeg(jd)*DEG+lonDeg*DEG,phi=latDeg*DEG;
  let Lmc=Math.atan2(Math.sin(lst)*Math.cos(eps),Math.cos(lst)); Lmc=mod360(Lmc/DEG);
  const sinE=Math.sin(eps),cosE=Math.cos(eps),tanPhi=Math.tan(phi),sinL=Math.sin(lst),cosL=Math.cos(lst);
  let Lasc=Math.atan2(-cosL, sinL*cosE - tanPhi*sinE); Lasc=mod360(Lasc/DEG);
  return {ASC:Lasc,MC:Lmc,IC:mod360(Lmc+180),DES:mod360(Lasc+180),eps,lst,phi};
}

/* ===== Placidus（安全版）→失敗時 Equal ===== */
function RAdecFromEcl(lon,eps){lon*=DEG;const se=Math.sin(eps),ce=Math.cos(eps);const x=Math.cos(lon),y=Math.sin(lon);return {ra:Math.atan2(y*ce,x),dec:Math.asin(y*se)};}
function eclFromRA(ra,dec,eps){const se=Math.sin(eps),ce=Math.cos(eps);const y=Math.sin(ra)*ce + Math.tan(dec)*se;const x=Math.cos(ra);return mod360(Math.atan2(y,x)/DEG);}
function H0(dec,phi){const t=-Math.tan(phi)*Math.tan(dec);if(t<=-1)return Math.PI;if(t>=1)return 0;return Math.acos(t);}
function solveFrac(targetFrac,RAMC,upper,eps,phi){
  let ra=RAMC+(upper?+1:-1)*targetFrac*(Math.PI/2);
  for(let k=0;k<60;k++){
    const lon=mod360(ra/DEG);const {ra:ra2,dec}=RAdecFromEcl(lon,eps);
    const H=H0(dec,phi), want=(upper?+1:-1)*targetFrac*H;
    const diff=(ra-RAMC)-want; ra-=diff*0.6; if(Math.abs(diff)<1e-7)break;
  }return ra;
}
function placidusCuspsSafe(A){
  try{
    const {eps,lst,phi}=A;
    const cusps=new Array(12).fill(0);
    cusps[0]=A.ASC; cusps[9]=A.MC;
    const ra11=solveFrac(1/3,lst,true,eps,phi), ra12=solveFrac(2/3,lst,true,eps,phi);
    const ra2 =solveFrac(2/3,lst+Math.PI,false,eps,phi), ra3 =solveFrac(1/3,lst+Math.PI,false,eps,phi);
    cusps[10]=eclFromRA(ra11,0,eps); cusps[11]=eclFromRA(ra12,0,eps);
    cusps[1]=A.ASC; cusps[2]=eclFromRA(ra2,0,eps); cusps[3]=eclFromRA(ra3,0,eps);
    cusps[4]=mod360(cusps[10]+180); cusps[5]=mod360(cusps[11]+180);
    cusps[6]=mod360(cusps[0]+180);  cusps[7]=mod360(cusps[1]+180); cusps[8]=mod360(cusps[2]+180);
    if(cusps.some(v=>!isFinite(v))) throw 0;
    return {list:cusps, note:"Placidus"};
  }catch(_){
    const eq=[...Array(12)].map((_,i)=>mod360(A.ASC+i*30));
    return {list:eq, note:"Equal（Placidus困難のため自動切替）"};
  }
}
const Houses={equal(asc){return[...Array(12)].map((_,i)=>mod360(asc+i*30))},whole(asc){const s=Math.floor(asc/30);return[...Array(12)].map((_,i)=>mod360((s+i)*30))}};

/* ===== チャート描画 ===== */
function drawSignGlyph(ctx, idx, x, y, s, col="#e4c878"){
  ctx.save(); ctx.translate(x,y); ctx.strokeStyle=col; ctx.lineWidth=Math.max(2.0, s*0.06); ctx.lineCap="round"; ctx.lineJoin="round";
  const r=s*0.42;
  if(idx===0){ctx.beginPath();ctx.arc(-r*0.5,0,r*0.5,Math.PI*0.9,Math.PI*1.8);ctx.moveTo(-r*0.1,-r*0.6);ctx.quadraticCurveTo(0,-r*0.2,0,r*0.6);ctx.moveTo(r*0.1,-r*0.6);ctx.quadraticCurveTo(0,-r*0.2,0,r*0.6);ctx.stroke();}
  else if(idx===1){ctx.beginPath();ctx.arc(0,r*0.2,r*0.45,0,Math.PI*2);ctx.moveTo(-r*0.45,-r*0.2);ctx.quadraticCurveTo(-r*0.8,-r*0.6,-r*0.4,-r*0.65);ctx.moveTo(r*0.45,-r*0.2);ctx.quadraticCurveTo(r*0.8,-r*0.6,r*0.4,-r*0.65);ctx.stroke();}
  else if(idx===2){ctx.beginPath();ctx.moveTo(-r*0.5,-r*0.75);ctx.lineTo(r*0.5,-r*0.75);ctx.moveTo(-r*0.5,r*0.75);ctx.lineTo(r*0.5,r*0.75);ctx.moveTo(-r*0.3,-r*0.65);ctx.lineTo(-r*0.3,r*0.65);ctx.moveTo(r*0.3,-r*0.65);ctx.lineTo(r*0.3,r*0.65);ctx.stroke();}
  else if(idx===3){ctx.beginPath();ctx.arc(-r*0.35,-r*0.1,r*0.28,0,Math.PI*2);ctx.arc(r*0.35,r*0.1,r*0.28,0,Math.PI*2);ctx.moveTo(-r*0.1,-r*0.2);ctx.quadraticCurveTo(0,0,r*0.1,r*0.2);ctx.moveTo(r*0.1,r*0.2);ctx.quadraticCurveTo(0,0,-r*0.1,-r*0.2);ctx.stroke();}
  else if(idx===4){ctx.beginPath();ctx.arc(-r*0.1,0,r*0.5,Math.PI*0.1,Math.PI*1.6);ctx.moveTo(r*0.2,-r*0.2);ctx.quadraticCurveTo(r*0.6,0,r*0.35,r*0.55);ctx.stroke();}
  else if(idx===5){ctx.beginPath();ctx.moveTo(-r*0.6,r*0.7);ctx.lineTo(-r*0.6,-r*0.7);ctx.quadraticCurveTo(-r*0.2,-r*0.45,0,-r*0.7);ctx.lineTo(0,r*0.7);ctx.moveTo(0,-r*0.15);ctx.quadraticCurveTo(r*0.35,0,r*0.2,r*0.55);ctx.stroke();}
  else if(idx===6){ctx.beginPath();ctx.moveTo(-r*0.8,r*0.35);ctx.lineTo(r*0.8,r*0.35);ctx.moveTo(-r*0.8,0.05);ctx.arc(0,0,r*0.52,Math.PI,0);ctx.stroke();}
  else if(idx===7){ctx.beginPath();ctx.moveTo(-r*0.6,r*0.7);ctx.lineTo(-r*0.6,-r*0.7);ctx.quadraticCurveTo(-r*0.2,-r*0.45,0,-r*0.7);ctx.lineTo(0,r*0.7);ctx.moveTo(0,-r*0.1);ctx.quadraticCurveTo(r*0.45,0,r*0.38,r*0.4);ctx.lineTo(r*0.6,r*0.2);ctx.moveTo(r*0.38,r*0.4);ctx.lineTo(r*0.7,r*0.5);ctx.stroke();}
  else if(idx===8){ctx.beginPath();ctx.moveTo(-r*0.55,r*0.55);ctx.lineTo(r*0.7,-r*0.7);ctx.moveTo(r*0.3,-r*0.7);ctx.lineTo(r*0.7,-r*0.7);ctx.lineTo(r*0.7,-r*0.3);ctx.stroke();}
  else if(idx===9){ctx.beginPath();ctx.moveTo(-r*0.55,-r*0.1);ctx.quadraticCurveTo(0,-r*0.7,r*0.45,-r*0.1);ctx.quadraticCurveTo(r*0.18,r*0.25,-r*0.25,0);ctx.moveTo(-r*0.25,0);ctx.quadraticCurveTo(-r*0.06,r*0.55,r*0.28,r*0.42);ctx.stroke();}
  else if(idx===10){ctx.beginPath();ctx.moveTo(-r*0.85,-r*0.18);for(let i=0;i<3;i++){ctx.lineTo(-r*0.45+i*r*0.42,-r*0.4);ctx.lineTo(0+i*r*0.42,-r*0.18);}ctx.moveTo(-r*0.85,r*0.3);for(let i=0;i<3;i++){ctx.lineTo(-r*0.45+i*r*0.42,0.05);ctx.lineTo(0+i*r*0.42,r*0.3);}ctx.stroke();}
  else{ctx.beginPath();ctx.moveTo(-r*0.65,-r*0.45);ctx.quadraticCurveTo(-r*0.25,0,-r*0.65,r*0.45);ctx.moveTo(r*0.65,-r*0.45);ctx.quadraticCurveTo(r*0.25,0,r*0.65,r*0.45);ctx.moveTo(-r*0.72,0);ctx.lineTo(r*0.72,0);ctx.stroke();}
  ctx.restore();
}
function drawPlanetGlyph(ctx,key,x,y,size){
  const m={Sun:"☉",Moon:"☽",Mercury:"☿",Venus:"♀",Mars:"♂",Jupiter:"♃",Saturn:"♄",Uranus:"♅",Neptune:"♆",Pluto:"♇"};
  ctx.save();ctx.fillStyle="#f6f6f6";ctx.strokeStyle="#e4c878";ctx.lineWidth=2;ctx.beginPath();ctx.arc(x,y,size*0.52,0,Math.PI*2);ctx.stroke();
  ctx.font=`${Math.round(size*0.9)}px 'Times New Roman',serif`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(m[key],x,y+1);ctx.restore();
}
function findAspects(pos,orb){
  const out=[];const keys=GL.map(v=>v[0]);
  for(let i=0;i<keys.length;i++)for(let j=i+1;j<keys.length;j++){
    const d=dAng(pos[keys[i]],pos[keys[j]]);
    for(const t of ASP){const dd=Math.abs(d-t[1]);if(dd<=(orb||6)){out.push({p1:keys[i],p2:keys[j],type:t[0],orb:+dd.toFixed(2)});break}}
  }
  return out;
}
function drawChart(canvas,pos,h,{orb}={}){
  const ctx=canvas.getContext('2d'),W=canvas.width,H=canvas.height,cx=W/2,cy=H/2;
  ctx.clearRect(0,0,W,H);
  const labelsDiv=document.getElementById("labels"); labelsDiv.innerHTML=""; labelsDiv.style.transform=`translate(${cx}px,${cy}px)`;
  const R=Math.min(W,H)*0.46, bandR1=R-12, bandR2=R-86, houseR=bandR2-18;

  // 外輪（エメラルド）
  ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);
  const g=ctx.createLinearGradient(cx-R,cy-R,cx+R,cy+R);g.addColorStop(0,"#0c3a2f");g.addColorStop(.5,"#00b894");g.addColorStop(1,"#66ffcc");
  ctx.strokeStyle=g;ctx.lineWidth=22;ctx.stroke();

  // サイン帯（緑×濃緑）
  for(let i=0;i<12;i++){
    const lon=mod360(Math.floor(pos.ASC/30)*30 + i*30);
    const a0=((pos.ASC - lon + 180) * DEG), a1=((pos.ASC - (lon+30) + 180) * DEG);
    ctx.beginPath();ctx.arc(cx,cy,bandR1,a0,a1,true);ctx.arc(cx,cy,bandR2,a1,a0,false);ctx.closePath();
    ctx.fillStyle=(i%2)? "#10221b" : "#0f1c17";ctx.fill();
    const mid=((pos.ASC - (lon+15) + 180) * DEG);
    const rx=cx+(bandR1+bandR2)/2*Math.cos(mid), ry=cy+(bandR1+bandR2)/2*Math.sin(mid);
    drawSignGlyph(ctx,Math.floor(lon/30)%12,rx,ry,86,"#e4c878");
  }

  // ハウス線＋5°目盛
  const list=h.list||h;
  for(let i=0;i<12;i++){
    const cusp=list[i], a=((pos.ASC - cusp + 180) * DEG), x=cx+houseR*Math.cos(a),y=cy+houseR*Math.sin(a);
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(x,y);ctx.lineWidth=i===0?2.6:1;ctx.strokeStyle=i===0?"#e4c878":"#2f4a42";ctx.stroke();
    for(let d=5;d<30;d+=5){
      const aa=((pos.ASC - (cusp+d) + 180) * DEG); const r1=houseR-6, r2=houseR-(d%10===0?22:14);
      ctx.beginPath();ctx.moveTo(cx+r1*Math.cos(aa),cy+r1*Math.sin(aa));ctx.lineTo(cx+r2*Math.cos(aa),cy+r2*Math.sin(aa));
      ctx.lineWidth=1;ctx.strokeStyle="#2a5d4c";ctx.stroke();
      if(d%10===0){ctx.fillStyle="#9debcf";ctx.font="11px ui-monospace";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(String(d),cx+(r2-10)*Math.cos(aa),cy+(r2-10)*Math.sin(aa));}
    }
    ctx.fillStyle=i===0?"#e4c878":"#f6f6f6";ctx.font="bold 12px 'Times New Roman',serif";
    ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(i+1,cx+(houseR-14)*Math.cos(a),cy+(houseR-14)*Math.sin(a));
  }

  // 内輪
  const innerR=houseR-100;ctx.beginPath();ctx.arc(cx,cy,innerR,0,Math.PI*2);ctx.strokeStyle="#1f3b33";ctx.stroke();

  // 惑星配置（重なり回避）
  const keys=GL.map(x=>x[0]); const nodes=[], used=[];
  keys.forEach(k=>{const ang=((pos.ASC - pos[k] + 180) * DEG); let rr=houseR-18; for(const u of used){ if(Math.abs(ang-u)<(10*DEG)) rr-=14;} used.push(ang); nodes.push([k,ang,rr]); });

  // アスペクト
  const aspects=findAspects(pos,orb);
  aspects.forEach(a=>{
    const n1=nodes.find(n=>n[0]===a.p1), n2=nodes.find(n=>n[0]===a.p2);
    const p1={x:cx+innerR*Math.cos(n1[1]), y:cy+innerR*Math.sin(n1[1])};
    const p2={x:cx+innerR*Math.cos(n2[1]), y:cy+innerR*Math.sin(n2[1])};
    const info=ASP.find(s=>s[0]===a.type), col=info[3];
    const lw=a.type==="Conj"?3:2.2;
    ctx.strokeStyle=col; ctx.lineWidth=lw; ctx.globalAlpha=.95; ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); ctx.globalAlpha=1;
    const mx=(p1.x+p2.x)/2, my=(p1.y+p2.y)/2; ctx.fillStyle=col; ctx.font="bold 13px ui-monospace"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(info[4]+" "+info[5],mx,my);
  });

  // 惑星と度分ラベル
  nodes.forEach(n=>{
    const k=n[0], ang=n[1], rr=n[2], x=cx+rr*Math.cos(ang), y=cy+rr*Math.sin(ang);
    drawPlanetGlyph(ctx,k,x,y,26);
    const [sg,dm]=toDM(pos[k]);
    const el=document.createElement("div");el.className="badge";el.style.left=`${x}px`;el.style.top=`${y-26}px`;el.innerText=`${dm} ${sg}`;
    document.getElementById("labels").appendChild(el);
  });

  // 四軸
  [["ASC",h.asc??pos.ASC,"#66ffcc"],["MC",h.mc??pos.MC,"#e4c878"],["IC",h.ic??pos.IC,"#e4c878"],["DES",h.des??pos.DES,"#66ffcc"]]
    .forEach(([nm,lon,col])=>{
      const a=((pos.ASC - lon + 180) * DEG), x=cx+(bandR1-20)*Math.cos(a), y=cy+(bandR1-20)*Math.sin(a);
      ctx.fillStyle=col; ctx.font="bold 42px 'Times New Roman',serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(nm,x,y);
    });
}

/* ===== 表生成 ===== */
function buildTables(pos,h,aspList){
  const p = GL.map(([k,g])=>{const [sg,dm]=toDM(pos[k]);return `<tr><th>${g}</th><td>${sg}</td><td>${dm}</td></tr>`}).join("");
  document.getElementById("planetTbl").innerHTML=`<tr><th>天体</th><th>サイン</th><th>度分</th></tr>${p}`;
  const list=h.list||h; let tbl=`<tr><th>HOUSE</th><th>サイン</th><th>度分</th></tr>`;
  for(let i=0;i<12;i++){const [sg,dm]=toDM(list[i]);tbl+=`<tr><th>${i+1}</th><td>${sg}</td><td>${dm}</td></tr>`}
  const add=(lab,lon)=>{const [sg,dm]=toDM(lon);tbl+=`<tr><th>${lab}</th><td>${sg}</td><td>${dm}</td></tr>`}
  add("ASC",h.asc??pos.ASC); add("MC",h.mc??pos.MC); add("DES",h.des??pos.DES); add("IC",h.ic??pos.IC);
  document.getElementById("houseTbl").innerHTML=tbl;

  const b3=[[],[],[]], b4=[[],[],[],[]];
  GL.forEach(([k,g])=>{const s=Math.floor(pos[k]/30); b3[s%3].push(g); b4[Math.floor(s/3)].push(g);});
  document.getElementById("t3").innerHTML=`<tr><th>活動</th><th>不動</th><th>柔軟</th></tr>
    <tr><td>${b3[0].join(" ")||"—"}</td><td>${b3[1].join(" ")||"—"}</td><td>${b3[2].join(" ")||"—"}</td></tr>`;
  document.getElementById("t4").innerHTML=`<tr><th>火</th><th>地</th><th>風</th><th>水</th></tr>
    <tr><td>${b4[0].join(" ")||"—"}</td><td>${b4[1].join(" ")||"—"}</td><td>${b4[2].join(" ")||"—"}</td><td>${b4[3].join(" ")||"—"}</td></tr>`;

  let M=`<tr><th></th>${GL.map(p=>`<th>${p[1]}</th>`).join("")}</tr>`;
  for(let i=0;i<GL.length;i++){
    M+=`<tr><th>${GL[i][1]}</th>`;
    for(let j=0;j<GL.length;j++){
      if(j<=i){M+=`<td>—</td>`;continue;}
      const as=aspList.find(a=>a.p1===GL[i][0]&&a.p2===GL[j][0]);
      if(!as){M+=`<td></td>`;continue;}
      const info=ASP.find(x=>x[0]===as.type);
      M+=`<td title="orb ${as.orb}°">${info[4]}</td>`;
    }
    M+=`</tr>`;
  }
  document.getElementById("aspMatrix").innerHTML=M;

  const groups={Conj:[],Sext:[],Square:[],Trine:[],Inc:[],Opp:[]};
  aspList.forEach(a=>groups[a.type].push(a));
  const lab=t=>ASP.find(x=>x[0]===t)[4]; let html="";
  [["Conj","コンジャンクション"],["Sext","セクスタイル"],["Square","スクエア"],["Trine","トライン"],["Inc","インコンジャンクト"],["Opp","オポジション"]]
    .forEach(([k,ja])=>{
      html+=`<h4>${lab(k)} ${ja}</h4><ul>`;
      if(groups[k].length===0) html+=`<li>なし</li>`;
      groups[k].forEach(a=>{const g1=GL.find(p=>p[0]===a.p1)[1],g2=GL.find(p=>p[0]===a.p2)[1];html+=`<li>${g1} ${lab(k)} ${g2}（orb ${a.orb}°）</li>`});
      html+=`</ul>`;
    });
  document.getElementById("aspLists").innerHTML=html;
}

/* ===== AI 総評 ===== */
function aiReport(pos,h,name){
  const sign=(lon)=>Math.floor(mod360(lon)/30);
  const element=(s)=>["火","地","風","水"][Math.floor(s/3)];
  const modality=(s)=>["活動","不動","柔軟"][s%3];
  const list=(a)=>a.map(x=>"・"+x).join("\n");
  const el=element(sign(pos.Sun)), md=modality(sign(pos.Sun));
  const love=[`金星と火星の歩調を合わせると恋のテンポが安定。`,`月の安心導線（生活リズム）を整えると関係が育つ。`,`7Hの雰囲気に合わせ、距離感と連絡頻度を最初に合意すると齟齬が減る。`];
  const work=[`太陽×土星×10Hで役割を固定。${md==="活動"?"短期決戦で成果化":"中長期で資産化"}を意識。`,`水星の強み（言語化or可視化）で共有を先行。`,`木星領域に週次の学習投資。定点観測をログ化し信用を積む。`];
  const future=[`主調は「${el}×${md}」。半年テーマを一語で設定し選択軸を通す。`,`拡大期は木星と協調、課題期は土星に合わせ手順化で越える。`,`休息を計画内に組み込み、安定稼働を守る。`];
  const syn=[`相性は月と金星の相互作用が土台。同系は摩擦少、異系は“リズムの約束”で長期化。`,`衝突角は役割差。分担と期待値を先に言語化すると推進力に転換。`,`共有資源（時間/お金/空間）はルール先行が吉。`];
  const move=[`引越しは月の要素に合う街を選ぶと適応が速い。`,`契約は木星の良角期が滑らか。`,`ASC支配星の動線を整えると生活満足度が上がる。`];
  const change=[`転職は太陽×木星（拡大）/土星（地固め）の局面判断で。`,`履歴書は水星の強みを前面に。`,`入社後90日プランを先に提示し期待値を整える。`];
  const vocation=[`適職は太陽×10H×土星。役割の明確化と継続運用が成果を積む。`,`副業は木星領域で伸びやすい。`,`仕組み化（手順書/テンプレ/自動化）が将来の自由度を増やす。`];
  const strengths=[`決断と初動が速い`,`学習曲線が急`,`対人の調整力が高い`];
  const weaknesses=[`抱え込みやすい`,`完璧主義に偏りがち`,`中間共有が遅れると周囲が動きづらい`];
  return [
    `【総評】${name||"ご本人"}は「${el}×${md}」基調。日々の選択をこの組合せで最適化するとブレが減ります。`,
    `— 恋愛 —\n${list(love)}`,
    `— 仕事 —\n${list(work)}`,
    `— 未来計画 —\n${list(future)}`,
    `— 相性 —\n${list(syn)}`,
    `— 引っ越し時期 —\n${list(move)}`,
    `— 転職時期 —\n${list(change)}`,
    `— 適職 —\n${list(vocation)}`,
    `— 長所 —\n${list(strengths)}`,
    `— 短所 —\n${list(weaknesses)}`
  ].join("\n\n");
}

/* ===== 実行系 ===== */
function metaFromInputs(){
  const d=parseCompactDate(document.getElementById("dateCompact").value);
  const t=parseCompactTime(document.getElementById("timeCompact").value);
  const lat=+document.getElementById("lat").value,lon=+document.getElementById("lon").value;
  const tz=+document.getElementById("tz").value,dst=+document.getElementById("dst").value;
  if(!isFinite(lat)||!isFinite(lon)) throw "緯度経度を入力してください";
  const jd=jdFromYMD(d.y,d.m,d.d,t.hh,t.mi,tz,dst);
  return {...d,...t,lat,lon,tz,dst,jd};
}

// 地名検索は無効（常に手入力方式）
document.getElementById("geo").onclick=()=>alert("地名検索は安定版では無効です。緯度・経度を手入力してください。");

document.getElementById("calcAsc").onclick=()=>{try{
  const M=metaFromInputs(); const a=ascMcFrom(M.jd,M.lat,M.lon);
  alert(`ASC ${a.ASC.toFixed(2)}° / MC ${a.MC.toFixed(2)}°`);
}catch(e){alert(e)}};

document.getElementById("run").onclick=()=>{try{
  const M=metaFromInputs(); const A=ascMcFrom(M.jd,M.lat,M.lon);

  // 惑星
  const pos={ASC:A.ASC,MC:A.MC,IC:A.IC,DES:A.DES};
  Object.assign(pos,{Sun:LON.Sun(M.jd),Moon:LON.Moon(M.jd),Mercury:LON.Mercury(M.jd),Venus:LON.Venus(M.jd),
    Mars:LON.Mars(M.jd),Jupiter:LON.Jupiter(M.jd),Saturn:LON.Saturn(M.jd),
    Uranus:LON.Uranus(M.jd),Neptune:LON.Neptune(M.jd),Pluto:LON.Pluto(M.jd)});

  // ハウス
  const mode=document.getElementById("house").value; let H, note="";
  if(mode==="placidus"){const r=placidusCuspsSafe(A);H={list:r.list,asc:A.ASC,mc:A.MC,des:A.DES,ic:A.IC};note=r.note;}
  else if(mode==="equal"){H={list:Houses.equal(A.ASC),asc:A.ASC,mc:A.MC,des:A.DES,ic:A.IC};note="Equal";}
  else{H={list:Houses.whole(A.ASC),asc:A.ASC,mc:A.MC,des:A.DES,ic:A.IC};note="Whole Sign";}
  document.getElementById("modeNote").textContent=`ハウス方式：${note}`;

  const orb=+document.getElementById("orb").value||6;
  drawChart(document.getElementById("cv"),pos,H,{orb});
  const aspects=findAspects(pos,orb);
  buildTables(pos,H,aspects);

  const nm=document.getElementById("name").value||"—";
  document.getElementById("sum_name").textContent=nm;
  document.getElementById("sum_place").textContent=document.getElementById("place").value||`${M.lat.toFixed(3)}, ${M.lon.toFixed(3)}`;
  document.getElementById("sum_date").textContent=`${M.y}-${String(M.m).padStart(2,"0")}-${String(M.d).padStart(2,"0")}  ${String(M.hh).padStart(2,"0")}:${String(M.mi).padStart(2,"0")}`;
  document.getElementById("report").value=aiReport(pos,H,nm);
}catch(e){alert(e)}};
</script>
</body>
</html>
