<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Horoscope PRO – Dark Classic</title>
<style>
:root{
  /* ===== Dark palette (高コントラスト) ===== */
  --bg:#0f1317;         /* 背景 */
  --paper:#151a21;      /* カード/盤 背 */
  --ink:#e9edf2;        /* 文字 色 */
  --muted:#a3b0be;      /* 補助文字 */
  --line:#2a3340;       /* 罫線 */

  --band:#1b232c;       /* サイン帯1 */
  --band2:#212b37;      /* サイン帯2 */
  --tick:#334155;       /* 目盛線 */

  --sign:#82b7ff;       /* サイン線画 */
  --axisA:#e2b714;      /* ASC/DES */
  --axisM:#ee6666;      /* MC/IC */

  /* aspect colors */
  --sq:#ff6b6b;
  --tr:#6aa8ff;
  --se:#57d88a;
  --op:#e7b74b;
  --cj:#e9edf2;
  --inc:#b08cff;

  --badge:#0e1115;      /* ラベル背景 */
  --badgeBorder:#334155;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 "Noto Serif JP","Hiragino Mincho ProN","Yu Mincho","Times New Roman",serif}
.container{max-width:1220px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:rgba(15,19,23,.8);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20}
h1{margin:6px 0;font-size:20px}
.small{color:var(--muted);font-size:12px}
.grid{display:grid;gap:16px}
@media(min-width:1080px){.grid{grid-template-columns:430px 1fr}}
.card{background:var(--paper);border:1px solid var(--line);border-radius:14px;padding:14px}
label{font-size:12px;color:var(--muted)}
input,select,button,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f141a;color:var(--ink)}
input:focus,select:focus,textarea:focus{outline:2px solid #334155}
.btn{cursor:pointer;background:#0f141a}
.btn-ac{background:#2b4866;color:#fff;border-color:#2b4866}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.help{font-size:12px;color:var(--muted)}
h3{margin:6px 0 10px;font-size:16px}
canvas{width:100%;height:auto;background:#0e151c;border:1px solid var(--line);border-radius:12px}
.meta{display:grid;grid-template-columns:120px 1fr;gap:8px;margin-top:10px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--line);padding:8px 10px;text-align:center}
.ribbon{display:inline-block;background:#1f2e3f;color:#bfe1ff;padding:6px 14px;border-radius:10px 10px 0 0;margin:-14px 0 6px}
.flex{display:flex;gap:6px;align-items:center}
.badge{position:absolute;transform:translate(-50%,-50%);background:var(--badge);border:1px solid var(--badgeBorder);border-radius:8px;padding:2px 6px;font:12px ui-monospace;color:#cfe7ff;white-space:nowrap}
.section{background:var(--paper);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:14px}
.kv{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);margin:2px 4px 0 0}
.err{border-color:#ff6b6b}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>Horoscope PRO – Dark Classic</h1>
    <div class="small">ダーク配色／円盤＋表（3区分・4区分・天体・ハウス・アスペクト）／AI総評／地名→緯度経度（二段ジオコーディング）／連番入力対応</div>
  </div>
</header>

<main class="container grid">
  <!-- 入力 -->
  <section class="card">
    <span class="ribbon">入力</span>
    <div class="row" style="margin-top:8px">
      <div><label>氏名</label><input id="name" placeholder="例：鑑定Aさん"></div>
      <div>
        <label>出生地（地名→緯度経度）</label>
        <div class="flex"><input id="place" placeholder="例：名古屋市"><button id="geo" class="btn">地名検索</button></div>
        <div class="help">※ヒットしづらい場合は市区町村まで</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div>
        <label>生年月日（連番）</label>
        <input id="dateCompact" placeholder="1989531 または 19890531">
        <div class="help">7桁：YYYYMDD（1989531=1989/5/31）/ 8桁：YYYYMMDD（19890531）</div>
      </div>
      <div>
        <label>出生時刻（連番・任意）</label>
        <input id="timeCompact" placeholder="例：1230（=12:30）未入力=12:00">
        <div class="help">4桁：HHMM（0735/1820 等）</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div><label>緯度</label><input id="lat" type="number" step="0.0001" placeholder="35.1815"></div>
      <div><label>経度</label><input id="lon" type="number" step="0.0001" placeholder="136.9066"></div>
    </div>
    <div class="row">
      <div><label>UTC（日本=9）</label><input id="tz" type="number" value="9" step="0.25"></div>
      <div><label>DST</label><select id="dst"><option value="0">なし</option><option value="1">+1h</option></select></div>
    </div>
    <div class="row">
      <div><label>ハウス方式</label><select id="house"><option value="whole">Whole Sign</option><option value="equal">Equal</option></select></div>
      <div><label>アスペクト Orb（度）</label><input id="orb" type="number" value="6" step="0.5"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="calcAsc">Asc/MC 計算</button>
      <button class="btn-ac" id="run">鑑定を作成</button>
    </div>
    <div class="help" style="margin-top:6px">ASCは左（9時）固定。ハウスは反時計回り 1→12。円盤は各ハウス5°目盛。</div>
  </section>

  <!-- 円盤 -->
  <section class="card">
    <span class="ribbon">ホロスコープ</span>
    <div style="position:relative;margin-top:8px">
      <canvas id="cv" width="1200" height="1200"></canvas>
      <div id="labels"></div>
    </div>

    <div class="meta">
      <div>NAME</div><div id="sum_name">—</div>
      <div>DATE</div><div id="sum_date">—</div>
      <div>PLACE</div><div id="sum_place">—</div>
    </div>
  </section>
</main>

<!-- 表 -->
<section class="container section">
  <div class="kv">
    <div class="card">
      <span class="ribbon">3区分</span>
      <table class="table" id="t3"></table>
    </div>
    <div class="card">
      <span class="ribbon">4区分</span>
      <table class="table" id="t4"></table>
    </div>
    <div class="card">
      <span class="ribbon">凡例</span>
      <div class="small">
        <div class="tag">☌ Conjunction</div>
        <div class="tag">⚹ Sextile</div>
        <div class="tag">□ Square</div>
        <div class="tag">△ Trine</div>
        <div class="tag">⚻ Quincunx</div>
        <div class="tag">☍ Opposition</div>
      </div>
    </div>
  </div>
</section>

<section class="container section">
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card">
      <span class="ribbon">天体</span>
      <table class="table" id="planetTbl"></table>
    </div>
    <div class="card">
      <span class="ribbon">ハウス・カスプ</span>
      <table class="table" id="houseTbl"></table>
    </div>
  </div>
</section>

<section class="container section">
  <div class="card">
    <span class="ribbon">アスペクト（格子マトリクス）</span>
    <table class="table" id="aspMatrix"></table>
  </div>
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card">
      <span class="ribbon">アスペクト一覧</span>
      <div id="aspLists" class="small"></div>
    </div>
    <div class="card">
      <span class="ribbon">AI 自動総評（各分野3行＋長所/短所）</span>
      <textarea id="report" style="min-height:360px;width:100%"></textarea>
    </div>
  </div>
</section>

<footer class="container small" style="text-align:center;margin:28px 0;color:var(--muted)">© Horoscope PRO</footer>

<script>
/* ================= 基本定数 ================= */
const DEG=Math.PI/180, SIGNS=["牡羊","牡牛","双子","蟹","獅子","乙女","天秤","蠍","射手","山羊","水瓶","魚"];
const GL=[["Sun","☉"],["Moon","☽"],["Mercury","☿"],["Venus","♀"],["Mars","♂"],["Jupiter","♃"],["Saturn","♄"],["Uranus","♅"],["Neptune","♆"],["Pluto","♇"]];
const ASP=[["Conj",0,8,"var(--cj)","☌","0°"],["Sext",60,5,"var(--se)","⚹","60°"],["Square",90,6,"var(--sq)","□","90°"],["Trine",120,7,"var(--tr)","△","120°"],["Inc",150,4.5,"var(--inc)","⚻","150°"],["Opp",180,8,"var(--op)","☍","180°"]];
function mod360(x){x%=360; if(x<0)x+=360; return x}
function dAng(a,b){let d=Math.abs(a-b)%360; return d>180?360-d:d}

/* ========= 天文（簡易） ========= */
function jdFromYMD(y,m,d,hh=0,mi=0){ if(m<=2){y--;m+=12} const A=Math.floor(y/100),B=2-A+Math.floor(A/4),day=d+(hh+mi/60)/24; return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+day+B-1524.5;}
function obliqDeg(jd){const T=(jd-2451545.0)/36525;return 23+26/60+21.448/3600-(46.8150*T+0.00059*T*T-0.001813*T*T*T)/3600}
function gstDeg(jd){const T=(jd-2451545.0)/36525;return mod360(280.46061837+360.98564736629*(jd-2451545.0)+0.000387933*T*T-(T*T*T)/38710000)}
function ascMcFrom(jd,latDeg,lonDeg){
  const eps=obliqDeg(jd)*DEG, lst=gstDeg(jd)*DEG+lonDeg*DEG, phi=latDeg*DEG;
  let Lmc=Math.atan2(Math.sin(lst)*Math.cos(eps),Math.cos(lst)); Lmc=mod360(Lmc/DEG);
  const sinE=Math.sin(eps),cosE=Math.cos(eps),tanPhi=Math.tan(phi),sinL=Math.sin(lst),cosL=Math.cos(lst);
  let Lasc=Math.atan2(-cosL, sinL*cosE - tanPhi*sinE); Lasc=mod360(Lasc/DEG);
  return {ASC:Lasc,MC:Lmc,IC:mod360(Lmc+180),DES:mod360(Lasc+180)};
}
function Tcent(jd){return (jd-2451545.0)/36525}
function sunLon(jd){const T=Tcent(jd); const L0=mod360(280.46646+36000.76983*T+0.0003032*T*T); const M=mod360(357.52911+35999.05029*T-0.0001537*T*T)*DEG; const C=(1.914602-0.004817*T-0.000014*T*T)*Math.sin(M)+(0.019993-0.000101*T)*Math.sin(2*M)+0.000289*Math.sin(3*M); return mod360(L0+C);}
function moonLon(jd){const T=Tcent(jd), L0=mod360(218.3164477+481267.88123421*(jd-2451545)/36525); const M=mod360(134.9633964+477198.8675055*(jd-2451545)/36525)*DEG; const D=mod360(297.8501921+445267.1114034*(jd-2451545)/36525)*DEG; return mod360(L0 + 6.289*Math.sin(M) + 1.274*Math.sin(2*D - M) + 0.658*Math.sin(2*D) + 0.214*Math.sin(2*M) + 0.11*Math.sin(D));}
function planetMean(name){const n={Mercury:4.09233445,Venus:1.60213034,Mars:0.524039,Jupiter:0.0830867,Saturn:0.03344414,Uranus:0.0117696,Neptune:0.0060201,Pluto:0.0039640};
  const L0={Mercury:252.2509,Venus:181.9798,Mars:355.4330,Jupiter:34.3515,Saturn:50.0774,Uranus:314.0550,Neptune:304.3487,Pluto:238.9290};
  return jd=>mod360(L0[name]+n[name]*(jd-2451545.0));
}
const LON={Sun:jd=>sunLon(jd), Moon:jd=>moonLon(jd), Mercury:planetMean("Mercury"),Venus:planetMean("Venus"),Mars:planetMean("Mars"),Jupiter:planetMean("Jupiter"),Saturn:planetMean("Saturn"),Uranus:planetMean("Uranus"),Neptune:planetMean("Neptune"),Pluto:planetMean("Pluto")};

/* ====== ハウス ====== */
const Houses={ whole(asc){const s=Math.floor(asc/30);return[...Array(12)].map((_,i)=>mod360((s+i)*30))}, equal(asc){return[...Array(12)].map((_,i)=>mod360(asc+i*30))} };

/* ====== 地名→緯度経度（2段フェールオーバー） ====== */
async function geocodeNominatim(q){
  const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
  const r=await fetch(url,{headers:{'Accept-Language':'ja'}});
  if(!r.ok) throw new Error("nominatim fail");
  const js=await r.json();
  if(!js?.[0]) throw new Error("not found");
  return {lat:+js[0].lat, lon:+js[0].lon, provider:"nominatim"};
}
async function geocodeOpenMeteo(q){
  const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=ja&format=json`;
  const r=await fetch(url);
  if(!r.ok) throw new Error("open-meteo fail");
  const js=await r.json();
  if(!js?.results?.[0]) throw new Error("not found");
  const a=js.results[0]; return {lat:+a.latitude, lon:+a.longitude, provider:"open-meteo"};
}
async function geocodeSmart(q){
  if(!q) throw new Error("地名が空です");
  try{ return await geocodeNominatim(q); }catch(_){ return await geocodeOpenMeteo(q); }
}
document.getElementById("geo").onclick=async()=>{
  const q=document.getElementById("place").value.trim();
  if(!q) return alert("地名を入れてください");
  try{
    const g=await geocodeSmart(q);
    document.getElementById("lat").value=g.lat;
    document.getElementById("lon").value=g.lon;
    alert(`緯度経度を取得：${g.lat.toFixed(4)}, ${g.lon.toFixed(4)}（${g.provider}）`);
  }catch(e){ alert("見つかりませんでした"); }
}

/* ====== 角度マッピング（ASC左=9時, 反時計） ====== */
function angFor(longitude, ASC){ return ((ASC - longitude + 180) * DEG); }

/* ====== サイン描画（線画） ====== */
function drawSignGlyph(ctx, idx, x, y, s, col=getCSS("--sign")){
  ctx.save(); ctx.translate(x,y); ctx.strokeStyle=col; ctx.lineWidth=Math.max(2.0, s*0.06); ctx.lineCap="round"; ctx.lineJoin="round";
  const r=s*0.42;
  if(idx===0){ctx.beginPath();ctx.arc(-r*0.5,0,r*0.5,Math.PI*0.9,Math.PI*1.8);ctx.moveTo(-r*0.1,-r*0.6);ctx.quadraticCurveTo(0,-r*0.2,0,r*0.6);ctx.moveTo(r*0.1,-r*0.6);ctx.quadraticCurveTo(0,-r*0.2,0,r*0.6);ctx.stroke();}
  else if(idx===1){ctx.beginPath();ctx.arc(0,r*0.2,r*0.45,0,Math.PI*2);ctx.moveTo(-r*0.45,-r*0.2);ctx.quadraticCurveTo(-r*0.8,-r*0.6,-r*0.4,-r*0.65);ctx.moveTo(r*0.45,-r*0.2);ctx.quadraticCurveTo(r*0.8,-r*0.6,r*0.4,-r*0.65);ctx.stroke();}
  else if(idx===2){ctx.beginPath();ctx.moveTo(-r*0.5,-r*0.75);ctx.lineTo(r*0.5,-r*0.75);ctx.moveTo(-r*0.5,r*0.75);ctx.lineTo(r*0.5,r*0.75);ctx.moveTo(-r*0.3,-r*0.65);ctx.lineTo(-r*0.3,r*0.65);ctx.moveTo(r*0.3,-r*0.65);ctx.lineTo(r*0.3,r*0.65);ctx.stroke();}
  else if(idx===3){ctx.beginPath();ctx.arc(-r*0.35,-r*0.1,r*0.28,0,Math.PI*2);ctx.arc(r*0.35,r*0.1,r*0.28,0,Math.PI*2);ctx.moveTo(-r*0.1,-r*0.2);ctx.quadraticCurveTo(0,0,r*0.1,r*0.2);ctx.moveTo(r*0.1,r*0.2);ctx.quadraticCurveTo(0,0,-r*0.1,-r*0.2);ctx.stroke();}
  else if(idx===4){ctx.beginPath();ctx.arc(-r*0.1,0,r*0.5,Math.PI*0.1,Math.PI*1.6);ctx.moveTo(r*0.2,-r*0.2);ctx.quadraticCurveTo(r*0.6,0,r*0.35,r*0.55);ctx.stroke();}
  else if(idx===5){ctx.beginPath();ctx.moveTo(-r*0.6,r*0.7);ctx.lineTo(-r*0.6,-r*0.7);ctx.quadraticCurveTo(-r*0.2,-r*0.45,0,-r*0.7);ctx.lineTo(0,r*0.7);ctx.moveTo(0,-r*0.15);ctx.quadraticCurveTo(r*0.35,0,r*0.2,r*0.55);ctx.stroke();}
  else if(idx===6){ctx.beginPath();ctx.moveTo(-r*0.8,r*0.35);ctx.lineTo(r*0.8,r*0.35);ctx.moveTo(-r*0.8,0.05);ctx.arc(0,0,r*0.52,Math.PI,0);ctx.stroke();}
  else if(idx===7){ctx.beginPath();ctx.moveTo(-r*0.6,r*0.7);ctx.lineTo(-r*0.6,-r*0.7);ctx.quadraticCurveTo(-r*0.2,-r*0.45,0,-r*0.7);ctx.lineTo(0,r*0.7);ctx.moveTo(0,-r*0.1);ctx.quadraticCurveTo(r*0.45,0,r*0.38,r*0.4);ctx.lineTo(r*0.6,r*0.2);ctx.moveTo(r*0.38,r*0.4);ctx.lineTo(r*0.7,r*0.5);ctx.stroke();}
  else if(idx===8){ctx.beginPath();ctx.moveTo(-r*0.55,r*0.55);ctx.lineTo(r*0.7,-r*0.7);ctx.moveTo(r*0.3,-r*0.7);ctx.lineTo(r*0.7,-r*0.7);ctx.lineTo(r*0.7,-r*0.3);ctx.stroke();}
  else if(idx===9){ctx.beginPath();ctx.moveTo(-r*0.55,-r*0.1);ctx.quadraticCurveTo(0,-r*0.7,r*0.45,-r*0.1);ctx.quadraticCurveTo(r*0.18,r*0.25,-r*0.25,0);ctx.moveTo(-r*0.25,0);ctx.quadraticCurveTo(-r*0.06,r*0.55,r*0.28,r*0.42);ctx.stroke();}
  else if(idx===10){ctx.beginPath();ctx.moveTo(-r*0.85,-r*0.18);for(let i=0;i<3;i++){ctx.lineTo(-r*0.45+i*r*0.42,-r*0.4);ctx.lineTo(0+i*r*0.42,-r*0.18);}ctx.moveTo(-r*0.85,r*0.3);for(let i=0;i<3;i++){ctx.lineTo(-r*0.45+i*r*0.42,0.05);ctx.lineTo(0+i*r*0.42,r*0.3);}ctx.stroke();}
  else{ctx.beginPath();ctx.moveTo(-r*0.65,-r*0.45);ctx.quadraticCurveTo(-r*0.25,0,-r*0.65,r*0.45);ctx.moveTo(r*0.65,-r*0.45);ctx.quadraticCurveTo(r*0.25,0,r*0.65,r*0.45);ctx.moveTo(-r*0.72,0);ctx.lineTo(r*0.72,0);ctx.stroke();}
  ctx.restore();
}
function getCSS(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim()}

/* ====== 円盤描画 ====== */
function drawChart(canvas,pos,houses,{orb}={}){
  const ctx=canvas.getContext('2d'), W=canvas.width, H=canvas.height, cx=W/2, cy=H/2;
  ctx.clearRect(0,0,W,H); const labelsDiv=document.getElementById("labels"); labelsDiv.innerHTML="";
  const R=Math.min(W,H)*0.46, bandR1=R-12, bandR2=R-86, houseR=bandR2-18;

  // 外輪
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.strokeStyle="#2b3644"; ctx.lineWidth=22; ctx.stroke();

  // サイン帯
  for(let i=0;i<12;i++){
    const lon=mod360(Math.floor(pos.ASC/30)*30 + i*30);
    const a0=angFor(lon,pos.ASC), a1=angFor(mod360(lon+30),pos.ASC);
    ctx.beginPath(); ctx.arc(cx,cy,bandR1,a0,a1,true); ctx.arc(cx,cy,bandR2,a1,a0,false); ctx.closePath();
    ctx.fillStyle= (i%2)? getCSS("--band") : getCSS("--band2"); ctx.fill();
    const mid=angFor(mod360(lon+15), pos.ASC);
    const rx=cx+(bandR1+bandR2)/2*Math.cos(mid), ry=cy+(bandR1+bandR2)/2*Math.sin(mid);
    drawSignGlyph(ctx, Math.floor(lon/30)%12, rx, ry, 86, getCSS("--sign"));
  }

  // ハウス線と5°目盛
  for(let i=0;i<12;i++){
    const cusp=houses[i], a=angFor(cusp, pos.ASC), x=cx+houseR*Math.cos(a), y=cy+houseR*Math.sin(a);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.lineWidth=i===0?2.6:1; ctx.strokeStyle=i===0?getCSS("--sign"):getCSS("--tick"); ctx.stroke();
    for(let d=5; d<30; d+=5){
      const aa=angFor(mod360(cusp+d),pos.ASC); const r1=houseR-6, r2=houseR-(d%10===0?22:14);
      ctx.beginPath(); ctx.moveTo(cx+r1*Math.cos(aa), cy+r1*Math.sin(aa)); ctx.lineTo(cx+r2*Math.cos(aa), cy+r2*Math.sin(aa));
      ctx.lineWidth=1; ctx.strokeStyle="#3a4758"; ctx.stroke();
      if(d%10===0){ ctx.fillStyle="#8aa2bf"; ctx.font="11px ui-monospace"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(String(d), cx+(r2-10)*Math.cos(aa), cy+(r2-10)*Math.sin(aa));}
    }
    ctx.fillStyle=i===0?getCSS("--sign"):"#8aa2bf"; ctx.font="bold 12px 'Times New Roman',serif";
    ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(i+1, cx+(houseR-14)*Math.cos(a), cy+(houseR-14)*Math.sin(a));
  }

  // 内輪
  const innerR=houseR-100; ctx.beginPath(); ctx.arc(cx,cy,innerR,0,Math.PI*2); ctx.strokeStyle="#2b3747"; ctx.stroke();

  // 惑星位置（重なり回避）
  const order=GL.map(x=>x[0]); const nodes=[], used=[];
  order.forEach(k=>{const ang=angFor(pos[k],pos.ASC); let rr=houseR-18; for(const u of used){ if(Math.abs(ang-u)<(10*DEG)) rr-=14;} used.push(ang); nodes.push([k,ang,rr]); });

  // アスペクト
  const aspects=findAspects(pos,orb);
  aspects.forEach(a=>{
    const n1=nodes.find(n=>n[0]===a.p1), n2=nodes.find(n=>n[0]===a.p2);
    const p1={x:cx+innerR*Math.cos(n1[1]), y:cy+innerR*Math.sin(n1[1])};
    const p2={x:cx+innerR*Math.cos(n2[1]), y:cy+innerR*Math.sin(n2[1])};
    const css=getComputedStyle(document.documentElement), col=css.getPropertyValue(ASP.find(s=>s[0]===a.type)[3].replace("var","")).trim()||"#e9edf2";
    ctx.strokeStyle=col; ctx.lineWidth= a.type==="Conj"?3:2.2; ctx.globalAlpha=.95; ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); ctx.globalAlpha=1;
    const mx=(p1.x+p2.x)/2, my=(p1.y+p2.y)/2; ctx.fillStyle=col; ctx.font="bold 13px ui-monospace"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(ASP.find(s=>s[0]===a.type)[4]+" "+ASP.find(s=>s[0]===a.type)[5],mx,my);
  });

  // 惑星ピン＋度数ラベル
  const labelsDiv=document.getElementById("labels"); labelsDiv.style.position="absolute"; labelsDiv.style.left=cx+"px"; labelsDiv.style.top=cy+"px";
  nodes.forEach(n=>{
    const k=n[0], ang=n[1], rr=n[2], x=cx+rr*Math.cos(ang), y=cy+rr*Math.sin(ang);
    // ピン
    ctx.beginPath(); ctx.arc(x,y,25,0,Math.PI*2); ctx.fillStyle="#0e141b"; ctx.fill(); ctx.strokeStyle="#3a4758"; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle="#e9edf2"; ctx.font="bold 30px 'Times New Roman',serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(GL.find(g=>g[0]===k)[1], x, y);
    // ラベル
    const deg=mod360(pos[k]); const d=Math.floor(deg%30), m=Math.floor((deg%1)*60), sign=SIGNS[Math.floor(deg/30)];
    const div=document.createElement('div'); div.className='badge'; div.textContent=`${GL.find(g=>g[0]===k)[1]} ${String(d).padStart(2,'0')}°${String(m).padStart(2,'0')}′ ${sign}`;
    let bx=x+Math.cos(ang)*34, by=y+Math.sin(ang)*34; const placed=[...labelsDiv.querySelectorAll('.badge')];
    let tries=0; const bump=12;
    function col(nx,ny,el){const r=el.getBoundingClientRect(); const w=r.width,h=r.height; return Math.abs(nx-+el.dataset.x)<w && Math.abs(ny-+el.dataset.y)<h;}
    while(placed.some(el=>col(bx,by,el)) && tries<20){ bx+=Math.cos(ang)*bump; by+=Math.sin(ang)*bump; tries++; }
    div.style.left=bx+"px"; div.style.top=by+"px"; div.dataset.x=bx; div.dataset.y=by; labelsDiv.appendChild(div);
  });

  // 四軸
  [["ASC",getCSS("--axisA")],["MC",getCSS("--axisM")],["IC",getCSS("--axisM")],["DES",getCSS("--axisA")]].forEach(([k,col])=>{
    const a=angFor(pos[k],pos.ASC), rr=houseR-16; const x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a);
    ctx.fillStyle=col; ctx.font="bold 36px 'Times New Roman',serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(k, x, y);
  });
}

/* ====== ロジック ====== */
function findAspects(pos,orb){
  const pts=Object.keys(pos).filter(k=>!["ASC","MC","IC","DES"].includes(k));
  const out=[]; for(let i=0;i<pts.length;i++){for(let j=i+1;j<pts.length;j++){
    const A=pos[pts[i]],B=pos[pts[j]]; const d=dAng(A,B);
    ASP.forEach(s=>{if(Math.abs(d-s[1])<= (orb??s[2])) out.push({p1:pts[i],p2:pts[j],type:s[0],deg:s[1],delta:(d-s[1])})});
  }} return out;
}
function elementOf(deg){const s=Math.floor(mod360(deg)/30); return [0,4,8].includes(s)?"火":[1,5,9].includes(s)?"地":[2,6,10].includes(s)?"風":"水"}
function modalityOf(deg){const s=Math.floor(mod360(deg)/30); return [0,3,6,9].includes(s)?"活動":[1,4,7,10].includes(s)?"不動":"柔軟"}

/* ====== 表 ====== */
function build3_4(pos){
  const who=["Sun","Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto"];
  const g = name => GL.find(x=>x[0]===name)[1];
  const byEl={火:[],地:[],風:[],水:[]}, byMd={活動:[],不動:[],柔軟:[]};
  who.forEach(k=>{byEl[elementOf(pos[k])].push(g(k)); byMd[modalityOf(pos[k])].push(g(k));});
  document.getElementById("t3").innerHTML = `
    <tr><th>活動</th><th>不動</th><th>柔軟</th></tr>
    <tr><td>${byMd.活動.join(" ")||"—"}</td><td>${byMd.不動.join(" ")||"—"}</td><td>${byMd.柔軟.join(" ")||"—"}</td></tr>`;
  document.getElementById("t4").innerHTML = `
    <tr><th>火</th><th>地</th><th>風</th><th>水</th></tr>
    <tr><td>${byEl.火.join(" ")||"—"}</td><td>${byEl.地.join(" ")||"—"}</td><td>${byEl.風.join(" ")||"—"}</td><td>${byEl.水.join(" ")||"—"}</td></tr>`;
}
function buildPlanetTable(pos){
  const rows=GL.map(([k,s])=>{
    const d=mod360(pos[k]); const dd=Math.floor(d%30), mm=Math.floor((d%1)*60), si=SIGNS[Math.floor(d/30)];
    return `<tr><td>${s}</td><td>${si}</td><td>${String(dd).padStart(2,'0')}° ${String(mm).padStart(2,'0')}′</td></tr>`
  }).join("");
  document.getElementById("planetTbl").innerHTML=`<tr><th>天体</th><th>サイン</th><th>度数</th></tr>${rows}`;
}
function buildHouseTable(houses,pos){
  const names=[...Array(12)].map((_,i)=>`${i+1}ハウス`);
  const rows=names.map((nm,i)=>{
    const deg=houses[i]; const si=SIGNS[Math.floor(deg/30)]; const dd=Math.floor(deg%30), mm=Math.floor((deg%1)*60);
    return `<tr><td>${nm}</td><td>${si}</td><td>${String(dd).padStart(2,'0')}° ${String(mm).padStart(2,'0')}′</td></tr>`;
  }).join("");
  const add=(label,deg)=>{const si=SIGNS[Math.floor(deg/30)], dd=Math.floor(deg%30), mm=Math.floor((deg%1)*60); return `<tr><td>${label}</td><td>${si}</td><td>${String(dd).padStart(2,'0')}° ${String(mm).padStart(2,'0')}′</td></tr>`}
  document.getElementById("houseTbl").innerHTML=`<tr><th>項目</th><th>サイン</th><th>度数</th></tr>${rows}${add("ASC",pos.ASC)}${add("MC",pos.MC)}${add("DES",pos.DES)}${add("IC",pos.IC)}`;
}
function buildMatrix(table,pos,orb){
  const K=GL.map(x=>x[0]); const G=Object.fromEntries(GL.map(x=>[x[0],x[1]]));
  let h=`<tr><th></th>${K.map(k=>`<th>${G[k]}</th>`).join("")}</tr>`;
  for(let i=0;i<K.length;i++){h+=`<tr><th>${G[K[i]]}</th>`; for(let j=0;j<K.length;j++){
    if(j<=i){h+=`<td style="background:#121822"></td>`; continue;}
    const a=findAspects({[K[i]]:pos[K[i]],[K[j]]:pos[K[j]]},orb)[0]; h+=`<td>${a?ASP.find(s=>s[0]===a.type)[4]:""}</td>`; } h+=`</tr>`;}
  table.innerHTML=h;
}
function buildAspectLists(pos,orb){
  const list=findAspects(pos,orb);
  const G=Object.fromEntries(GL.map(x=>[x[0],x[1]]));
  const block = (title,types)=> {
    const items=list.filter(x=>types.includes(x.type)).map(x=>{
      const orb=Math.abs(Math.round(x.delta*10)/10);
      return `${G[x.p1]} ${ASP.find(s=>s[0]===x.type)[4]} ${G[x.p2]}  (orb ${orb}°)`;
    });
    return `<h4>${title}</h4><div>${items.length?items.join("<br>"):"—"}</div>`;
  };
  document.getElementById("aspLists").innerHTML = block("☌ コンジャンクション(0°)",["Conj"])
    + block("⚹ セクスタイル(60°)",["Sext"])
    + block("□ スクエア(90°)",["Square"])
    + block("△ トライン(120°)",["Trine"])
    + block("⚻ インコンジャクト(150°)",["Inc"])
    + block("☍ オポジション(180°)",["Opp"]);
}

/* ====== AI総評 ====== */
function aiReading(meta,pos,houses){
  const aspects=findAspects(pos,meta.orb);
  const elCnt={火:0,地:0,風:0,水:0}, mdCnt={活動:0,不動:0,柔軟:0};
  const majors=["Sun","Moon","Mercury","Venus","Mars","Jupiter","Saturn"];
  majors.forEach(k=>{elCnt[elementOf(pos[k])]++; mdCnt[modalityOf(pos[k])]++;});
  const topEl=Object.entries(elCnt).sort((a,b)=>b[1]-a[1])[0][0];
  const topMd=Object.entries(mdCnt).sort((a,b)=>b[1]-a[1])[0][0];
  const moonS=SIGNS[Math.floor(pos.Moon/30)];
  const has=(a,b,t)=>aspects.some(x=>((x.p1===a&&x.p2===b)||(x.p1===b&&x.p2===a)) && (Array.isArray(t)?t.includes(x.type):x.type===t));
  const list=(arr)=>arr.map(x=>"・"+x).join("\n");

  const love=[
    `金星×火星が ${has("Venus","Mars",["Trine","Sext"])?"調和的":"テンポ差"}。サインの性質に合わせて“合図の言語化”を増やすと進展が速い。`,
    `月（${moonS}）の安心の形を日常のルーティンへ。回復の“間”の固定化で関係が安定。`,
    `7H/金星が${topEl==="風"?"会話と距離感":"体験共有"}を求める傾向。デート設計に反映。`
  ];
  const work=[
    `MC×土星/木星：${has("Sun","Saturn",["Trine","Sext","Conj"])?"締切耐性◎":"締切を先置きで生産性アップ"}。${topMd==="活動"?"短期決戦型":"長期蓄積型"}が合う。`,
    `水星の要素はアウトプットの型。${elementOf(pos.Mercury)==="風"?"言語化/会話":"図解/試作"}で早く可視化し、共有する。`,
    `木星領域は拡大回路。${elementOf(pos.Jupiter)==="地"?"数値KPI":"ストーリー"}で成果を見せると巻き込みが加速。`
  ];
  const future=[
    `主調「${topEl}×${topMd}」を半年テーマに設定。${topEl==="火"?"新規着手":"品質/資産化"}を週1で積む。`,
    `${has("Sun","Jupiter",["Trine","Sext","Conj"])?"学習曲線が立ち上がる節目":"小さく検証→即振返りで成功率を上げる" }。`,
    `月×土星の関係で休息設計。${has("Moon","Saturn","Trine")?"計画的休養で長距離戦◎":"境界線を決めて消耗を抑える"}。`
  ];
  const syn=[
    `相性は主調リズム一致が近道。${topEl==="風"||topEl==="火"?"テンポ":"安心/安定"}の基準を共有。`,
    `太陽/月の補完は長期の地盤。不得手は外部資源に委任して無理に背負わない。`,
    `衝突角（□/☍）は役割差のサイン。分担を明文化すると推進力へ。`
  ];
  const move=[
    `引越しは月の要素。${elementOf(pos.Moon)==="地"?"静かな定着環境":"刺激/交流"}が適合。`,
    `木星が良角の年は契約/住環境の更新がスムーズ。金星逆行期は調整厚めに。`,
    `ASC支配星の動線最適化で生活満足度が上がる。`
  ];
  const changeJob=[
    `転職は「太陽×木星（拡大）」or「太陽×土星（地固め）」期が追い風。現職熟度で選択。`,
    `履歴書は水星の強みで魅せる：${elementOf(pos.Mercury)==="風"?"言語化力":"成果物/数値" }を前面に。`,
    `面談は金星の流儀で一貫。${elementOf(pos.Venus)==="水"?"共感の深さ":"美意識/整備力" }を芯に。`
  ];
  const aptitude=[
    `適職の軸は「${topEl}×${topMd}」。${topEl==="風"?"情報循環":"資源整備"}を${topMd==="活動"?"起動":"維持最適化"}する役割で評価が伸びる。`,
    `金星=魅せ方、火星=突破力。${has("Venus","Mars",["Trine","Sext"])?"橋渡し（営業×企画）":"制作×運用の二刀流"}が活きやすい。`,
    `木星領域の学習を固定費化（週1）。積み上げが指数関数的な伸びを生む。`
  ];
  const strengths=[`${topEl==="地"?"継続と品質志向":"変化対応/学習速度"}`,`${topMd==="活動"?"初動の速さ":"腰を据えた深掘り"}`,`${has("Sun","Saturn",["Trine","Sext"])?"責任感と期限耐性":"柔軟な舵切り"}`];
  const weaknesses=[`${topEl==="火"?"短気になりやすい":"慎重で機会を逃しがち"}`,`${topMd==="不動"?"固着しやすい":"ブレやすい"}`,`${has("Moon","Saturn",["Square","Opp"])?"感情が重くなりやすい":"緊張が続くと消耗"}];
  return `【恋愛】\n${list(love)}\n\n【仕事】\n${list(work)}\n\n【未来計画】\n${list(future)}\n\n【相性】\n${list(syn)}\n\n【引っ越し時期】\n${list(move)}\n\n【転職時期】\n${list(changeJob)}\n\n【適職】\n${list(aptitude)}\n\n【長所】\n${list(strengths)}\n\n【短所】\n${list(weaknesses)}`;
}

/* ====== 連番入力 → パース ====== */
function parseCompactDate(str){
  const s=(str||"").replace(/\D/g,"");
  if(!(s.length===7 || s.length===8)) throw "生年月日は 7桁(YYYYMDD) または 8桁(YYYYMMDD)";
  const yyyy=+s.slice(0,4);
  let mm, dd;
  if(s.length===8){ mm=+s.slice(4,6); dd=+s.slice(6,8); }
  else { mm=+s.slice(4,5); dd=+s.slice(5,7); }
  if(mm<1||mm>12) throw "月が不正です";
  const dt=new Date(Date.UTC(yyyy,mm-1,dd,12,0));
  if(dt.getUTCFullYear()!=yyyy||dt.getUTCMonth()!=mm-1||dt.getUTCDate()!=dd) throw "存在しない日付です";
  return {y:yyyy,m:mm,d:dd};
}
function parseCompactTime(str){
  const s=(str||"").replace(/\D/g,"");
  if(!s){return {hh:12,mi:0}}
  if(s.length!==4) throw "時刻は 4桁（HHMM）で入力";
  const hh=+s.slice(0,2), mi=+s.slice(2,4);
  if(hh>23||mi>59) throw "時刻が不正です";
  return {hh,mi};
}

/* ====== 実行フロー ====== */
function metaFromInputs(){
  document.getElementById("dateCompact").classList.remove('err');
  document.getElementById("timeCompact").classList.remove('err');
  const d=parseCompactDate(document.getElementById("dateCompact").value.trim());
  const t=parseCompactTime(document.getElementById("timeCompact").value.trim());
  return {
    name:document.getElementById("name").value,
    place:document.getElementById("place").value,
    tz:+document.getElementById("tz").value,
    dst:+document.getElementById("dst").value,
    lat:+document.getElementById("lat").value||0,
    lon:+document.getElementById("lon").value||0,
    house:document.getElementById("house").value,
    orb:+(document.getElementById("orb").value||6),
    date:`${d.y}-${String(d.m).padStart(2,'0')}-${String(d.d).padStart(2,'0')}`,
    time:`${String(t.hh).padStart(2,'0')}:${String(t.mi).padStart(2,'0')}`
  };
}
function computeAll(meta){
  const [y,m,d]=meta.date.split('-').map(Number); const [hh,mi]=(meta.time||"00:00").split(':').map(Number);
  const jd=jdFromYMD(y,m,d, hh-meta.tz-meta.dst, mi); const am=ascMcFrom(jd,meta.lat,meta.lon);
  const pos={ASC:am.ASC,MC:am.MC,IC:am.IC,DES:am.DES};
  ["Sun","Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto"].forEach(n=>pos[n]=LON[n](jd));
  const houses = meta.house==='equal' ? Houses.equal(am.ASC) : Houses.whole(am.ASC);
  return {pos,houses,jd};
}
function buildAll(meta){
  const {pos,houses}=computeAll(meta);
  drawChart(document.getElementById("cv"),pos,houses,{orb:meta.orb});
  document.getElementById("sum_name").textContent=meta.name||"—";
  document.getElementById("sum_date").textContent=`${meta.date}　${meta.time}`;
  document.getElementById("sum_place").textContent=meta.place||"—";
  build3_4(pos); buildPlanetTable(pos); buildHouseTable(houses,pos);
  buildMatrix(document.getElementById("aspMatrix"),pos,meta.orb); buildAspectLists(pos,meta.orb);
  document.getElementById("report").value=aiReading(meta,pos,houses);
}

/* ====== ボタン ====== */
document.getElementById("calcAsc").onclick=async()=>{
  try{
    let m=metaFromInputs();
    if((!m.lat || !m.lon) && m.place){
      const g=await geocodeSmart(m.place);
      document.getElementById("lat").value=m.lat=g.lat;
      document.getElementById("lon").value=m.lon=g.lon;
    }
    if(!m.lat || !m.lon) return alert("緯度経度を入力（または地名検索）してください");
    const [Y,M,D]=m.date.split('-').map(Number); const [H,MM]=m.time.split(':').map(Number);
    const jd=jdFromYMD(Y,M,D,H-m.tz-m.dst,MM); const am=ascMcFrom(jd,m.lat,m.lon);
    alert(`ASC: ${SIGNS[Math.floor(am.ASC/30)]} / MC: ${SIGNS[Math.floor(am.MC/30)]}（ASCは左・反時計回り）`);
  }catch(e){alert(e)}
};
document.getElementById("run").onclick=async()=>{
  try{
    let m=metaFromInputs();
    if((!m.lat || !m.lon) && m.place){
      const g=await geocodeSmart(m.place);
      document.getElementById("lat").value=m.lat=g.lat;
      document.getElementById("lon").value=m.lon=g.lon;
    }
    if(!m.lat || !m.lon) return alert("緯度経度が取得できませんでした（地名を入力して『地名検索』を押すか、手で入力してください）");
    buildAll(m);
  }catch(e){
    const msg=String(e);
    if(/日付|桁|月|存在/.test(msg)) document.getElementById("dateCompact").classList.add('err');
    if(/時刻/.test(msg)) document.getElementById("timeCompact").classList.add('err');
    alert(msg);
  }
};
</script>
</body>
</html>
