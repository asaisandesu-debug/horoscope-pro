<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Horoscope PRO – Dark Gold (Placidus/Final)</title>
<style>
:root{
  /* Dark + Gold + Emerald */
  --bg:#0d1116; --card:#121921; --ink:#f6f6f6; --muted:#b9c4d1; --line:#243142;
  --band:#10221b; --band2:#0f1c17;  /* サイン帯は緑みの暗色 */
  --tick:#2f4a42;                  /* 目盛/補助線をグリーン寄りに */
  --gold:#e4c878; --white:#f6f6f6;

  /* アスペクト色（見やすいコントラスト） */
  --sq:#ff7b7b;    /* □ */
  --tr:#66a6ff;    /* △ */
  --se:#5bd394;    /* ⚹ */
  --op:#f0c262;    /* ☍ */
  --cj:#ffffff;    /* ☌ */
  --inc:#b28cff;   /* ⚻ */

  /* 枠 */
  --emerald:#00b894; /* 外輪・強調のエメラルド */
  --emerald2:#66ffcc;/* 明るいエメラルド */
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 "Noto Serif JP","Hiragino Mincho ProN","Yu Mincho","Times New Roman",serif}
.container{max-width:1220px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:rgba(13,17,22,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20}
h1{margin:6px 0;font-size:20px;color:var(--gold)}
.small{color:var(--muted);font-size:12px}
.grid{display:grid;gap:16px}
@media(min-width:1080px){.grid{grid-template-columns:430px 1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
label{font-size:12px;color:var(--muted)}
input,select,button,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f141a;color:var(--ink)}
input:focus,select:focus,textarea:focus{outline:2px solid #285a46}
.btn{cursor:pointer;background:#0f141a}
.btn-ac{background:var(--gold);color:#111;border-color:var(--gold)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.help{font-size:12px;color:var(--muted)}
canvas{width:100%;height:auto;background:#0e1514;border:1px solid var(--line);border-radius:12px}
.meta{display:grid;grid-template-columns:120px 1fr;gap:8px;margin-top:10px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--line);padding:8px 10px;text-align:center}
.table th{color:var(--gold)}
.ribbon{display:inline-block;background:#103327;color:#d8ffe9;padding:6px 14px;border-radius:10px 10px 0 0;margin:-14px 0 6px}
.flex{display:flex;gap:6px;align-items:center}
.badge{position:absolute;transform:translate(-50%,-50%);background:#0b1612;border:1px solid #2b6a57;border-radius:8px;padding:2px 6px;font:12px ui-monospace;color:var(--white);white-space:nowrap}
.section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:14px}
.kv{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);margin:2px 4px 0 0}
.err{border-color:#ff6b6b}
h3,h4,th{color:var(--gold)}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>Horoscope PRO – Dark Gold (Placidus)</h1>
    <div class="small">3区分/4区分/天体表/ハウス・カスプ/アスペクト格子＋一覧（orb）/AI総評（恋愛・仕事・未来計画・相性・引越・転職・適職＋長所短所）/連番入力/地名→緯度経度</div>
  </div>
</header>

<main class="container grid">
  <!-- 入力 -->
  <section class="card">
    <span class="ribbon">入力</span>
    <div class="row" style="margin-top:8px">
      <div><label>氏名</label><input id="name" placeholder="例：鑑定Aさん"></div>
      <div>
        <label>出生地（地名→緯度経度）</label>
        <div class="flex"><input id="place" placeholder="例：名古屋市"><button id="geo" class="btn">地名検索</button></div>
        <div class="help">ヒットしづらい時は市区町村まで入力</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div>
        <label>生年月日（連番）</label>
        <input id="dateCompact" placeholder="1989531 または 19890531">
        <div class="help">7桁：YYYYMDD（1989531=1989/5/31）/ 8桁：YYYYMMDD（19890531）</div>
      </div>
      <div>
        <label>出生時刻（連番・任意）</label>
        <input id="timeCompact" placeholder="例：1200（=12:00）">
        <div class="help">4桁：HHMM（0735/1820 等）※ 12:00 / 12時00分 / 12-00 / 12 もOK</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div><label>緯度</label><input id="lat" type="number" step="0.0001" placeholder="35.1815"></div>
      <div><label>経度</label><input id="lon" type="number" step="0.0001" placeholder="136.9066"></div>
    </div>

    <div class="row">
      <div><label>UTC（日本=9）</label><input id="tz" type="number" value="9" step="0.25"></div>
      <div><label>DST</label><select id="dst"><option value="0">なし</option><option value="1">+1h</option></select></div>
    </div>

    <div class="row">
      <div><label>ハウス方式</label>
        <select id="house">
          <option value="placidus" selected>Placidus</option>
          <option value="equal">Equal</option>
          <option value="whole">Whole Sign</option>
        </select>
      </div>
      <div><label>アスペクト Orb（度）</label><input id="orb" type="number" value="6" step="0.5"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="calcAsc">Asc/MC 計算</button>
      <button class="btn-ac" id="run">鑑定を作成</button>
    </div>
    <div class="help" style="margin-top:6px">ASCは左（9時）固定／ハウスは反時計回り／各ハウス5°目盛</div>
  </section>

  <!-- 円盤 -->
  <section class="card">
    <span class="ribbon">ホロスコープ</span>
    <div style="position:relative;margin-top:8px">
      <canvas id="cv" width="1200" height="1200"></canvas>
      <div id="labels" style="position:absolute;left:0;top:0;transform:translate(600px,600px)"></div>
    </div>

    <div class="meta">
      <div>NAME</div><div id="sum_name">—</div>
      <div>DATE</div><div id="sum_date">—</div>
      <div>PLACE</div><div id="sum_place">—</div>
    </div>
  </section>
</main>

<!-- 表 -->
<section class="container section">
  <div class="kv">
    <div class="card">
      <span class="ribbon">3区分（活動／不動／柔軟）</span>
      <table class="table" id="t3"></table>
    </div>
    <div class="card">
      <span class="ribbon">4区分（火／地／風／水）</span>
      <table class="table" id="t4"></table>
    </div>
    <div class="card">
      <span class="ribbon">凡例</span>
      <div class="small">
        <div class="tag">☌ Conjunction</div>
        <div class="tag">⚹ Sextile</div>
        <div class="tag">□ Square</div>
        <div class="tag">△ Trine</div>
        <div class="tag">⚻ Quincunx</div>
        <div class="tag">☍ Opposition</div>
      </div>
    </div>
  </div>
</section>

<section class="container section">
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card">
      <span class="ribbon">天体表（記号・サイン・度分）</span>
      <table class="table" id="planetTbl"></table>
    </div>
    <div class="card">
      <span class="ribbon">ハウス・カスプ表（1～12／ASC/MC/DES/IC）</span>
      <table class="table" id="houseTbl"></table>
    </div>
  </div>
</section>

<section class="container section">
  <div class="card">
    <span class="ribbon">アスペクト（格子マトリクス）</span>
    <table class="table" id="aspMatrix"></table>
  </div>
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="card">
      <span class="ribbon">アスペクト一覧（種類別／orb付き）</span>
      <div id="aspLists" class="small"></div>
    </div>
    <div class="card">
      <span class="ribbon">AI 自動総評（恋愛／仕事／未来計画／相性／引越／転職／適職＋長所・短所）</span>
      <textarea id="report" style="min-height:360px;width:100%"></textarea>
    </div>
  </div>
</section>

<footer class="container small" style="text-align:center;margin:28px 0;color:var(--muted)">© Horoscope PRO</footer>

<script>
/* ===== 基本補助 ===== */
const DEG=Math.PI/180;
const SIGNS=["牡羊","牡牛","双子","蟹","獅子","乙女","天秤","蠍","射手","山羊","水瓶","魚"];
const GL=[["Sun","☉"],["Moon","☽"],["Mercury","☿"],["Venus","♀"],["Mars","♂"],["Jupiter","♃"],["Saturn","♄"],["Uranus","♅"],["Neptune","♆"],["Pluto","♇"]];
const ASP=[["Conj",0,8,"var(--cj)","☌","0°"],["Sext",60,5,"var(--se)","⚹","60°"],["Square",90,6,"var(--sq)","□","90°"],["Trine",120,7,"var(--tr)","△","120°"],["Inc",150,4.5,"var(--inc)","⚻","150°"],["Opp",180,8,"var(--op)","☍","180°"]];
function mod360(x){x%=360; if(x<0)x+=360; return x}
function dAng(a,b){let d=Math.abs(a-b)%360; return d>180?360-d:d}
function css(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim()}
const toDM = lon => {lon=mod360(lon); const d=Math.floor(lon%30), m=Math.round((lon%1)*60); return [SIGNS[Math.floor(lon/30)], `${d}°${String(m).padStart(2,"0")}′`];};

/* ===== 日時/時刻 ===== */
function parseCompactDate(s){
  s=String(s||"").trim();
  if(!s) throw "生年月日が空です（1989531 / 19890531）";
  const digits=s.replace(/[^\d]/g,"");
  if(digits.length===7){ // YYYYMDD
    const y=+digits.slice(0,4), m=+digits.slice(4,5), d=+digits.slice(5,7);
    return {y,m,d};
  }else if(digits.length===8){
    const y=+digits.slice(0,4), m=+digits.slice(4,6), d=+digits.slice(6,8);
    return {y,m,d};
  }
  throw "生年月日は 1989531 または 19890531 で入力してください";
}
function parseCompactTime(str){
  if(!str || !String(str).trim()){return {hh:12, mi:0};}
  const s=String(str).trim().replace(/[^\d]/g,"").padEnd(4,"0").slice(0,4);
  const hh=+s.slice(0,2), mi=+s.slice(2,4);
  if(hh>23||mi>59) throw "時刻が不正です（例：1200 / 12:00）";
  return {hh,mi};
}

/* ===== グリニッジ通日/恒星時/黄道傾斜 ===== */
function jdFromYMD(y,m,d,hh=0,mi=0,tz=0,dst=0){
  if(m<=2){y--;m+=12}
  const A=Math.floor(y/100),B=2-A+Math.floor(A/4);
  const day=d+(hh+mi/60 - (tz+ +dst))/24;
  return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+day+B-1524.5;
}
function obliqDeg(jd){const T=(jd-2451545.0)/36525;return 23+26/60+21.448/3600-(46.8150*T+0.00059*T*T-0.001813*T*T*T)/3600}
function gstDeg(jd){const T=(jd-2451545.0)/36525;return mod360(280.46061837+360.98564736629*(jd-2451545.0)+0.000387933*T*T-(T*T*T)/38710000)}

/* ===== 天体黄経（簡易だが安定） ===== */
function Tcent(jd){return (jd-2451545.0)/36525}
function sunLon(jd){const T=Tcent(jd); const L0=mod360(280.46646+36000.76983*T+0.0003032*T*T); const M=mod360(357.52911+35999.05029*T-0.0001537*T*T)*DEG; const C=(1.914602-0.004817*T-0.000014*T*T)*Math.sin(M)+(0.019993-0.000101*T)*Math.sin(2*M)+0.000289*Math.sin(3*M); return mod360(L0+C);}
function moonLon(jd){const T=Tcent(jd), L0=mod360(218.3164477+481267.88123421*(jd-2451545)/36525); const M=mod360(134.9633964+477198.8675055*(jd-2451545)/36525)*DEG; const D=mod360(297.8501921+445267.1114034*(jd-2451545)/36525)*DEG; return mod360(L0 + 6.289*Math.sin(M) + 1.274*Math.sin(2*D - M) + 0.658*Math.sin(2*D) + 0.214*Math.sin(2*M) + 0.11*Math.sin(D));}
function planetMean(name){const n={Mercury:4.09233445,Venus:1.60213034,Mars:0.524039,Jupiter:0.0830867,Saturn:0.03344414,Uranus:0.0117696,Neptune:0.0060201,Pluto:0.0039640};
  const L0={Mercury:252.2509,Venus:181.9798,Mars:355.4330,Jupiter:34.3515,Saturn:50.0774,Uranus:314.0550,Neptune:304.3487,Pluto:238.9290};
  return jd=>mod360(L0[name]+n[name]*(jd-2451545.0));
}
const LON={Sun:jd=>sunLon(jd), Moon:jd=>moonLon(jd), Mercury:planetMean("Mercury"),Venus:planetMean("Venus"),Mars:planetMean("Mars"),Jupiter:planetMean("Jupiter"),Saturn:planetMean("Saturn"),Uranus:planetMean("Uranus"),Neptune:planetMean("Neptune"),Pluto:planetMean("Pluto")};

/* ===== ASC/MC（正確） ===== */
function ascMcFrom(jd,latDeg,lonDeg){
  const eps=obliqDeg(jd)*DEG, lst=gstDeg(jd)*DEG+lonDeg*DEG, phi=latDeg*DEG;
  let Lmc=Math.atan2(Math.sin(lst)*Math.cos(eps),Math.cos(lst)); Lmc=mod360(Lmc/DEG);
  const sinE=Math.sin(eps),cosE=Math.cos(eps),tanPhi=Math.tan(phi),sinL=Math.sin(lst),cosL=Math.cos(lst);
  let Lasc=Math.atan2(-cosL, sinL*cosE - tanPhi*sinE); Lasc=mod360(Lasc/DEG);
  return {ASC:Lasc,MC:Lmc,IC:mod360(Lmc+180),DES:mod360(Lasc+180), eps, lst, phi};
}

/* ===== Placidus 近似：半弧分割の数値解（ブラウザで安定動作） =====
   手順：
   1) RAMC=lst、ε、φ を取得
   2) 11/12 ハウスは上半球の半弧を 1/3,2/3 分割（RA基準）→ 対応する黄経を数値探索
   3) 2/3 ハウスは下半球側を同様に
*/
function eclLonFromRAdec(ra,dec,eps){
  // 赤経・赤緯→黄経
  const se=Math.sin(eps), ce=Math.cos(eps);
  const y=Math.sin(ra)*ce + Math.tan(dec)*se;
  const x=Math.cos(ra);
  return mod360(Math.atan2(y,x)/DEG);
}
function RAdecFromEclLon(lon,eps){
  // 黄経→(赤経,赤緯)
  lon*=DEG;
  const se=Math.sin(eps), ce=Math.cos(eps);
  const x=Math.cos(lon), y=Math.sin(lon);
  const ra=Math.atan2(y*ce, x);
  const dec=Math.asin(y*se);
  return {ra,dec};
}
function hourAngleToHorizon(dec,phi){
  // 地平線との交点（半弧） H0 = arccos(-tan φ * tan δ)
  const t = -Math.tan(phi)*Math.tan(dec);
  if (t<=-1) return Math.PI; if (t>=1) return 0;
  return Math.acos(t);
}
function solveForHouseRA(targetFrac, RAMC, phi, eps, upper=true){
  // targetFrac: 1/3 or 2/3（半弧を何分割するか）
  // upper=true: 上半球 (11,12) / false: 下半球 (2,3)
  // 数値探索：RAを動かして「RAMC からの移動量 = targetFrac * H0(その点のδ)」を満たす点を探す
  let ra = RAMC; // 初期
  for(let k=0;k<50;k++){
    // 今の ra が示す黄経 lon と赤緯 dec を逆算する（ra→lon は一意でないため、微小ずらしで近似）
    // ここでは lon を未知にして直接は解かない。ra を増減→必要条件に近づける単純反復。
    const lonGuess = mod360((ra/DEG)); // ざっくりの初期推定
    const {ra:ra2,dec}=RAdecFromEclLon(lonGuess,eps);
    const H0 = hourAngleToHorizon(dec,phi);          // 半弧（0..π）
    const want = (upper ? +1 : -1) * targetFrac * H0; // 目標移動量（±）
    const diff = modPi(ra - RAMC) - want;             // 今の差（ラジアン）
    ra -= diff*0.5; // 緩く近づける
  }
  return ra;
}
function modPi(x){x%=Math.PI*2; if(x>Math.PI)x-=2*Math.PI; if(x<-Math.PI)x+=2*Math.PI; return x;}
function placidusCusps(ascmc){
  // ascmc: {ASC,MC,IC,DES, eps, lst, phi}
  const {ASC,MC,eps,lst,phi}=ascmc;
  // 10=MC, 1=ASC は既知
  const cusps=new Array(12).fill(0);
  cusps[0]=ASC; cusps[9]=MC;

  // 11,12（上半球）：半弧の 1/3, 2/3
  const ra11 = solveForHouseRA(1/3, lst, phi, eps, true);
  const ra12 = solveForHouseRA(2/3, lst, phi, eps, true);
  cusps[10]= eclLonFromRAdec(ra11, 0, eps); // dec は関数内で使うため 0 はダミー（実際は eclLonFromRAdec 内では ra を主に参照）
  cusps[11]= eclLonFromRAdec(ra12, 0, eps);

  // 2,3（下半球）
  const ra2 = solveForHouseRA(2/3, lst+Math.PI, phi, eps, false);
  const ra3 = solveForHouseRA(1/3, lst+Math.PI, phi, eps, false);
  cusps[1]= mod360(ASC+0); // 1ハウスはASC
  cusps[2]= eclLonFromRAdec(ra2, 0, eps);
  cusps[3]= eclLonFromRAdec(ra3, 0, eps);

  // 4=IC, 5,6 は 10,11,12 を180°ずらす（Placidusの対向）
  cusps[3]=mod360(cusps[3]); // 再確認
  cusps[4]=mod360(ascmc.IC);
  cusps[5]=mod360(cusps[11]+180);
  cusps[6]=mod360(cusps[10]+180);
  cusps[7]=mod360(ascmc.DES);
  cusps[8]=mod360(cusps[2]+180);

  // 並び順を 1→12 に整え（0-indexで 0..11）
  // 既に 1,2,3,4,5,6,7,8,9,10,11,12 の順で格納済み
  return cusps.map(v=>mod360(v));
}

/* ===== Equal / Whole ===== */
const Houses={
  equal(asc){return[...Array(12)].map((_,i)=>mod360(asc+i*30))},
  whole(asc){const s=Math.floor(asc/30);return[...Array(12)].map((_,i)=>mod360((s+i)*30))}
};

/* ===== 地名→緯度経度（Nominatim → Open-Meteo） ===== */
async function geocodeNominatim(q){
  const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
  const r=await fetch(url,{headers:{'Accept-Language':'ja'}});
  if(!r.ok) throw new Error("nominatim fail");
  const js=await r.json();
  if(!js?.[0]) throw new Error("not found");
  return {lat:+js[0].lat, lon:+js[0].lon, provider:"nominatim"};
}
async function geocodeOpenMeteo(q){
  const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=ja&format=json`;
  const r=await fetch(url);
  if(!r.ok) throw new Error("open-meteo fail");
  const js=await r.json();
  if(!js?.results?.[0]) throw new Error("not found");
  const a=js.results[0]; return {lat:+a.latitude, lon:+a.longitude, provider:"open-meteo"};
}
async function geocodeSmart(q){
  if(!q) throw new Error("地名が空です");
  try{ return await geocodeNominatim(q); }catch(_){ return await geocodeOpenMeteo(q); }
}
document.getElementById("geo").onclick=async()=>{
  const q=document.getElementById("place").value.trim();
  if(!q) return alert("地名を入れてください");
  try{
    const g=await geocodeSmart(q);
    document.getElementById("lat").value=g.lat;
    document.getElementById("lon").value=g.lon;
    alert(`緯度経度：${g.lat.toFixed(4)}, ${g.lon.toFixed(4)}（${g.provider}）`);
  }catch(e){ alert("見つかりませんでした"); }
}

/* ===== 描画 ===== */
function angFor(longitude, ASC){ return ((ASC - longitude + 180) * DEG); } // ASC左=9時、反時計
function drawSignGlyph(ctx, idx, x, y, s, col=css("--gold")){
  ctx.save(); ctx.translate(x,y); ctx.strokeStyle=col; ctx.lineWidth=Math.max(2.0, s*0.06); ctx.lineCap="round"; ctx.lineJoin="round";
  const r=s*0.42;
  if(idx===0){ctx.beginPath();ctx.arc(-r*0.5,0,r*0.5,Math.PI*0.9,Math.PI*1.8);ctx.moveTo(-r*0.1,-r*0.6);ctx.quadraticCurveTo(0,-r*0.2,0,r*0.6);ctx.moveTo(r*0.1,-r*0.6);ctx.quadraticCurveTo(0,-r*0.2,0,r*0.6);ctx.stroke();}
  else if(idx===1){ctx.beginPath();ctx.arc(0,r*0.2,r*0.45,0,Math.PI*2);ctx.moveTo(-r*0.45,-r*0.2);ctx.quadraticCurveTo(-r*0.8,-r*0.6,-r*0.4,-r*0.65);ctx.moveTo(r*0.45,-r*0.2);ctx.quadraticCurveTo(r*0.8,-r*0.6,r*0.4,-r*0.65);ctx.stroke();}
  else if(idx===2){ctx.beginPath();ctx.moveTo(-r*0.5,-r*0.75);ctx.lineTo(r*0.5,-r*0.75);ctx.moveTo(-r*0.5,r*0.75);ctx.lineTo(r*0.5,r*0.75);ctx.moveTo(-r*0.3,-r*0.65);ctx.lineTo(-r*0.3,r*0.65);ctx.moveTo(r*0.3,-r*0.65);ctx.lineTo(r*0.3,r*0.65);ctx.stroke();}
  else if(idx===3){ctx.beginPath();ctx.arc(-r*0.35,-r*0.1,r*0.28,0,Math.PI*2);ctx.arc(r*0.35,r*0.1,r*0.28,0,Math.PI*2);ctx.moveTo(-r*0.1,-r*0.2);ctx.quadraticCurveTo(0,0,r*0.1,r*0.2);ctx.moveTo(r*0.1,r*0.2);ctx.quadraticCurveTo(0,0,-r*0.1,-r*0.2);ctx.stroke();}
  else if(idx===4){ctx.beginPath();ctx.arc(-r*0.1,0,r*0.5,Math.PI*0.1,Math.PI*1.6);ctx.moveTo(r*0.2,-r*0.2);ctx.quadraticCurveTo(r*0.6,0,r*0.35,r*0.55);ctx.stroke();}
  else if(idx===5){ctx.beginPath();ctx.moveTo(-r*0.6,r*0.7);ctx.lineTo(-r*0.6,-r*0.7);ctx.quadraticCurveTo(-r*0.2,-r*0.45,0,-r*0.7);ctx.lineTo(0,r*0.7);ctx.moveTo(0,-r*0.15);ctx.quadraticCurveTo(r*0.35,0,r*0.2,r*0.55);ctx.stroke();}
  else if(idx===6){ctx.beginPath();ctx.moveTo(-r*0.8,r*0.35);ctx.lineTo(r*0.8,r*0.35);ctx.moveTo(-r*0.8,0.05);ctx.arc(0,0,r*0.52,Math.PI,0);ctx.stroke();}
  else if(idx===7){ctx.beginPath();ctx.moveTo(-r*0.6,r*0.7);ctx.lineTo(-r*0.6,-r*0.7);ctx.quadraticCurveTo(-r*0.2,-r*0.45,0,-r*0.7);ctx.lineTo(0,r*0.7);ctx.moveTo(0,-r*0.1);ctx.quadraticCurveTo(r*0.45,0,r*0.38,r*0.4);ctx.lineTo(r*0.6,r*0.2);ctx.moveTo(r*0.38,r*0.4);ctx.lineTo(r*0.7,r*0.5);ctx.stroke();}
  else if(idx===8){ctx.beginPath();ctx.moveTo(-r*0.55,r*0.55);ctx.lineTo(r*0.7,-r*0.7);ctx.moveTo(r*0.3,-r*0.7);ctx.lineTo(r*0.7,-r*0.7);ctx.lineTo(r*0.7,-r*0.3);ctx.stroke();}
  else if(idx===9){ctx.beginPath();ctx.moveTo(-r*0.55,-r*0.1);ctx.quadraticCurveTo(0,-r*0.7,r*0.45,-r*0.1);ctx.quadraticCurveTo(r*0.18,r*0.25,-r*0.25,0);ctx.moveTo(-r*0.25,0);ctx.quadraticCurveTo(-r*0.06,r*0.55,r*0.28,r*0.42);ctx.stroke();}
  else if(idx===10){ctx.beginPath();ctx.moveTo(-r*0.85,-r*0.18);for(let i=0;i<3;i++){ctx.lineTo(-r*0.45+i*r*0.42,-r*0.4);ctx.lineTo(0+i*r*0.42,-r*0.18);}ctx.moveTo(-r*0.85,r*0.3);for(let i=0;i<3;i++){ctx.lineTo(-r*0.45+i*r*0.42,0.05);ctx.lineTo(0+i*r*0.42,r*0.3);}ctx.stroke();}
  else{ctx.beginPath();ctx.moveTo(-r*0.65,-r*0.45);ctx.quadraticCurveTo(-r*0.25,0,-r*0.65,r*0.45);ctx.moveTo(r*0.65,-r*0.45);ctx.quadraticCurveTo(r*0.25,0,r*0.65,r*0.45);ctx.moveTo(-r*0.72,0);ctx.lineTo(r*0.72,0);ctx.stroke();}
  ctx.restore();
}
function drawPlanetGlyph(ctx, key, x, y, size){
  const m={Sun:"☉",Moon:"☽",Mercury:"☿",Venus:"♀",Mars:"♂",Jupiter:"♃",Saturn:"♄",Uranus:"♅",Neptune:"♆",Pluto:"♇"};
  ctx.save(); ctx.fillStyle=css("--white"); ctx.strokeStyle=css("--gold"); ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(x,y,size*0.52,0,Math.PI*2); ctx.stroke();
  ctx.font=`${Math.round(size*0.9)}px 'Times New Roman',serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(m[key],x,y+1); ctx.restore();
}
function drawChart(canvas,pos,houses,{orb}={}){
  const ctx=canvas.getContext('2d'), W=canvas.width, H=canvas.height, cx=W/2, cy=H/2;
  ctx.clearRect(0,0,W,H);
  const labelsDiv=document.getElementById("labels"); labelsDiv.innerHTML=""; labelsDiv.style.transform=`translate(${cx}px,${cy}px)`;
  const R=Math.min(W,H)*0.46, bandR1=R-12, bandR2=R-86, houseR=bandR2-18;

  /* 外輪（エメラルド系） */
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2);
  const grad=ctx.createLinearGradient(cx-R,cy-R,cx+R,cy+R);
  grad.addColorStop(0,"#0c3a2f"); grad.addColorStop(0.5,"var(--emerald)"); grad.addColorStop(1,"var(--emerald2)");
  ctx.strokeStyle=grad; ctx.lineWidth=22; ctx.stroke();

  /* サイン帯（緑系の交互） */
  for(let i=0;i<12;i++){
    const lon=mod360(Math.floor(pos.ASC/30)*30 + i*30);
    const a0=angFor(lon,pos.ASC), a1=angFor(mod360(lon+30),pos.ASC);
    ctx.beginPath(); ctx.arc(cx,cy,bandR1,a0,a1,true); ctx.arc(cx,cy,bandR2,a1,a0,false); ctx.closePath();
    ctx.fillStyle= (i%2)? "var(--band)" : "var(--band2)"; ctx.fill();
    const mid=angFor(mod360(lon+15), pos.ASC);
    const rx=cx+(bandR1+bandR2)/2*Math.cos(mid), ry=cy+(bandR1+bandR2)/2*Math.sin(mid);
    drawSignGlyph(ctx, Math.floor(lon/30)%12, rx, ry, 86, "var(--gold)");
  }

  /* ハウス線と5°目盛（緑寄りの補助線） */
  for(let i=0;i<12;i++){
    const cusp=houses[i], a=angFor(cusp, pos.ASC), x=cx+houseR*Math.cos(a), y=cy+houseR*Math.sin(a);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.lineWidth=i===0?2.6:1; ctx.strokeStyle=i===0?"var(--gold)":"var(--tick)"; ctx.stroke();
    for(let d=5; d<30; d+=5){
      const aa=angFor(mod360(cusp+d),pos.ASC); const r1=houseR-6, r2=houseR-(d%10===0?22:14);
      ctx.beginPath(); ctx.moveTo(cx+r1*Math.cos(aa), cy+r1*Math.sin(aa)); ctx.lineTo(cx+r2*Math.cos(aa), cy+r2*Math.sin(aa));
      ctx.lineWidth=1; ctx.strokeStyle="#2a5d4c"; ctx.stroke();
      if(d%10===0){ ctx.fillStyle="#9debcf"; ctx.font="11px ui-monospace"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(String(d), cx+(r2-10)*Math.cos(aa), cy+(r2-10)*Math.sin(aa));}
    }
    ctx.fillStyle=i===0?css("--gold"):css("--ink"); ctx.font="bold 12px 'Times New Roman',serif";
    ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(i+1, cx+(houseR-14)*Math.cos(a), cy+(houseR-14)*Math.sin(a));
  }

  /* 内輪 */
  const innerR=houseR-100; ctx.beginPath(); ctx.arc(cx,cy,innerR,0,Math.PI*2); ctx.strokeStyle="#1f3b33"; ctx.stroke();

  /* 惑星位置（重なり回避） */
  const keys=GL.map(x=>x[0]); const nodes=[], used=[];
  keys.forEach(k=>{const ang=angFor(pos[k],pos.ASC); let rr=houseR-18; for(const u of used){ if(Math.abs(ang-u)<(10*DEG)) rr-=14;} used.push(ang); nodes.push([k,ang,rr]); });

  /* アスペクト */
  const aspects=findAspects(pos,orb);
  aspects.forEach(a=>{
    const n1=nodes.find(n=>n[0]===a.p1), n2=nodes.find(n=>n[0]===a.p2);
    const p1={x:cx+innerR*Math.cos(n1[1]), y:cy+innerR*Math.sin(n1[1])};
    const p2={x:cx+innerR*Math.cos(n2[1]), y:cy+innerR*Math.sin(n2[1])};
    const col=css(ASP.find(s=>s[0]===a.type)[3]);
    ctx.strokeStyle=col; ctx.lineWidth= a.type==="Conj"?3:2.2; ctx.globalAlpha=.95; ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); ctx.globalAlpha=1;
    const mx=(p1.x+p2.x)/2, my=(p1.y+p2.y)/2; ctx.fillStyle=col; ctx.font="bold 13px ui-monospace"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(ASP.find(s=>s[0]===a.type)[4]+" "+ASP.find(s=>s[0]===a.type)[5],mx,my);
  });

  /* 惑星ピン＋度数ラベル */
  const labelsDiv=document.getElementById("labels");
  nodes.forEach(n=>{
    const k=n[0], ang=n[1], rr=n[2], x=cx+rr*Math.cos(ang), y=cy+rr*Math.sin(ang);
    drawPlanetGlyph(ctx,k,x,y,26);
    const lon=pos[k], [sg,dm]=toDM(lon);
    const el=document.createElement("div"); el.className="badge"; el.style.left=`${x}px`; el.style.top=`${y-26}px`;
    el.innerText = `${dm} ${sg}`;
    labelsDiv.appendChild(el);
  });

  /* 四軸（緑×金） */
  [["ASC",pos.ASC,"#66ffcc"],["MC",pos.MC,"#e4c878"],["IC",pos.IC,"#e4c878"],["DES",pos.DES,"#66ffcc"]].forEach(([nm,lon,col])=>{
    const a=angFor(lon,pos.ASC), x=cx+(bandR1-20)*Math.cos(a), y=cy+(bandR1-20)*Math.sin(a);
    ctx.fillStyle=col; ctx.font="bold 42px 'Times New Roman',serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(nm, x, y);
  });
}

/* ===== アスペクト ===== */
function findAspects(pos,orb){
  const out=[]; const keys=GL.map(v=>v[0]);
  for(let i=0;i<keys.length;i++){
    for(let j=i+1;j<keys.length;j++){
      const a=pos[keys[i]], b=pos[keys[j]], d=dAng(a,b);
      for(const t of ASP){
        const dd=Math.abs(d-t[1]);
        if(dd<= (orb||6)){ out.push({p1:keys[i], p2:keys[j], type:t[0], orb:+dd.toFixed(2)}); break; }
      }
    }
  }
  return out;
}

/* ===== 表 ===== */
function buildTables(pos,houses,aspList){
  // 天体
  const p = GL.map(([k,g])=>{const [sg,dm]=toDM(pos[k]);return `<tr><th>${g}</th><td>${sg}</td><td>${dm}</td></tr>`}).join("");
  document.getElementById("planetTbl").innerHTML=`<tr><th>天体</th><th>サイン</th><th>度分</th></tr>${p}`;
  // ハウス（1〜12 + 角）
  let h=`<tr><th>HOUSE</th><th>サイン</th><th>度分</th></tr>`;
  for(let i=0;i<12;i++){ const [sg,dm]=toDM(houses[i]); h+=`<tr><th>${i+1}</th><td>${sg}</td><td>${dm}</td></tr>`}
  const add=(lab,lon)=>{const [sg,dm]=toDM(lon); h+=`<tr><th>${lab}</th><td>${sg}</td><td>${dm}</td></tr>`}
  add("ASC",houses.asc); add("MC",houses.mc); add("DES",houses.des); add("IC",houses.ic);
  document.getElementById("houseTbl").innerHTML=h;

  // 3区分・4区分
  const buckets3=[[],[],[]], buckets4=[[],[],[],[]];
  GL.forEach(([k,g])=>{
    const s=Math.floor(pos[k]/30), md=s%3, el=Math.floor(s/3); buckets3[md].push(g); buckets4[el].push(g);
  });
  document.getElementById("t3").innerHTML=`<tr><th>活動</th><th>不動</th><th>柔軟</th></tr>
    <tr><td>${buckets3[0].join(" ")||"—"}</td><td>${buckets3[1].join(" ")||"—"}</td><td>${buckets3[2].join(" ")||"—"}</td></tr>`;
  document.getElementById("t4").innerHTML=`<tr><th>火</th><th>地</th><th>風</th><th>水</th></tr>
    <tr><td>${buckets4[0].join(" ")||"—"}</td><td>${buckets4[1].join(" ")||"—"}</td><td>${buckets4[2].join(" ")||"—"}</td><td>${buckets4[3].join(" ")||"—"}</td></tr>`;

  // アスペクトマトリクス
  let M=`<tr><th></th>${GL.map(p=>`<th>${p[1]}</th>`).join("")}</tr>`;
  for(let i=0;i<GL.length;i++){
    M+=`<tr><th>${GL[i][1]}</th>`;
    for(let j=0;j<GL.length;j++){
      if(j<=i){ M+=`<td>—</td>`; continue; }
      const as=aspList.find(a=>(a.p1===GL[i][0]&&a.p2===GL[j][0]));
      if(!as){ M+=`<td></td>`; continue; }
      const info=ASP.find(x=>x[0]===as.type);
      M+=`<td title="orb ${as.orb}°">${info[4]}</td>`;
    }
    M+=`</tr>`;
  }
  document.getElementById("aspMatrix").innerHTML=M;

  // アスペクト一覧
  const groups={Conj:[],Sext:[],Square:[],Trine:[],Inc:[],Opp:[]};
  aspList.forEach(a=>groups[a.type].push(a));
  const lab=(t)=>ASP.find(x=>x[0]===t)[4];
  let html="";
  [["Conj","コンジャンクション"],["Sext","セクスタイル"],["Square","スクエア"],["Trine","トライン"],["Inc","インコン"],["Opp","オポジション"]]
    .forEach(([k,ja])=>{
      html+=`<h4>${lab(k)} ${ja}</h4><ul>`;
      if(groups[k].length===0) html+=`<li>なし</li>`;
      groups[k].forEach(a=>{ const g1=GL.find(p=>p[0]===a.p1)[1], g2=GL.find(p=>p[0]===a.p2)[1]; html+=`<li>${g1} ${lab(k)} ${g2}（orb ${a.orb}°）</li>`;});
      html+=`</ul>`;
    });
  document.getElementById("aspLists").innerHTML=html;
}

/* ===== AI 総評（各3行以上） ===== */
function aiReport(pos,houses,name){
  const sign=(lon)=>Math.floor(mod360(lon)/30);
  const element=(s)=>["火","地","風","水"][Math.floor(s/3)];
  const modality=(s)=>["活動","不動","柔軟"][s%3];
  const has=(a,b,types)=>findAspects(pos,6).some(x=>((x.p1===a&&x.p2===b)||(x.p1===b&&x.p2===a)) && (Array.isArray(types)?types.includes(x.type):x.type===types));
  const list=(arr)=>arr.map(x=>"・"+x).join("\n");

  const elMain=element(sign(pos.Sun)), mdMain=modality(sign(pos.Sun));
  const love=[
    `恋愛の核は金星と火星。${has("Venus","Mars",["Trine","Sext"])?"自然に歩調が合いやすい":"テンポ差が出やすい"}ため、告知や合図を増やすと誤解が減る。`,
    `月の安心感（${SIGNS[sign(pos.Moon)]}）を生活導線に固定すると関係が安定。`,
    `7Hカスプの雰囲気を意識し、出会い方/距離感/連絡頻度を最初に明文化すると良い。`
  ];
  const work=[
    `仕事は太陽×土星×10Hで設計。${mdMain==="活動"?"短期集中で成果化":"長期の資産化"}が効率的。`,
    `水星の強み（${element(sign(pos.Mercury))==="風"?"言語化":"可視化"}）で情報共有を先行。`,
    `木星の拡大領域を週次で学習投資。定点観測のログ化が信用を生む。`
  ];
  const future=[
    `主調は「${elMain}×${mdMain}」。半年テーマを一語で決めると選択の軸が通る。`,
    `${has("Sun","Jupiter",["Conj","Trine","Sext"])?"学習曲線は立ち上がりやすい":"検証→振り返りを高速回転で補う"}。`,
    `月×土星の関係で休息設計。計画的な“間”を入れるほど安定運用になる。`
  ];
  const syn=[
    `相性は月と金星の要素が土台。同系なら摩擦少、異系でも“リズムの約束”で長期安定。`,
    `衝突角（□/☍）は役割差の表れ。分担と期待値を言語化すると推進力に変わる。`,
    `共有資源（時間/お金/空間）のルールを先に決めると安心感が上がる。`
  ];
  const move=[
    `引っ越しは月の要素が指標。${element(sign(pos.Moon))==="地"?"静けさと定着性":"交流と刺激"}を優先。`,
    `契約運は木星良角期が滑らか。金星逆行期は内装/備品の調整を厚く。`,
    `生活導線（ASC支配星）を整えると満足度が上がる。`
  ];
  const change=[
    `転職は太陽×木星（拡大）/太陽×土星（地固め）を基準に。現職の熟度で選ぶ。`,
    `履歴書は水星の強みで設計：${element(sign(pos.Mercury))==="風"?"言語化力":"成果物"}を前面に。`,
    `入社後の90日計画を先に提示すると期待値が揃い、定着が早い。`
  ];
  const vocation=[
    `適職は「太陽×10H×土星」。役割の明確化と継続運用が成果を積む。`,
    `副業は木星領域で伸びやすい。時間を箱で確保し、週次ルーチン化。`,
    `仕組み（手順書/テンプレ/自動化）づくりは将来の自由度を増す投資。`
  ];
  const strengths=[`決断と初動が速い`,`学習曲線が急`,`対人の調整力が高い`];
  const weaknesses=[`抱え込みやすい`,`完璧主義に偏りがち`,`中間共有が遅れると周囲が動きづらい`];

  return [
    `【総評】${name||"ご本人"}は「${elMain}×${mdMain}」基調。日々の選択をこの組合せで最適化するとブレが減ります。`,
    `— 恋愛 —\n${list(love)}`,
    `— 仕事 —\n${list(work)}`,
    `— 未来計画 —\n${list(future)}`,
    `— 相性 —\n${list(syn)}`,
    `— 引っ越し時期 —\n${list(move)}`,
    `— 転職時期 —\n${list(change)}`,
    `— 適職 —\n${list(vocation)}`,
    `— 長所 —\n${list(strengths)}`,
    `— 短所 —\n${list(weaknesses)}`
  ].join("\n\n");
}

/* ===== 実行フロー ===== */
function metaFromInputs(){
  const {y,m,d}=parseCompactDate(document.getElementById("dateCompact").value);
  const {hh,mi}=parseCompactTime(document.getElementById("timeCompact").value);
  const lat=+document.getElementById("lat").value, lon=+document.getElementById("lon").value;
  const tz=+document.getElementById("tz").value, dst=+document.getElementById("dst").value;
  if(isNaN(lat)||isNaN(lon)) throw "緯度経度を入力（または地名検索）してください";
  const jd=jdFromYMD(y,m,d,hh,mi,tz,dst);
  return {y,m,d,hh,mi,lat,lon,tz,dst,jd};
}

document.getElementById("calcAsc").onclick=()=>{
  try{
    const M=metaFromInputs(); const am=ascMcFrom(M.jd,M.lat,M.lon);
    alert(`ASC ${am.ASC.toFixed(2)}° / MC ${am.MC.toFixed(2)}°`);
  }catch(e){ alert(e); }
};

document.getElementById("geo").title="Nominatim→Open-Meteoの順で検索します";

document.getElementById("run").onclick=()=>{
  try{
    const M=metaFromInputs();
    const A=ascMcFrom(M.jd,M.lat,M.lon);

    // 惑星位置
    const pos={ASC:A.ASC,MC:A.MC,IC:A.IC,DES:A.DES};
    Object.assign(pos,{
      Sun:LON.Sun(M.jd), Moon:LON.Moon(M.jd), Mercury:LON.Mercury(M.jd),Venus:LON.Venus(M.jd),
      Mars:LON.Mars(M.jd),Jupiter:LON.Jupiter(M.jd),Saturn:LON.Saturn(M.jd),Uranus:LON.Uranus(M.jd),
      Neptune:LON.Neptune(M.jd),Pluto:LON.Pluto(M.jd)
    });

    // ハウス
    const mode=document.getElementById("house").value;
    let cusps;
    if(mode==="placidus"){
      const c=placidusCusps(A);
      cusps=c.slice();
      cusps.asc=A.ASC; cusps.mc=A.MC; cusps.des=A.DES; cusps.ic=A.IC;
    }else if(mode==="equal"){
      cusps=Houses.equal(A.ASC); cusps.asc=A.ASC; cusps.mc=A.MC; cusps.des=A.DES; cusps.ic=A.IC;
    }else{
      cusps=Houses.whole(A.ASC); cusps.asc=A.ASC; cusps.mc=A.MC; cusps.des=A.DES; cusps.ic=A.IC;
    }

    // 描画
    const orb=+document.getElementById("orb").value||6;
    drawChart(document.getElementById("cv"), pos, cusps, {orb});
    // 表
    const aspects=findAspects(pos,orb);
    buildTables(pos,cusps,aspects);
    // サマリ
    const nm=document.getElementById("name").value||"—";
    document.getElementById("sum_name").textContent=nm;
    document.getElementById("sum_place").textContent=document.getElementById("place").value||`${M.lat.toFixed(3)}, ${M.lon.toFixed(3)}`;
    document.getElementById("sum_date").textContent=`${M.y}-${String(M.m).padStart(2,"0")}-${String(M.d).padStart(2,"0")}  ${String(M.hh).padStart(2,"0")}:${String(M.mi).padStart(2,"0")}`;
    // AI
    document.getElementById("report").value = aiReport(pos, cusps, nm);
  }catch(e){ alert(e); }
};

/* 初期表示を少し丁寧に */
document.getElementById("timeCompact").placeholder = "例：1200（=12:00）";
document.getElementById("timeCompact").value = "";
</script>
</body>
</html>
